<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Mony Store - Shoes &amp; Bags Inventory (Modified)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 1rem;
        }
        .product-card {
            transition: transform 0.22s ease, box-shadow 0.22s ease;
        }
        .product-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 30px rgba(13,38,76,0.08);
        }
        /* Hide scrollbar for size options */
        #size-color-options::-webkit-scrollbar { display: none; }
        #size-color-options { -ms-overflow-style: none; scrollbar-width: none; }
        /* modern small tweaks */
        .glass { background: linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.6)); backdrop-filter: blur(6px); }

        /* Custom CSS for responsive navbar */
        @media (max-width: 639px) { /* Tailwind's sm breakpoint is 640px */
            #navbar-items {
                display: none; /* Hidden by default on small screens */
                flex-direction: column;
                width: 100%;
                background-color: white; /* Or match header background */
                border-top: 1px solid #e5e7eb; /* gray-200 */
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }
            #navbar-items.active {
                display: flex; /* Show when active */
            }
            #navbar-items button {
                width: 100%;
                text-align: left;
                padding-left: 1rem;
                padding-right: 1rem;
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }
            #navbar-toggler {
                display: block; /* Show toggler on small screens */
            }

            /* Filter area specific styles for small screens */
            #filter-controls {
                display: none; /* Hidden by default on small screens */
                flex-direction: column;
                gap: 1rem; /* Maintain gap between filter items */
                padding-top: 1rem;
            }
            #filter-controls.active {
                display: flex; /* Show when active */
            }
            #filter-toggler {
                display: block; /* Show toggler on small screens */
            }
            #inventory-filters { /* Adjust padding/margin for the main filter container */
                padding-bottom: 0; /* Remove bottom padding when toggler is present */
            }
        }
        @media (min-width: 640px) { /* Tailwind's sm breakpoint */
            #navbar-items {
                display: flex !important; /* Always show on larger screens */
                flex-direction: row;
            }
            #navbar-toggler {
                display: none; /* Hide toggler on larger screens */
            }

            /* Filter area specific styles for large screens */
            #filter-controls {
                display: flex !important; /* Always show on larger screens */
                flex-direction: row;
                flex-wrap: wrap;
                gap: 1rem;
            }
            #filter-toggler {
                display: none; /* Hide toggler on larger screens */
            }
        }
        /* Custom CSS for sales history item images */
        .sales-history-item-image {
            width: 80px; /* Increased width for larger image */
            height: 80px; /* Increased height for larger image */
            object-fit: cover;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
<div class="min-h-screen" id="app">
<!-- Login View -->
<div class="flex items-center justify-center h-screen bg-gradient-to-br from-indigo-50 to-pink-50 px-4" id="login-view">
<div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md glass">
<div class="text-center mb-6">
<h1 class="text-3xl font-extrabold text-gray-900 mb-1">Mony Store</h1>
<p class="text-gray-600">Inventory &amp; Sales Dashboard</p>
</div>
<form class="space-y-6" id="login-form">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="username">Username</label>
<input class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-indigo-400 focus:border-transparent transition" id="username" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="password">Password</label>
<input class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-indigo-400 focus:border-transparent transition" id="password" required="" type="password"/>
</div>
<button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-xl transition transform hover:scale-[1.01]" type="submit">
                        Login
                    </button>
<div class="text-center mt-4">
<button class="text-indigo-600 hover:text-indigo-800 text-sm font-medium" id="register-btn" type="button">Create Admin Account</button>
</div>
<div class="mt-3 text-sm text-gray-500">
                        Tip: use <span class="font-medium">admin/admin123</span> or <span class="font-medium">limited/limited123</span>
</div>
</form>
</div>
</div>
<!-- Register Admin Modal (for initial admin creation) -->
<div class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 z-50" id="register-modal">
<div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
<div class="text-center mb-4">
<h2 class="text-2xl font-bold text-gray-800">Create Admin Account</h2>
</div>
<form class="space-y-4" id="register-form">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="new-username">Username</label>
<input class="w-full px-4 py-2 rounded-lg border border-gray-300" id="new-username" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="new-password">Password</label>
<input class="w-full px-4 py-2 rounded-lg border border-gray-300" id="new-password" required="" type="password"/>
</div>
<div class="flex justify-between pt-4">
<button class="px-4 py-2 text-gray-600 hover:text-gray-800" id="cancel-register" type="button">Cancel</button>
<button class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700" type="submit">Register</button>
</div>
</form>
</div>
</div>
<!-- Create Admin Account Modal (for logged-in admin) -->
<div class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 z-50" id="create-admin-modal">
<div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
<div class="text-center mb-4">
<h2 class="text-2xl font-bold text-gray-800">Create New Admin Account</h2>
</div>
<form class="space-y-4" id="create-admin-form">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="admin-username">Username</label>
<input class="w-full px-4 py-2 rounded-lg border border-gray-300" id="admin-username" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="admin-password">Password</label>
<input class="w-full px-4 py-2 rounded-lg border border-gray-300" id="admin-password" required="" type="password"/>
</div>
<div class="flex justify-between pt-4">
<button class="px-4 py-2 text-gray-600 hover:text-gray-800" id="cancel-admin-creation" type="button">Cancel</button>
<button class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700" type="submit">Create Account</button>
</div>
</form>
</div>
</div>
<!-- Create Limited Account Modal -->
<div class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 z-50" id="create-limited-modal">
<div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
<div class="text-center mb-4">
<h2 class="text-2xl font-bold text-gray-800">Create Limited Account</h2>
</div>
<form class="space-y-4" id="create-limited-form">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="limited-username">Username</label>
<input class="w-full px-4 py-2 rounded-lg border border-gray-300" id="limited-username" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="limited-password">Password</label>
<input class="w-full px-4 py-2 rounded-lg border border-gray-300" id="limited-password" required="" type="password"/>
</div>
<div class="flex justify-between pt-4">
<button class="px-4 py-2 text-gray-600 hover:text-gray-800" id="cancel-limited-creation" type="button">Cancel</button>
<button class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700" type="submit">Create Account</button>
</div>
</form>
</div>
</div>
<!-- Inventory View -->
<div class="hidden" id="inventory-view">
<header class="bg-white shadow-sm sticky top-0 z-50">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-col sm:flex-row justify-between items-center gap-3">
<div class="flex items-center justify-between w-full sm:w-auto">
<div class="flex items-center gap-3">
<img alt="logo" class="h-10 w-auto mr-2" src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/367b9096-ee32-4690-826d-30982b44976d.png"/>
<div>
<h1 class="text-lg font-bold text-gray-900">Mony Store Inventory</h1>
<p class="text-xs text-gray-500">Shoes &amp; Bags • Manage stock &amp; sales</p>
</div>
</div>
<!-- Toggler button for small screens -->
<button class="sm:hidden text-gray-600 hover:text-gray-900 p-2 rounded-md" id="navbar-toggler" type="button">
<svg class="h-6 w-6" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M4 6h16M4 12h16M4 18h16" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
</div>
<div class="flex flex-col sm:flex-row sm:items-center sm:space-x-3 w-full sm:w-auto" id="navbar-items">
<button class="text-gray-600 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium" id="sales-history-btn">Sales History</button>
<button class="relative text-gray-600 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium" id="view-cart-btn">
                            Cart (<span id="cart-count">0</span>)
                        </button>
<button class="text-gray-600 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium" id="create-limited-account-btn">Create Limited Account</button>
<button class="text-gray-600 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium" id="create-admin-account-btn">Create Admin Account</button>
<button class="text-gray-600 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium" id="logout-btn">Logout</button>
</div>
</div>
</header>
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
<div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
<h2 class="text-2xl font-bold text-gray-800">Inventory Dashboard</h2>
<div class="flex space-x-3" id="admin-actions">
<button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium" id="add-shoe-btn">Add Shoe</button>
<button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium" id="add-bag-btn">Add Bag</button>
<button class="bg-red-100 text-red-700 px-3 py-2 rounded-md text-sm" id="clear-storage-btn">Reset Data</button>
</div>
</div>
<!-- Filters -->
<div class="mb-6 bg-white p-4 rounded-lg shadow-sm flex flex-col" id="inventory-filters">
<div class="flex justify-between items-center mb-4 sm:mb-0">
<h3 class="text-lg font-semibold text-gray-800">Filters</h3>
<button class="sm:hidden text-gray-600 hover:text-gray-900 p-2 rounded-md" id="filter-toggler" type="button">
<svg class="h-6 w-6" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M19 9l-7 7-7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
</div>
<div class="flex flex-wrap gap-4" id="filter-controls">
<div>
<label class="block text-sm font-medium text-gray-700">Type</label>
<select class="border border-gray-300 rounded-md px-3 py-2" id="filter-type">
<option value="">All</option>
<option value="shoes">Shoes</option>
<option value="bags">Bags</option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700">Brand</label>
<select class="border border-gray-300 rounded-md px-3 py-2" id="filter-brand">
<option value="">All</option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700">Color</label>
<select class="border border-gray-300 rounded-md px-3 py-2" id="filter-color">
<option value="">All</option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700">Min Price</label>
<input class="border border-gray-300 rounded-md px-3 py-2" id="filter-min-price" step="0.01" type="number"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700">Max Price</label>
<input class="border border-gray-300 rounded-md px-3 py-2" id="filter-max-price" step="0.01" type="number"/>
</div>
<!-- New: Item Code Filter -->
<div>
    <label class="block text-sm font-medium text-gray-700">Item Code</label>
    <input class="border border-gray-300 rounded-md px-3 py-2" id="filter-code" type="text" placeholder="e.g., S001"/>
</div>

<div class="flex items-end">
    <button id="reset-filters-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-md text-sm font-medium">Reset Filters</button>
</div>

</div>
</div>
<div class="mb-8">
<h3 class="text-lg font-semibold text-gray-800 mb-4" id="inventory-type-title">All Products</h3>
<div class="inventory-grid" id="inventory-list">
<!-- Products will be dynamically inserted here -->
</div>
</div>
</main>
</div>
<!-- Sales History View -->
<div class="hidden max-w-7xl mx-auto px-4 py-8" id="sales-history-view">
<div class="mb-4 font-semibold text-gray-800" id="salesSummary"></div>
<header class="bg-white shadow-sm mb-6 sticky top-0 z-40">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
<h1 class="text-xl font-bold text-gray-900">Sales History</h1>
<button class="text-indigo-600 hover:text-indigo-800 px-3 py-2 rounded-md text-sm font-medium" id="back-to-inventory-from-history">← Back</button>
</div>
</header>
<div class="mb-4 flex items-center gap-4">
<label class="text-sm font-medium text-gray-700" for="filter-sales-date">Filter by Date:</label>
<input class="border border-gray-300 rounded-md px-3 py-2" id="filter-sales-date" type="date"/>
<button class="px-3 py-2 bg-gray-200 rounded-md text-sm" id="clear-sales-date">Clear</button>
</div>
<div class="overflow-x-auto bg-white rounded-lg shadow-sm">
<table class="min-w-full text-sm text-gray-700" id="sales-history-table">
<thead class="bg-gray-100">
<tr>
<th class="px-4 py-2 text-left">Date &amp; Time</th>
<th class="px-4 py-2 text-left">Items</th>
<th class="px-4 py-2 text-left">Payment Method</th>
<th class="px-4 py-2 text-right">Total ($)</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="mt-4 font-semibold text-gray-800" id="daily-total"></div>
<div class="mt-2 font-semibold text-gray-800" id="monthly-total"></div>
</div>
<!-- Cart View -->
<div class="hidden max-w-7xl mx-auto px-4 py-8" id="cart-view">
<header class="bg-white shadow-sm mb-6 sticky top-0 z-40">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
<h1 class="text-xl font-bold text-gray-900">Your Shopping Cart</h1>
<button class="text-indigo-600 hover:text-indigo-800 px-3 py-2 rounded-md text-sm font-medium" id="back-to-inventory-btn">← Back to Inventory</button>
</div>
</header>
<main>
<div class="space-y-4 mb-6" id="cart-items-list"></div>
<div class="bg-white rounded-lg shadow-sm p-4 flex flex-col sm:flex-row justify-between items-center gap-4">
<div class="w-full sm:w-auto text-sm">
<label class="block text-gray-600">Discount (%)</label>
<input class="border border-gray-300 rounded-md px-3 py-2 w-32" id="checkout-discount" max="100" min="0" step="0.01" type="number" value="0"/>
</div>

<div class="w-full sm:w-auto text-sm">
    <label class="block text-gray-600">Payment Method</label>
    <select id="payment-method" class="border border-gray-300 rounded-md px-3 py-2 w-48">
        <option value="cash">Cash</option>
        <option value="visa">Visa</option>
        <option value="instapay">Instapay</option>
        <option value="vodafone-cash">Vodafone Cash</option>
    </select>
</div>

<p class="text-xl font-bold">Total: $<span id="cart-total">0.00</span></p>
<button class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-md text-lg font-medium" id="checkout-btn">Proceed to Checkout</button>
</div>
</main>
</div>
<!-- Add Shoe Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden" id="add-shoe-modal">
<div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
<div class="p-6">
<div class="flex justify-between items-center mb-4">
<h3 class="text-xl font-bold text-gray-800">Add / Edit Shoe</h3>
<button class="text-gray-500 hover:text-gray-700" id="close-shoe-modal">
<svg class="h-6 w-6" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
</button>
</div>
<form class="space-y-4" id="add-shoe-form">
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="shoe-brand">Brand</label>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="shoe-brand" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="shoe-model">Model</label>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="shoe-model" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="shoe-color">Color</label>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="shoe-color" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="shoe-original-price">Original Price ($)</label>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="shoe-original-price" min="0" required="" step="0.01" type="number"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="shoe-min-price">Min Sales Price ($)</label>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="shoe-min-price" min="0" step="0.01" type="number"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="shoe-price">Sales Price ($)</label>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="shoe-price" min="0" required="" step="0.01" type="number"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="shoe-code">Item Code</label>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="shoe-code" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="shoe-quantity">Quantity (per size)</label>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="shoe-quantity" min="0" required="" type="number"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="shoe-sizes">Available Sizes (comma-separated)</label>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="shoe-sizes" placeholder="e.g., 38,39,40" required="" type="text"/>
</div>
<div class="md:col-span-2">
<label class="block text-sm font-medium text-gray-700 mt-3 mb-1">Image (file or url) — <span class="text-xs text-gray-500" id="shoe-image-note">editable when adding only</span></label>
<input accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-md" id="shoe-image-file" type="file"/>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md mt-2" id="shoe-image-url" placeholder="https://example.com/image.jpg" type="text"/>
<div class="mt-4">
<img alt="Image Preview" class="hidden w-40 h-32 object-cover rounded-md mx-auto border" id="shoe-image-preview" src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/e8513746-6820-4bba-9260-b0f38c8939ad.png">
</div>
</div>
</div>
<div class="flex justify-end space-x-3 pt-4">
<button class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50" id="cancel-shoe" type="button">Cancel</button>
<button class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700" type="submit">Save</button>
</div>
</form>
</div>
</div>
</div>
<!-- Add Bag Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden" id="add-bag-modal">
<div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
<div class="p-6">
<div class="flex justify-between items-center mb-4">
<h3 class="text-xl font-bold text-gray-800">Add / Edit Bag</h3>
<button class="text-gray-500 hover:text-gray-700" id="close-bag-modal">
<svg class="h-6 w-6" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
</button>
</div>
<form class="space-y-4" id="add-bag-form">
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="bag-brand">Brand</label>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="bag-brand" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="bag-model">Model</label>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="bag-model" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="bag-color">Color</label>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="bag-color" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="bag-original-price">Original Price ($)</label>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="bag-original-price" min="0" required="" step="0.01" type="number"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="bag-min-price">Min Sales Price ($)</label>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="bag-min-price" min="0" step="0.01" type="number"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="bag-price">Sales Price ($)</label>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="bag-price" min="0" required="" step="0.01" type="number"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="bag-quantity">Quantity</label>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="bag-quantity" min="0" required="" type="number"/>
</div>
<!-- New: Item Code for Bag -->
<div>
    <label class="block text-sm font-medium text-gray-700 mb-1" for="bag-code">Item Code</label>
    <input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="bag-code" required="" type="text"/>
</div>
<div class="md:col-span-2">
<label class="block text-sm font-medium text-gray-700 mt-3 mb-1">Image (file or url) — <span class="text-xs text-gray-500" id="bag-image-note">editable when adding only</span></label>
<input accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-md" id="bag-image-file" type="file"/>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md mt-2" id="bag-image-url" placeholder="https://example.com/image.jpg" type="text"/>
<div class="mt-4">
<img alt="Image Preview" class="hidden w-40 h-32 object-cover rounded-md mx-auto border" id="bag-image-preview" src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/8985c871-cd01-42e0-af4e-7dd15f59e8ad.png">
</div>
</div>
</div>
<div class="flex justify-end space-x-3 pt-4">
<button class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50" id="cancel-bag" type="button">Cancel</button>
<button class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700" type="submit">Save</button>
</div>
</form>
</div>
</div>
</div>
<!-- Add to Cart Modal (for size/color selection) -->
<div class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" id="add-to-cart-modal">
<div class="bg-white rounded-lg shadow-xl w-full max-w-md">
<div class="p-6">
<div class="flex justify-between items-center mb-4">
<h3 class="text-xl font-bold text-gray-800" id="add-to-cart-modal-title">Add to Cart</h3>
<button class="text-gray-500 hover:text-gray-700" id="close-add-to-cart-modal" type="button">
<svg class="h-6 w-6" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
</button>
</div>
<form class="space-y-4" id="add-to-cart-form">
<div class="max-h-60 overflow-y-auto pr-2" id="size-color-options"></div>
<p class="text-sm text-gray-600" id="selected-item-stock">Stock: --</p>
<!-- Price Options -->
<div id="price-options-container" class="hidden">
    <label class="block text-sm font-medium text-gray-700 mb-1">Select Sold Price:</label>
    <div id="price-options" class="flex flex-col space-y-2">
        <!-- Price radio buttons will be inserted here -->
    </div>
</div>
<div class="flex justify-end space-x-3 pt-4">
<button class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50" id="cancel-add-to-cart" type="button">Cancel</button>
<button class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700" type="submit">Add to Cart</button>
</div>
</form>
</div>
</div>
</div>
</div>
<script>
/* ---------------------------
   Storage + Init
   --------------------------- */
function getInventoryData() {
    const raw = localStorage.getItem('inventoryData');
    return raw ? JSON.parse(raw) : null;
}
function saveInventoryData(data) {
    localStorage.setItem('inventoryData', JSON.stringify(data));
}

// track current logged in user's role
let currentUser = null; // { username, role }

/* Initialize sample data if not present */
(function ensureInitialData(){
    if (!localStorage.getItem('inventoryData')) {
        const sampleData = {
            shoes: [
                {
                    id: 1,
                    brand: "Nike",
                    model: "Air Max",
                    color: "White/Black",
                    originalPrice: 150.00,
                    price: 129.99,
                    minPrice: 120.00, // Added minPrice for testing
                    stock: { "White/Black_38": 5, "White/Black_39": 5, "White/Black_40": 5, "White/Black_41": 5, "White/Black_42": 5 },
                    availableSizes: [38,39,40,41,42],
                    availableColors: ["White/Black"],
                    image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d9c-98f6-345daea10e18.png",
                    type: "shoes",
                    code: "S001"
                },
                {
                    id: 2,
                    brand: "Adidas",
                    model: "Superstar",
                    color: "Black",
                    originalPrice: 100.00,
                    price: 89.99,
                    minPrice: 80.00, // Added minPrice for testing
                    stock: { "Black_36": 7, "Black_37": 7, "Black_38": 7, "Black_39": 7, "Black_40": 7 },
                    availableSizes: [36,37,38,39,40],
                    availableColors: ["Black"],
                    image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d9c-98f6-345daea10e18.png",
                    type: "shoes",
                    code: "S002"
                }
            ],
            bags: [
                {
                    id: 1,
                    brand: "Gucci",
                    model: "GG Marmont",
                    color: "Beige",
                    originalPrice: 2800.00,
                    price: 2490.00,
                    minPrice: 2400.00, // Added minPrice for testing
                    stock: { "Beige": 5, "Black": 3 },
                    availableColors: ["Beige", "Black"],
                    image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d9c-98f6-345daea10e18.png",
                    type: "bags",
                    code: "B001"
                },
                {
                    id: 2,
                    brand: "Coach",
                    model: "Willow Tote",
                    color: "Black",
                    originalPrice: 400.00,
                    price: 349.99,
                    minPrice: 300.00, // Added minPrice for testing
                    stock: { "Black": 8, "Brown": 4 },
                    availableColors: ["Black", "Brown"],
                    image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d9c-98f6-345daea10e18.png",
                    type: "bags",
                    code: "B002"
                }
            ],
            admins: [
                { username: "admin", password: "admin123", role: "admin" },
                { username: "test", password: "test123", role: "admin" },
                { username: "limited", password: "limited123", role: "viewer" } // limited account
            ],
            cart: []
        };
        saveInventoryData(sampleData);
    }
})();

/* ---------------------------
   DOM refs
   --------------------------- */
const loginView = document.getElementById('login-view');
const inventoryView = document.getElementById('inventory-view');
const cartView = document.getElementById('cart-view');
const loginForm = document.getElementById('login-form');
const logoutBtn = document.getElementById('logout-btn');
const inventoryList = document.getElementById('inventory-list');
const registerBtn = document.getElementById('register-btn'); // This is the button on the login screen
const registerModal = document.getElementById('register-modal'); // This is the modal for initial admin creation
const registerForm = document.getElementById('register-form');
const cancelRegister = document.getElementById('cancel-register');

const addShoeBtn = document.getElementById('add-shoe-btn');
const addBagBtn = document.getElementById('add-bag-btn');
const addShoeModal = document.getElementById('add-shoe-modal');
const addBagModal = document.getElementById('add-bag-modal');
const closeShoeModal = document.getElementById('close-shoe-modal');
const closeBagModal = document.getElementById('close-bag-modal');
const cancelShoe = document.getElementById('cancel-shoe');
const cancelBag = document.getElementById('cancel-bag');
const addShoeForm = document.getElementById('add-shoe-form');
const addBagForm = document.getElementById('add-bag-form');
const viewCartBtn = document.getElementById('view-cart-btn');
const cartCountSpan = document.getElementById('cart-count');
const cartItemsList = document.getElementById('cart-items-list');
const cartTotalSpan = document.getElementById('cart-total');
const checkoutBtn = document.getElementById('checkout-btn');
const backToInventoryBtn = document.getElementById('back-to-inventory-btn');
const clearStorageBtn = document.getElementById('clear-storage-btn');

const addToCartModal = document.getElementById('add-to-cart-modal');
const addToCartModalTitle = document.getElementById('add-to-cart-modal-title');
const closeAddToCartModal = document.getElementById('close-add-to-cart-modal');
const addToCartForm = document.getElementById('add-to-cart-form');
const sizeColorOptions = document.getElementById('size-color-options');
const selectedItemStock = document.getElementById('selected-item-stock');
const cancelAddToCart = document.getElementById('cancel-add-to-cart');
const priceOptionsContainer = document.getElementById('price-options-container'); // New
const priceOptionsDiv = document.getElementById('price-options'); // New

const shoeImageFile = document.getElementById('shoe-image-file');
const shoeImageUrl = document.getElementById('shoe-image-url');
const shoeImagePreview = document.getElementById('shoe-image-preview');

const bagImageFile = document.getElementById('bag-image-file');
const bagImageUrl = document.getElementById('bag-image-url');
const bagImagePreview = document.getElementById('bag-image-preview');

const adminActions = document.getElementById('admin-actions');
const shoeImageNote = document.getElementById('shoe-image-note');
const bagImageNote = document.getElementById('bag-image-note');
const checkoutDiscountInput = document.getElementById('checkout-discount');

// Sales History DOM elements
const salesHistoryBtn = document.getElementById('sales-history-btn');
const salesHistoryView = document.getElementById('sales-history-view');
const backToInventoryFromHistoryBtn = document.getElementById('back-to-inventory-from-history');
const filterSalesDateInput = document.getElementById('filter-sales-date');
const clearSalesDateBtn = document.getElementById('clear-sales-date');
const salesHistoryTableBody = document.querySelector('#sales-history-table tbody');
const salesSummaryDiv = document.getElementById('salesSummary');
const dailyTotalDiv = document.getElementById('daily-total');
const monthlyTotalDiv = document.getElementById('monthly-total');

// New DOM elements for account creation
const createLimitedAccountBtn = document.getElementById('create-limited-account-btn');
const createLimitedModal = document.getElementById('create-limited-modal');
const createLimitedForm = document.getElementById('create-limited-form');
const cancelLimitedCreationBtn = document.getElementById('cancel-limited-creation');

// New DOM elements for creating another admin account
const createAdminAccountBtn = document.getElementById('create-admin-account-btn'); // Button in inventory view
const createAdminModal = document.getElementById('create-admin-modal'); // New modal for admin creation
const createAdminForm = document.getElementById('create-admin-form');
const cancelAdminCreationBtn = document.getElementById('cancel-admin-creation');

// Navbar Toggler DOM elements
const navbarToggler = document.getElementById('navbar-toggler');
const navbarItems = document.getElementById('navbar-items');

// Filter Toggler DOM elements
const filterToggler = document.getElementById('filter-toggler');
const filterControls = document.getElementById('filter-controls');

// New DOM reference for the filter-code input
const filterCodeInput = document.getElementById('filter-code');


/* ---------------------------
   Cart & inventory helpers
   --------------------------- */
let currentItemToAdd = null;
let currentItemType = null;

function updateCartCount() {
    const data = getInventoryData();
    const cart = (data && data.cart) || [];
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    cartCountSpan.textContent = totalItems;
}

function userIsViewer() {
    return currentUser && currentUser.role === 'viewer';
}

// Original renderInventory function
function _renderInventory() {
    const data = getInventoryData();
    if (!data) return;
    inventoryList.innerHTML = '';

    const filters = getFilterValues();
    let allItems = [...(data.shoes || []), ...(data.bags || [])];
    allItems = allItems.filter(item => {
        if (filters.type && item.type !== filters.type) return false;
        if (filters.brand && item.brand && item.brand.toLowerCase() !== filters.brand.toLowerCase()) return false;
        if (filters.color && item.color && item.color.toLowerCase() !== filters.color.toLowerCase()) return false;
        if (filters.minPrice !== null && item.price < filters.minPrice) return false;
        if (filters.maxPrice !== null && item.price > filters.maxPrice) return false;
        // New: Filter by item code
        if (filters.code && item.code && !item.code.toLowerCase().includes(filters.code)) return false;
        return true;
    });

    if (allItems.length === 0) {
        inventoryList.innerHTML = '<p class="col-span-full text-center py-10 text-gray-500">No items match filters.</p>';
        return;
    }

    allItems.forEach(item => {
        const card = document.createElement('div');
        card.className = 'product-card bg-white rounded-xl overflow-hidden shadow-md border border-gray-100 p-4 flex flex-col';

        let totalQuantity = 0;
        for (const key in (item.stock || {})) {
            const v = Number(item.stock[key]) || 0;
            totalQuantity += v;
        }

        // show original price only to admin
        const originalPriceHtml = userIsViewer() ? '' : `<p class="text-xs text-gray-400">Orig: $${Number(item.originalPrice || 0).toFixed(2)}</p>`;

        card.innerHTML = `
            <div class="h-44 overflow-hidden mb-4 rounded-lg">
                <img src="${item.image || 'https://via.placeholder.com/300x200'}" alt="${item.brand} ${item.model}" class="w-full h-full object-cover">
            </div>
            <h3 class="font-bold text-lg text-gray-800">${item.brand} ${item.model}</h3>
            <p class="text-sm text-gray-600">Color: ${item.color || '-'}</p>
            ${item.type === 'shoes' ? `<p class="text-sm text-gray-600">Sizes: ${ (item.availableSizes || []).join(', ') }</p>` : ''}
            <div class="mt-2 mb-2">${originalPriceHtml}<p class="font-semibold text-gray-800">$${Number(item.price || 0).toFixed(2)}</p></div>
            <p class="text-sm text-gray-600 mb-4">Available: ${totalQuantity}</p>
            <div class="flex space-x-2 mt-auto">
                <button class="add-to-cart-btn flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-md text-sm font-medium" data-id="${item.id}" data-type="${item.type}">
                    Add to Cart
                </button>
                <button class="edit-item-btn bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded-md text-sm font-medium" data-id="${item.id}" data-type="${item.type}">
                    Edit
                </button>
                <button class="delete-item-btn bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md text-sm font-medium" data-id="${item.id}" data-type="${item.type}">
                    Delete
                </button>
            </div>
        `;
        inventoryList.appendChild(card);
    });

    // attach listeners
    document.querySelectorAll('.add-to-cart-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
            const id = parseInt(btn.dataset.id);
            const type = btn.dataset.type;
            openAddToCartModal(id, type);
        });
    });
    document.querySelectorAll('.delete-item-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
            if (userIsViewer()) { alert('You do not have permission to delete products.'); return; }
            const id = parseInt(btn.dataset.id);
            const type = btn.dataset.type;
            deleteItem(id, type);
        });
    });
    document.querySelectorAll('.edit-item-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
            if (userIsViewer()) { alert('You do not have permission to edit products.'); return; }
            const id = parseInt(btn.dataset.id);
            const type = btn.dataset.type;
            editItem(id, type);
        });
    });

    updateCartCount();
    updateFilterOptions();
    applyRoleRestrictions(); // Apply restrictions after rendering
}

// Consolidated renderInventory function
function renderInventory() {
    _renderInventory(); // Call the base rendering logic
    document.querySelectorAll('#inventory-list .product-card').forEach((card, idx) => {
        const data = getInventoryData();
        // Find the item corresponding to this card. This approach is fragile if filtering/sorting changes order.
        // A more robust way would be to store item ID in data-attribute on card and retrieve from there.
        // For now, assuming allItems[idx] still corresponds to the card.
        let allItems = [...(data.shoes || []), ...(data.bags || [])];
        // Filter allItems based on current filters to match what's actually rendered
        const filters = getFilterValues();
        let renderedItems = allItems.filter(item => {
            if (filters.type && item.type !== filters.type) return false;
            if (filters.brand && item.brand && item.brand.toLowerCase() !== filters.brand.toLowerCase()) return false;
            if (filters.color && item.color && item.color.toLowerCase() !== filters.color.toLowerCase()) return false;
            if (filters.minPrice !== null && item.price < filters.minPrice) return false;
            if (filters.maxPrice !== null && item.price > filters.maxPrice) return false;
            if (filters.code && item.code && !item.code.toLowerCase().includes(filters.code)) return false;
            return true;
        });

        let item = renderedItems[idx]; // Get the item from the *rendered* list
        if(item && item.minPrice){
            let priceElem = card.querySelector('.font-semibold.text-gray-800');
            if(priceElem){
                // Check if min price already exists to prevent duplicates on re-render
                if (!card.querySelector('.min-price-display')) {
                    priceElem.insertAdjacentHTML('beforebegin', `<p class="text-xs text-gray-500 min-price-display">Min: $${Number(item.minPrice).toFixed(2)}</p>`);
                }
            }
        }
    });
}


function getFilterValues() {
    return {
        type: document.getElementById('filter-type').value,
        brand: document.getElementById('filter-brand').value,
        color: document.getElementById('filter-color').value,
        minPrice: parseFloat(document.getElementById('filter-min-price').value) || null,
        maxPrice: parseFloat(document.getElementById('filter-max-price').value) || null,
        // Add the new filter for item code
        code: document.getElementById('filter-code').value.trim().toLowerCase()
    };
}

function updateFilterOptions() {
    const data = getInventoryData();
    if (!data) return;
    const allItems = [...(data.shoes || []), ...(data.bags || [])];

    const brands = new Set();
    const colors = new Set();

    allItems.forEach(item => {
        if (item.brand) brands.add(item.brand);
        if (item.color) colors.add(item.color);
        if (item.availableColors) item.availableColors.forEach(c => colors.add(c));
    });

    const filterBrandSelect = document.getElementById('filter-brand');
    const filterColorSelect = document.getElementById('filter-color');

    filterBrandSelect.innerHTML = '<option value="">All</option>';
    brands.forEach(brand => {
        filterBrandSelect.innerHTML += `<option value="${brand}">${brand}</option>`;
    });

    filterColorSelect.innerHTML = '<option value="">All</option>';
    colors.forEach(color => {
        filterColorSelect.innerHTML += `<option value="${color}">${color}</option>`;
    });
}

/* ---------------------------
   Delete item
   --------------------------- */
function deleteItem(itemId, itemType) {
    if (!confirm('Are you sure you want to delete this item?')) return;
    const data = getInventoryData();
    if (!data) return;
    if (itemType === 'shoes') {
        data.shoes = (data.shoes || []).filter(s => s.id !== itemId);
    } else {
        data.bags = (data.bags || []).filter(b => b.id !== itemId);
    }
    saveInventoryData(data);
    renderInventory();
}

/* ---------------------------
   Edit item
   --------------------------- */
function editItem(itemId, itemType) {
    const data = getInventoryData();
    if (!data) return;
    let item;
    let form;
    let modal;

    if (itemType === 'shoes') {
        item = (data.shoes || []).find(s => s.id === itemId);
        form = addShoeForm;
        modal = addShoeModal;
        document.getElementById('shoe-image-file').disabled = true;
        document.getElementById('shoe-image-url').disabled = true;
        shoeImageNote.textContent = 'image not editable when editing';
    } else {
        item = (data.bags || []).find(b => b.id === itemId);
        form = addBagForm;
        modal = addBagModal;
        document.getElementById('bag-image-file').disabled = true;
        document.getElementById('bag-image-url').disabled = true;
        bagImageNote.textContent = 'image not editable when editing';
    }

    if (!item) { alert('Item not found for editing.'); return; }

    form.reset();
    form.setAttribute('data-edit-id', itemId);
    document.querySelector(`#${form.id} button[type="submit"]`).textContent = 'Save Changes';

    // Populate form fields
    if (itemType === 'shoes') {
        document.getElementById('shoe-brand').value = item.brand || '';
        document.getElementById('shoe-model').value = item.model || '';
        document.getElementById('shoe-color').value = item.color || '';
        document.getElementById('shoe-original-price').value = item.originalPrice || 0;
        document.getElementById('shoe-min-price').value = item.minPrice || 0; // Populate minPrice
        document.getElementById('shoe-price').value = item.price || 0;
        document.getElementById('shoe-code').value = item.code || '';
        // For quantity, we can't easily set a single value if stock is per size.
        // For simplicity, we might leave it blank or set to 0, or show a sum.
        // For now, let's assume it's for adding new stock to existing sizes.
        document.getElementById('shoe-quantity').value = 0; // User will add new quantity
        document.getElementById('shoe-sizes').value = (item.availableSizes || []).join(',');
        if (item.image) {
            shoeImagePreview.src = item.image;
            shoeImagePreview.classList.remove('hidden');
        } else {
            shoeImagePreview.classList.add('hidden');
        }
    } else { // bags
        document.getElementById('bag-brand').value = item.brand || '';
        document.getElementById('bag-model').value = item.model || '';
        document.getElementById('bag-color').value = item.color || '';
        document.getElementById('bag-original-price').value = item.originalPrice || 0;
        document.getElementById('bag-min-price').value = item.minPrice || 0; // Populate minPrice
        document.getElementById('bag-price').value = item.price || 0;
        document.getElementById('bag-quantity').value = 0; // User will add new quantity
        document.getElementById('bag-code').value = item.code || ''; // Populate bag code
        if (item.image) {
            bagImagePreview.src = item.image;
            bagImagePreview.classList.remove('hidden');
        } else {
            bagImagePreview.classList.add('hidden');
        }
    }

    modal.classList.remove('hidden');
}


/* ---------------------------
   Cart rendering + operations
   --------------------------- */
function renderCart() {
    const data = getInventoryData();
    const cart = (data && data.cart) || [];
    cartItemsList.innerHTML = '';
    let subtotal = 0;
    if (cart.length === 0) {
        cartItemsList.innerHTML = '<p class="text-center text-gray-500">Your cart is empty.</p>';
    } else {
        cart.forEach((item, idx)=>{
            const itemTotal = item.price * item.quantity;
            subtotal += itemTotal;
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-4 p-4 border rounded-lg bg-white shadow-sm';
            div.innerHTML = `
                <img src="${item.image || 'https://via.placeholder.com/100'}" alt="${item.brand}" class="w-20 h-20 object-cover rounded-md">
                <div class="flex-1 min-w-0">
                    <h4 class="font-semibold text-lg truncate">${item.brand} ${item.model}</h4>
                    <p class="text-gray-600 truncate">Color: ${item.color}</p>
                    ${item.size ? `<p class="text-gray-600">Size: ${item.size}</p>` : ''}
                    <p class="text-gray-600">Quantity: ${item.quantity}</p>
                    <p class="font-bold text-gray-800">$${item.price.toFixed(2)}</p>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <button type="button" class="remove-from-cart-btn text-red-600 hover:text-red-800 font-bold" data-index="${idx}" aria-label="Remove item">&times;</button>
                </div>
            `;
            cartItemsList.appendChild(div);
        });
    }
    const discountPerc = parseFloat(checkoutDiscountInput ? (checkoutDiscountInput.value || 0) : 0) || 0;
    const discountedTotal = Math.max(0, subtotal * (1 - discountPerc/100));
    cartTotalSpan.textContent = discountedTotal.toFixed(2);
    updateCartCount();
    document.querySelectorAll('.remove-from-cart-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
            const idx = parseInt(btn.dataset.index);
            removeFromCart(idx);
        });
    });
}

function removeFromCart(index) {
    const data = getInventoryData();
    if (!data) return;
    const cart = data.cart || [];
    const item = cart[index];
    if (!item) return;
    // restore inventory
    if (item.type === 'shoes') {
        const shoe = (data.shoes || []).find(s => s.id === item.id);
        if (shoe) {
            const key = `${item.color}_${item.size}`;
            shoe.stock[key] = (shoe.stock[key] || 0) + item.quantity;
            // No need to re-add to availableSizes if it was already there.
            // If a size was completely out of stock and now has quantity, it will be rendered.
        }
    } else {
        const bag = (data.bags || []).find(b => b.id === item.id);
        if (bag) {
            bag.stock[item.color] = (bag.stock[item.color] || 0) + item.quantity;
            // No need to re-add to availableColors if it was already there.
        }
    }
    cart.splice(index, 1);
    data.cart = cart;
    saveInventoryData(data);
    renderCart();
    renderInventory();
}

/* ---------------------------
   Sales history logic
   --------------------------- */
function getSalesHistory() {
    const raw = localStorage.getItem('salesHistory');
    return raw ? JSON.parse(raw) : [];
}
function saveSalesHistory(hist) {
    localStorage.setItem('salesHistory', JSON.stringify(hist));
}
function addSaleRecord(items, total, discountPerc = 0, paymentMethod = 'N/A') {
    const hist = getSalesHistory();
    hist.push({ datetime: new Date().toISOString(), items, total, discountPerc, paymentMethod });
    saveSalesHistory(hist);
}

// Original renderSalesHistory function
function _renderSalesHistory(filterDate = null) {
    const hist = getSalesHistory();
    if (!salesHistoryTableBody) return;
    salesHistoryTableBody.innerHTML = '';

    let dailyTotal = 0;
    let monthlyTotal = 0;
    const salesByDate = {};
    const now = new Date();
    const currentMonthKey = now.toISOString().slice(0, 7); // YYYY-MM

    const filteredHist = filterDate
        ? hist.filter(rec => rec.datetime.startsWith(filterDate))
        : hist;

    filteredHist.sort((a, b) => new Date(b.datetime) - new Date(a.datetime)); // Sort by date descending

    filteredHist.forEach(rec => {
        const saleDate = new Date(rec.datetime);
        const dateStr = saleDate.toLocaleDateString();
        const timeStr = saleDate.toLocaleTimeString();
        const dateKey = saleDate.toISOString().slice(0, 10); // YYYY-MM-DD

        if (!salesByDate[dateKey]) salesByDate[dateKey] = 0;
        salesByDate[dateKey] += rec.total || 0;

        const itemsHtml = (rec.items || []).map(i => `
            <div class="flex items-center gap-2 py-1">
                <img src="${i.image || 'https://via.placeholder.com/80'}" alt="${i.brand || ''}" class="sales-history-item-image rounded">
                <span>${i.brand} ${i.model} ${i.color ? `(${i.color})` : ''} ${i.size ? `Size ${i.size}` : ''} x${i.quantity}</span>
                <span class="text-gray-500 text-sm ml-auto">$${(i.price * i.quantity).toFixed(2)}</span>
            </div>
        `).join('');

        const tr = document.createElement('tr');
        tr.className = 'border-b border-gray-200 last:border-b-0';
        tr.innerHTML = `<td class="px-4 py-2">${dateStr} ${timeStr}</td>
                        <td class="px-4 py-2">${itemsHtml}<br><span class="text-xs text-gray-500">Discount: ${rec.discountPerc || 0}%</span></td>
                        <td class="px-4 py-2 text-left">${rec.paymentMethod || 'N/A'}</td>
                        <td class="px-4 py-2 text-right">$${(rec.total || 0).toFixed(2)}</td>`;
        salesHistoryTableBody.appendChild(tr);
        dailyTotal += rec.total;
    });

    // Update sales-by-date summary
    if (salesSummaryDiv) {
        salesSummaryDiv.innerHTML = '<h3 class="text-lg font-semibold mb-2">Sales by Date</h3>';
        Object.keys(salesByDate).sort().forEach(date => {
            salesSummaryDiv.innerHTML += `<div class="text-sm text-gray-700">${date}: $${salesByDate[date].toFixed(2)}</div>`;
        });
    }

    // Calculate monthly total for the current month
    monthlyTotal = hist.filter(r => r.datetime.startsWith(currentMonthKey)).reduce((sum, r) => sum + (r.total || 0), 0);

    if (dailyTotalDiv) {
        dailyTotalDiv.textContent = filterDate ? `Total for ${filterDate}: $${dailyTotal.toFixed(2)}` : '';
    }
    if (monthlyTotalDiv) {
        monthlyTotalDiv.textContent = `Total for current month: $${monthlyTotal.toFixed(2)}`;
    }
}

// Consolidated renderSalesHistory function
function renderSalesHistory(filterDate = null){
    const adjustedDate = filterDate; // This variable was redundant, but kept for consistency with original intent
    _renderSalesHistory(adjustedDate);
};


/* ---------------------------
   Add shoe / bag modal logic
   --------------------------- */
addShoeBtn.addEventListener('click', ()=> {
    if (userIsViewer()) { alert('You do not have permission to add products.'); return; }
    addShoeForm.reset();
    addShoeForm.removeAttribute('data-edit-id');
    document.querySelector('#add-shoe-form button[type="submit"]').textContent = 'Add Shoe';
    shoeImagePreview.classList.add('hidden');
    shoeImagePreview.src = '';
    shoeImageFile.value = '';
    shoeImageUrl.value = '';
    shoeImageFile.disabled = false;
    shoeImageUrl.disabled = false;
    shoeImageNote.textContent = 'editable when adding only';
    addShoeModal.classList.remove('hidden');
});
closeShoeModal.addEventListener('click', ()=> addShoeModal.classList.add('hidden'));
cancelShoe.addEventListener('click', ()=> addShoeModal.classList.add('hidden'));

addBagBtn.addEventListener('click', ()=> {
    if (userIsViewer()) { alert('You do not have permission to add products.'); return; }
    addBagForm.reset();
    addBagForm.removeAttribute('data-edit-id');
    document.querySelector('#add-bag-form button[type="submit"]').textContent = 'Add Bag';
    bagImagePreview.classList.add('hidden');
    bagImagePreview.src = '';
    bagImageFile.value = '';
    bagImageUrl.value = '';
    bagImageFile.disabled = false;
    bagImageUrl.disabled = false;
    bagImageNote.textContent = 'editable when adding only';
    addBagModal.classList.remove('hidden');
});
closeBagModal.addEventListener('click', ()=> addBagModal.classList.add('hidden'));
cancelBag.addEventListener('click', ()=> addBagModal.classList.add('hidden'));

/* helper to generate unique id */
function generateNewId(data) {
    const allIds = [
        ...(data.shoes || []).map(i => Number(i.id) || 0),
        ...(data.bags || []).map(i => Number(i.id) || 0)
    ].filter(n => !isNaN(n));
    return allIds.length ? Math.max(...allIds) + 1 : 1;
}

/* Add shoe form submit */
addShoeForm.addEventListener('submit', function(e){
    e.preventDefault();
    const data = getInventoryData();
    if (!data) return;
    const isEditing = this.hasAttribute('data-edit-id');
    const editId = isEditing ? Number(this.getAttribute('data-edit-id')) : null;

    const shoeBrand = document.getElementById('shoe-brand').value.trim();
    const shoeModel = document.getElementById('shoe-model').value.trim();
    const shoeColor = document.getElementById('shoe-color').value.trim();
    const originalPrice = parseFloat(document.getElementById('shoe-original-price').value);
    const minPrice = parseFloat(document.getElementById('shoe-min-price').value); // Get minPrice
    const price = parseFloat(document.getElementById('shoe-price').value);
    const code = document.getElementById('shoe-code').value.trim();
    const qtyPerSize = parseInt(document.getElementById('shoe-quantity').value, 10);
    const sizesInput = document.getElementById('shoe-sizes').value.trim();
    // Allow duplicate sizes: parse raw sizes and count occurrences multiplied by qtyPerSize
    const sizesRaw = sizesInput.length ? sizesInput.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n)) : [];
    const sizeCounts = {};
    sizesRaw.forEach(sz => {
        sizeCounts[sz] = (sizeCounts[sz] || 0) + (Number(qtyPerSize) || 0);
    });
    // Unique sizes array (sorted) used for availableSizes
    const sizesArray = Object.keys(sizeCounts).map(n => parseInt(n)).sort((a,b)=>a-b);

    // Image handling - ONLY accept file/url when adding (not when editing)

    const file = shoeImageFile.files[0];
    const urlVal = shoeImageUrl.value.trim();

    const createOrUpdate = (imgSrc) => {
        let stockObj = {};
        let existingShoe = null;

        if (isEditing && editId != null) {
            existingShoe = (data.shoes || []).find(s => s.id === editId);
            if (existingShoe) {
                stockObj = { ...existingShoe.stock }; // Copy existing stock
                // Update stock for existing sizes or add new ones
                sizesArray.forEach(sz => {
                    const key = `${shoeColor}_${sz}`;
                    stockObj[key] = (stockObj[key] || 0) + (sizeCounts[sz] || 0); // Add new quantity to existing
                });
            }
        } else {
            sizesArray.forEach(sz => {
                const key = `${shoeColor}_${sz}`;
                stockObj[key] = (stockObj[key] || 0) + (sizeCounts[sz] || 0);
            });
        }

        const formData = {
            brand: shoeBrand,
            model: shoeModel,
            color: shoeColor,
            originalPrice: isNaN(originalPrice) ? 0 : originalPrice,
            minPrice: isNaN(minPrice) ? 0 : minPrice, // Save minPrice
            price: isNaN(price) ? 0 : price,
            code: code,
            stock: stockObj,
            availableSizes: sizesArray,
            availableColors: [shoeColor],
            // Preserve existing image if editing and no new image is provided
            image: imgSrc || (existingShoe ? existingShoe.image : 'https://via.placeholder.com/300x200?text=No+Image'),
            type: 'shoes'
        };

        if (isEditing && editId != null) {
            const idx = (data.shoes || []).findIndex(s=>s.id === editId);
            if (idx > -1) {
                formData.id = editId;
                data.shoes[idx] = formData;
            }
        } else {
            formData.id = generateNewId(data);
            data.shoes = data.shoes || [];
            data.shoes.push(formData);
        }

        saveInventoryData(data);
        addShoeModal.classList.add('hidden');
        renderInventory();
    };

    if (!isEditing && file) { // Only process new file if not editing
        const reader = new FileReader();
        reader.onload = function(ev) {
            createOrUpdate(ev.target.result);
        };
        reader.readAsDataURL(file);
    } else if (!isEditing && urlVal) { // Only process new URL if not editing
        createOrUpdate(urlVal);
    } else {
        // If editing, or no new image provided, pass empty string for imgSrc
        // The createOrUpdate function will then use existingShoe.image
        createOrUpdate('');
    }
});

/* Add bag form submit */
addBagForm.addEventListener('submit', function(e){
    e.preventDefault();
    const data = getInventoryData();
    if (!data) return;
    const isEditing = this.hasAttribute('data-edit-id');
    const editId = isEditing ? Number(this.getAttribute('data-edit-id')) : null;

    const brand = document.getElementById('bag-brand').value.trim();
    const model = document.getElementById('bag-model').value.trim();
    const color = document.getElementById('bag-color').value.trim();
    const originalPrice = parseFloat(document.getElementById('bag-original-price').value);
    const minPrice = parseFloat(document.getElementById('bag-min-price').value); // Get minPrice
    const price = parseFloat(document.getElementById('bag-price').value);
    const qty = parseInt(document.getElementById('bag-quantity').value, 10);
    const code = document.getElementById('bag-code').value.trim(); // Get bag code

    const file = bagImageFile.files[0];
    const urlVal = bagImageUrl.value.trim();

    const createOrUpdate = (imgSrc) => {
        let stockObj = {};
        let existingBag = null;

        if (isEditing && editId != null) {
            existingBag = (data.bags || []).find(b => b.id === editId);
            if (existingBag) {
                stockObj = { ...existingBag.stock }; // Copy existing stock
            }
        }
        // This line was moved outside the if(existingBag) block
        stockObj[color] = (stockObj[color] || 0) + qty; // Add new quantity to existing or new color

        const formData = {
            brand,
            model,
            color,
            originalPrice: isNaN(originalPrice) ? 0 : originalPrice,
            minPrice: isNaN(minPrice) ? 0 : minPrice, // Save minPrice
            price: isNaN(price) ? 0 : price,
            stock: stockObj,
            availableColors: [color],
            // Preserve existing image if editing and no new image is provided
            image: imgSrc || (existingBag ? existingBag.image : 'https://via.placeholder.com/300x200?text=No+Image'),
            type: 'bags',
            code: code // Include bag code
        };
        if (isEditing && editId != null) {
            const idx = (data.bags || []).findIndex(b => b.id === editId);
            if (idx > -1) {
                formData.id = editId;
                data.bags[idx] = formData;
            }
        } else {
            formData.id = generateNewId(data);
            data.bags = data.bags || [];
            data.bags.push(formData);
        }
        saveInventoryData(data);
        addBagModal.classList.add('hidden');
        renderInventory();
    };

    if (!isEditing && file) { // Only process new file if not editing
        const reader = new FileReader();
        reader.onload = function(ev) {
            createOrUpdate(ev.target.result);
        };
        reader.readAsDataURL(file);
    } else if (!isEditing && urlVal) { // Only process new URL if not editing
        createOrUpdate(urlVal);
    } else {
        // If editing, or no new image provided, pass empty string for imgSrc
        // The createOrUpdate function will then use existingBag.image
        createOrUpdate('');
    }
});

/* ---------------------------
   Image preview helpers
   --------------------------- */
shoeImageFile.addEventListener('change', function(){
    if (this.files && this.files[0]) {
        const r = new FileReader();
        r.onload = (e)=> {
            shoeImagePreview.src = e.target.result;
            shoeImagePreview.classList.remove('hidden');
            shoeImageUrl.value = '';
        };
        r.readAsDataURL(this.files[0]);
    } else {
        shoeImagePreview.classList.add('hidden'); shoeImagePreview.src = '';
    }
});
shoeImageUrl.addEventListener('input', function(){
    if (this.value) { shoeImagePreview.src = this.value; shoeImagePreview.classList.remove('hidden'); shoeImageFile.value = ''; }
    else { shoeImagePreview.classList.add('hidden'); shoeImagePreview.src = ''; }
});
bagImageFile.addEventListener('change', function(){
    if (this.files && this.files[0]) {
        const r = new FileReader();
        r.onload = (e)=> { bagImagePreview.src = e.target.result; bagImagePreview.classList.remove('hidden'); bagImageUrl.value = ''; };
        r.readAsDataURL(this.files[0]);
    } else { bagImagePreview.classList.add('hidden'); bagImagePreview.src = ''; }
});
bagImageUrl.addEventListener('input', function(){
    if (this.value) { bagImagePreview.src = this.value; bagImagePreview.classList.remove('hidden'); bagImageFile.value = ''; }
    else { bagImagePreview.classList.add('hidden'); bagImagePreview.src = ''; }
});

/* ---------------------------
   Add to Cart modal logic
   --------------------------- */
function openAddToCartModal(itemId, itemType) {
    const data = getInventoryData();
    if (!data) return;
    let item = itemType === 'shoes' ? (data.shoes || []).find(s => s.id === itemId) : (data.bags || []).find(b => b.id === itemId);
    if (!item) { alert('Item not found'); return; }

    currentItemToAdd = item;
    currentItemType = itemType;
    addToCartModalTitle.textContent = `Add ${item.brand} ${item.model} to Cart`;
    sizeColorOptions.innerHTML = '';
    selectedItemStock.textContent = 'Stock: --';
    priceOptionsDiv.innerHTML = ''; // Clear previous price options
    priceOptionsContainer.classList.add('hidden'); // Hide price options by default

    let hasOptions = false;
    if (itemType === 'shoes') {
        for (const key in item.stock) {
            const stockQty = Number(item.stock[key]) || 0;
            if (stockQty > 0) {
                const [color, size] = key.split('_');
                const rid = `opt-${key.replace(/\s+/g,'-')}`;
                sizeColorOptions.innerHTML += `
                    <div class="flex items-center mb-2">
                        <input type="radio" id="${rid}" name="item-option" value="${key}" class="mr-2" required>
                        <label for="${rid}" class="text-gray-700">${color} - Size ${size} (Stock: ${stockQty})</label>
                    </div>
                `;
                hasOptions = true;
            }
        }
    } else { // bags
        for (const colorKey in item.stock) {
            const stockQty = Number(item.stock[colorKey]) || 0;
            if (stockQty > 0) {
                const rid = `opt-${colorKey.replace(/\s+/g,'-')}`;
                sizeColorOptions.innerHTML += `
                    <div class="flex items-center mb-2">
                        <input type="radio" id="${rid}" name="item-option" value="${colorKey}" class="mr-2" required>
                        <label for="${rid}" class="text-gray-700">${colorKey} (Stock: ${stockQty})</label>
                    </div>
                `;
                hasOptions = true;
            }
        }
    }

    document.querySelector('#add-to-cart-form button[type="submit"]').disabled = !hasOptions;

    // update stock label and show price options on change
    const radioButtons = sizeColorOptions.querySelectorAll('input[name="item-option"]');
    radioButtons.forEach(radio => {
        radio.addEventListener('change', (e) => {
            const v = e.target.value;
            selectedItemStock.textContent = `Stock: ${Number(currentItemToAdd.stock[v] || 0)}`;

            // Generate price options
            priceOptionsDiv.innerHTML = `
                <div class="flex items-center">
                    <input type="radio" id="price-choice-0" name="sold-price" value="${currentItemToAdd.minPrice.toFixed(2)}" class="mr-2" required checked>
                    <label for="price-choice-0" class="text-gray-700">Minimum: ${currentItemToAdd.minPrice.toFixed(2)}</label>
                </div>
                <div class="flex items-center">
                    <input type="radio" id="price-choice-1" name="sold-price" value="${currentItemToAdd.price.toFixed(2)}" class="mr-2" required>
                    <label for="price-choice-1" class="text-gray-700">Regular: ${currentItemToAdd.price.toFixed(2)}</label>
                </div>
            `;
            priceOptionsContainer.classList.remove('hidden'); // Show price options
        });
    });


    addToCartModal.classList.remove('hidden');
}

closeAddToCartModal.addEventListener('click', ()=> { addToCartModal.classList.add('hidden'); addToCartForm.reset(); currentItemToAdd = null; currentItemType = null; });
cancelAddToCart.addEventListener('click', ()=> { addToCartModal.classList.add('hidden'); addToCartForm.reset(); currentItemToAdd = null; currentItemType = null; });

// Consolidated addToCartForm submit listener
addToCartForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const selOption = document.querySelector('input[name="item-option"]:checked');
    const selPrice = document.querySelector('input[name="sold-price"]:checked');

    if (!selOption) { alert('Please select an item option (size/color).'); return; }
    if (!selPrice) { alert('Please select a sold price.'); return; }

    const soldPrice = parseFloat(selPrice.value);
    const selectedValue = selOption.value;
    const data = getInventoryData();
    const cart = data.cart || [];

    let color = null, size = null, stockKey = selectedValue;
    if (currentItemType === 'shoes') {
        const parts = selectedValue.split('_');
        color = parts[0];
        size = Number(parts[1]);
    } else { // bags
        color = selectedValue;
    }

    const currentStock = Number(currentItemToAdd.stock[stockKey] || 0);
    if (currentStock <= 0) { alert('Out of stock'); return; }

    const cartItem = {
        id: currentItemToAdd.id,
        brand: currentItemToAdd.brand,
        model: currentItemToAdd.model,
        price: soldPrice, // Use the chosen soldPrice
        image: currentItemToAdd.image,
        type: currentItemType,
        color,
        size,
        quantity: 1
    };

    const idx = cart.findIndex(ci => ci.id === cartItem.id && ci.color === cartItem.color && (ci.size || null) === (cartItem.size || null));
    if (idx > -1) {
        // Check if adding another quantity exceeds stock
        if (cart[idx].quantity + 1 > currentStock) {
            alert('Cannot add more, not enough stock.');
            return;
        }
        cart[idx].quantity += 1;
    }
    else {
        cart.push(cartItem);
    }

    // decrement stock in inventory
    if (currentItemType === 'shoes') {
        const sidx = (data.shoes || []).findIndex(s => s.id === currentItemToAdd.id);
        if (sidx > -1) data.shoes[sidx].stock[stockKey] = (Number(data.shoes[sidx].stock[stockKey]) || 0) - 1;
    } else { // bags
        const bidx = (data.bags || []).findIndex(b => b.id === currentItemToAdd.id);
        if (bidx > -1) data.bags[bidx].stock[stockKey] = (Number(data.bags[bidx].stock[stockKey]) || 0) - 1;
    }

    data.cart = cart;
    saveInventoryData(data);
    alert('Item added to cart');
    addToCartModal.classList.add('hidden');
    addToCartForm.reset();
    currentItemToAdd = null; currentItemType = null;
    renderInventory();
    updateCartCount();
});

/* ---------------------------
   Login, register, navigation
   --------------------------- */
function showView(viewId) {
    loginView.classList.add('hidden');
    inventoryView.classList.add('hidden');
    cartView.classList.add('hidden');
    salesHistoryView.classList.add('hidden');
    registerModal.classList.add('hidden'); // Ensure register modal is hidden
    createLimitedModal.classList.add('hidden'); // Ensure limited creation modal is hidden
    createAdminModal.classList.add('hidden'); // Ensure new admin creation modal is hidden

    document.getElementById(viewId).classList.remove('hidden');
}

function applyRoleRestrictions() {
    if (currentUser && currentUser.role === 'viewer') {
        adminActions.classList.add('hidden'); // Hide Add Shoe/Bag/Reset Data buttons
        document.querySelectorAll('.edit-item-btn').forEach(btn => btn.classList.add('hidden'));
        document.querySelectorAll('.delete-item-btn').forEach(btn => btn.classList.add('hidden'));
        createLimitedAccountBtn.classList.add('hidden'); // Hide create limited account button for viewers
        createAdminAccountBtn.classList.add('hidden'); // Hide create admin account button for viewers
    } else { // Admin
        adminActions.classList.remove('hidden');
        document.querySelectorAll('.edit-item-btn').forEach(btn => btn.classList.remove('hidden'));
        document.querySelectorAll('.delete-item-btn').forEach(btn => btn.classList.remove('hidden'));
        createLimitedAccountBtn.classList.remove('hidden'); // Show create limited account button for admins
        createAdminAccountBtn.classList.remove('hidden'); // Show create admin account button for admins
    }
}

loginForm.addEventListener('submit', function(e){
    e.preventDefault();
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value.trim();
    if (!u || !p) { alert('Enter username and password'); return; }
    const data = getInventoryData();
    if (!data) return;
    const admin = (data.admins || []).find(a => a.username === u && a.password === p);
    if (admin) {
        currentUser = { username: u, role: admin.role };
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        alert('Login successful as ' + u + ' (' + admin.role + ')');
        showView('inventory-view');
        renderInventory();
        applyRoleRestrictions();
    } else {
        alert('Invalid username or password.');
    }
});

logoutBtn.addEventListener('click', function() {
    currentUser = null;
    localStorage.removeItem('currentUser');
    alert('Logged out.');
    showView('login-view');
    // Clear any sensitive data or reset UI if necessary
    checkAdminAccountExists(); // Re-check and show/hide register button on logout
});

registerBtn.addEventListener('click', () => {
    registerModal.classList.remove('hidden');
    registerForm.reset();
});

cancelRegister.addEventListener('click', () => {
    registerModal.classList.add('hidden');
});

registerForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const newUsername = document.getElementById('new-username').value.trim();
    const newPassword = document.getElementById('new-password').value.trim();

    if (!newUsername || !newPassword) {
        alert('Please enter both username and password.');
        return;
    }

    const data = getInventoryData();
    if (!data) return;

    if ((data.admins || []).some(a => a.username === newUsername)) {
        alert('Username already exists. Please choose a different one.');
        return;
    }

    data.admins = data.admins || [];
    data.admins.push({ username: newUsername, password: newPassword, role: 'admin' });
    saveInventoryData(data);
    alert('Admin account created successfully!');
    registerModal.classList.add('hidden');
    loginForm.reset(); // Clear login form
    checkAdminAccountExists(); // Re-check and hide register button after creating an admin
});

// Limited Account Creation Logic
createLimitedAccountBtn.addEventListener('click', () => {
    if (currentUser && currentUser.role === 'admin') {
        createLimitedModal.classList.remove('hidden');
        createLimitedForm.reset();
    } else {
        alert('You do not have permission to create limited accounts.');
    }
});

cancelLimitedCreationBtn.addEventListener('click', () => {
    createLimitedModal.classList.add('hidden');
});

createLimitedForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const limitedUsername = document.getElementById('limited-username').value.trim();
    const limitedPassword = document.getElementById('limited-password').value.trim();

    if (!limitedUsername || !limitedPassword) {
        alert('Please enter both username and password for the limited account.');
        return;
    }

    const data = getInventoryData();
    if (!data) return;

    if ((data.admins || []).some(a => a.username === limitedUsername)) {
        alert('Username already exists. Please choose a different one.');
        return;
    }

    data.admins = data.admins || [];
    data.admins.push({ username: limitedUsername, password: limitedPassword, role: 'viewer' }); // Assign 'viewer' role
    saveInventoryData(data);
    alert('Limited account created successfully!');
    createLimitedModal.classList.add('hidden');
    createLimitedForm.reset();
});

// New Admin Account Creation Logic (for logged-in admin)
createAdminAccountBtn.addEventListener('click', () => {
    if (currentUser && currentUser.role === 'admin') {
        createAdminModal.classList.remove('hidden');
        createAdminForm.reset();
    } else {
        alert('You do not have permission to create admin accounts.');
    }
});

cancelAdminCreationBtn.addEventListener('click', () => {
    createAdminModal.classList.add('hidden');
});

createAdminForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const adminUsername = document.getElementById('admin-username').value.trim();
    const adminPassword = document.getElementById('admin-password').value.trim();

    if (!adminUsername || !adminPassword) {
        alert('Please enter both username and password for the new admin account.');
        return;
    }

    const data = getInventoryData();
    if (!data) return;

    if ((data.admins || []).some(a => a.username === adminUsername)) {
        alert('Username already exists. Please choose a different one.');
        return;
    }

    data.admins = data.admins || [];
    data.admins.push({ username: adminUsername, password: adminPassword, role: 'admin' }); // Assign 'admin' role
    saveInventoryData(data);
    alert('New admin account created successfully!');
    createAdminModal.classList.add('hidden');
    createAdminForm.reset();
});


viewCartBtn.addEventListener('click', () => {
    showView('cart-view');
    renderCart();
});

backToInventoryBtn.addEventListener('click', () => {
    showView('inventory-view');
    renderInventory();
});

salesHistoryBtn.addEventListener('click', () => {
    showView('sales-history-view');
    renderSalesHistory();
});

backToInventoryFromHistoryBtn.addEventListener('click', () => {
    showView('inventory-view');
    renderInventory();
});

// Consolidated checkoutBtn click listener
checkoutBtn.addEventListener('click', () => {
    const data = getInventoryData();
    if (!data || !data.cart || data.cart.length === 0) {
        alert('Your cart is empty!');
        return;
    }

    const cartTotal = parseFloat(cartTotalSpan.textContent);
    const discountPerc = parseFloat(checkoutDiscountInput.value || 0);
    const paymentMethod = document.getElementById('payment-method').value; // Get the selected payment method

    addSaleRecord(data.cart, cartTotal, discountPerc, paymentMethod); // Pass paymentMethod to addSaleRecord
    data.cart = []; // Clear cart after checkout
    saveInventoryData(data);
    alert('Checkout successful! Sales recorded.');
    renderCart(); // Re-render cart (will show empty)
    updateCartCount();
    showView('inventory-view'); // Go back to inventory
    renderInventory(); // Re-render inventory to reflect stock changes
});

checkoutDiscountInput.addEventListener('input', renderCart); // Recalculate total on discount change

clearStorageBtn.addEventListener('click', () => {
    if (confirm('Are you sure you want to reset all data (inventory, sales, users)? This cannot be undone.')) {
        localStorage.clear();
        location.reload(); // Reload page to re-initialize with sample data
    }
});

filterSalesDateInput.addEventListener('change', (e) => {
    renderSalesHistory(e.target.value);
});

clearSalesDateBtn.addEventListener('click', () => {
    filterSalesDateInput.value = '';
    renderSalesHistory();
});

// Function to check if at least one admin account exists
function checkAdminAccountExists() {
    const data = getInventoryData();
    const admins = (data && data.admins) || [];
    const adminExists = admins.some(admin => admin.role === 'admin');
    if (adminExists) {
        registerBtn.classList.add('hidden'); // Hide the button on the login screen
    } else {
        registerBtn.classList.remove('hidden'); // Show the button on the login screen
    }
}

// Navbar Toggler Functionality
navbarToggler.addEventListener('click', () => {
    navbarItems.classList.toggle('active');
});

// Filter Toggler Functionality
filterToggler.addEventListener('click', () => {
    filterControls.classList.toggle('active');
});

// Close navbar and filter dropdowns if clicked outside
document.addEventListener('click', (event) => {
    // Close navbar dropdown
    if (!navbarItems.contains(event.target) && !navbarToggler.contains(event.target)) {
        if (navbarItems.classList.contains('active')) {
            navbarItems.classList.remove('active');
        }
    }
    // Close filter dropdown
    if (!filterControls.contains(event.target) && !filterToggler.contains(event.target)) {
        if (filterControls.classList.contains('active')) {
            filterControls.classList.remove('active');
        }
    }
});


// Initial load check
document.addEventListener('DOMContentLoaded', () => {
    const storedUser = localStorage.getItem('currentUser');
    if (storedUser) {
        currentUser = JSON.parse(storedUser);
        showView('inventory-view');
        renderInventory();
    } else {
        showView('login-view');
        checkAdminAccountExists(); // Check on initial load of login view
    }
});

// Initial render of filters
document.addEventListener('DOMContentLoaded', updateFilterOptions);

// Event listeners for filters
document.getElementById('filter-type').addEventListener('change', renderInventory);
document.getElementById('filter-brand').addEventListener('change', renderInventory);
document.getElementById('filter-color').addEventListener('change', renderInventory);
document.getElementById('filter-min-price').addEventListener('input', renderInventory);
document.getElementById('filter-max-price').addEventListener('input', renderInventory);
// Event listener for the new filter-code input
document.getElementById('filter-code').addEventListener('input', renderInventory);


// --- Added Reset Filters button functionality ---
document.getElementById('reset-filters-btn').addEventListener('click', () => {
    document.getElementById('filter-type').value = '';
    document.getElementById('filter-brand').value = '';
    document.getElementById('filter-color').value = '';
    document.getElementById('filter-min-price').value = '';
    document.getElementById('filter-max-price').value = '';
    document.getElementById('filter-code').value = '';
    renderInventory();
});

</script>
</body>
</html>