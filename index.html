<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- CRITICAL FIX: Corrected viewport for proper mobile scaling -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mony Store - Shoes & Bags Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase App (auto-init) -->
    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, runTransaction, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // --- Firebase/App Config ---
        // User's specific Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAUKO8uuxSKT1ZAk8S85o_9TK5g7xZfclQ",
            authDomain: "mony-store-be90e.firebaseapp.com",
            projectId: "mony-store-be90e",
            storageBucket: "mony-store-be90e.firebasestorage.app",
            messagingSenderId: "464075483809",
            appId: "1:464075483809:web:cb6827b0df5476c1061ee0"
        };
        
        // --- SHARED DATA LOGIC (FIX for Multi-Device Sync) ---
        // All users of this app share the same data, identified by the project ID.
        // This ensures data syncs between phone, PC, etc.
        const SHARED_APP_ID = firebaseConfig.projectId;

        // --- Global App State ---
        let db, auth;
        let userId = null; // This will be the anon auth UID
        let currentUserRole = 'sales'; // Default to least privileged
        let products = [];
        let salesHistory = [];
        let userAccounts = []; // For admin user management
        let cart = [];
        let productsUnsubscribe = () => {};
        let salesUnsubscribe = () => {};
        let usersUnsubscribe = () => {};

        // --- Hardcoded root accounts (fallback) ---
        const rootAccounts = {
            'admin': { pass: 'admin123', role: 'admin' },
            'user': { pass: 'user123', role: 'admin' },
            'sales': { pass: 'sales123', role: 'sales' }
        };

        // --- Firebase Collections (FIX for Multi-Device Sync) ---
        // All data is stored under the shared app ID, not the user's anon UID
        const getUsersCollection = () => collection(db, 'apps', SHARED_APP_ID, 'accounts');
        const getProductsCollection = () => collection(db, 'apps', SHARED_APP_ID, 'products');
        const getSalesCollection = () => collection(db, 'apps', SHARED_APP_ID, 'sales');

        // --- Size Definitions (UPDATED) ---
        const babySizes = ["18", "18.5", "19", "19.5", "20", "21", "22"]; // ADDED 18.5
        const kidSizes = Array.from({length: 36 - 22 + 1}, (_, i) => String(22 + i)); // "22" to "36"
        const adultSizes = Array.from({length: 46 - 36 + 1}, (_, i) => String(36 + i)); // "36" to "46"
        
        const sizeCategories = {
            "Baby": babySizes,
            "Kid": kidSizes,
            "Adult": adultSizes
        };

        // --- DOM Elements ---
        const loadingSpinner = document.getElementById('loadingSpinner');
        const loginSection = document.getElementById('loginSection');
        const appSection = document.getElementById('appSection');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('loginButton');
        const loginError = document.getElementById('loginError');
        const logoutButton = document.getElementById('logoutButton');
        const appLogo = document.getElementById('appLogo'); // Logo element

        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page');
        const inventoryPage = document.getElementById('inventoryPage');
        const posPage = document.getElementById('posPage');
        const salesPage = document.getElementById('salesPage');
        const usersPage = document.getElementById('usersPage'); // User Management Page

        // Inventory
        const addProductForm = document.getElementById('addProductForm');
        const productCode = document.getElementById('productCode'); // New
        const productName = document.getElementById('productName');
        const productType = document.getElementById('productType');
        
        // Shoes
        const productShoeCategoryContainer = document.getElementById('productShoeCategoryContainer'); 
        const productShoeCategory = document.getElementById('productShoeCategory'); 
        const addSizeManagementContainer = document.getElementById('addSizeManagementContainer'); 
        const addSizeList = document.getElementById('addSizeList');
        
        // Bags (NEW)
        const addBagColorContainer = document.getElementById('addBagColorContainer');
        const addBagColorList = document.getElementById('addBagColorList');

        // Common
        const productCost = document.getElementById('productCost');
        const productPrice = document.getElementById('productPrice');
        const productMinPrice = document.getElementById('productMinPrice'); // New
        
        // Image inputs (Add)
        const addImageInputToggle = document.getElementById('addImageInputToggle');
        const addImageUploadContainer = document.getElementById('addImageUploadContainer');
        const addImageUrlContainer = document.getElementById('addImageUrlContainer');
        const productImageFile = document.getElementById('productImageFile');
        const addProductImageUrl = document.getElementById('productImageUrl');
        const addProductPreview = document.getElementById('addProductPreview');

        const inventoryTableBody = document.getElementById('inventoryTableBody');
        const filterInventory = document.getElementById('filterInventory'); // Filter input
        const clearInventoryFilter = document.getElementById('clearInventoryFilter'); // Filter clear

        // Edit Modal
        const editModal = document.getElementById('editModal');
        const editProductId = document.getElementById('editProductId');
        const editProductCode = document.getElementById('editProductCode'); // New
        const editProductName = document.getElementById('editProductName');
        const editProductType = document.getElementById('editProductType');
        
        // Edit Shoes
        const editProductShoeCategoryContainer = document.getElementById('editProductShoeCategoryContainer');
        const editProductShoeCategory = document.getElementById('editProductShoeCategory');
        const editSizeManagementContainer = document.getElementById('editSizeManagementContainer');
        const editSizeList = document.getElementById('editSizeList');
        
        // Edit Bags (NEW)
        const editBagColorContainer = document.getElementById('editBagColorContainer');
        const editBagColorList = document.getElementById('editBagColorList');
        
        // Edit Common
        const editProductCost = document.getElementById('editProductCost');
        const editProductPrice = document.getElementById('editProductPrice');
        const editProductMinPrice = document.getElementById('editProductMinPrice'); // New
        
        // Image inputs (Edit)
        const editImageInputToggle = document.getElementById('editImageInputToggle');
        const editImageUploadContainer = document.getElementById('editImageUploadContainer');
        const editImageUrlContainer = document.getElementById('editImageUrlContainer');
        const editProductImageFile = document.getElementById('editProductImageFile');
        const editProductImageUrl = document.getElementById('editProductImageUrl');
        const editProductPreview = document.getElementById('editProductPreview');
        
        const saveEditButton = document.getElementById('saveEditButton');
        const cancelEditButton = document.getElementById('cancelEditButton');

        // POS
        const posGrid = document.getElementById('posGrid');
        const filterPOS = document.getElementById('filterPOS'); // Filter input for POS
        const clearPOSFilter = document.getElementById('clearPOSFilter'); // Filter clear for POS
        const cartItems = document.getElementById('cartItems');
        const cartTotal = document.getElementById('cartTotal');
        const checkoutButton = document.getElementById('checkoutButton');
        const clearCartButton = document.getElementById('clearCartButton');

        // POS Shoe Selection Modal (RENAMED)
        const selectShoeModal = document.getElementById('selectShoeModal');
        const shoeModalProductName = document.getElementById('shoeModalProductName');
        const shoeRadioContainer = document.getElementById('shoeRadioContainer');
        const confirmShoeButton = document.getElementById('confirmShoeButton');
        const cancelShoeButton = document.getElementById('cancelShoeButton');
        let shoeModalProductId = null; // Store product ID for shoe modal

        // POS Color Selection Modal (Bags)
        const selectColorModal = document.getElementById('selectColorModal');
        const colorModalProductName = document.getElementById('colorModalProductName');
        const colorRadioContainer = document.getElementById('colorRadioContainer');
        const confirmColorButton = document.getElementById('confirmColorButton');
        const cancelColorButton = document.getElementById('cancelColorButton');
        let colorModalProductId = null; // Store product ID for color modal

        // Checkout Modal
        const checkoutModal = document.getElementById('checkoutModal');
        const checkoutSubtotalAmount = document.getElementById('checkoutSubtotalAmount');
        const discountPercentage = document.getElementById('discountPercentage');
        const checkoutTotalAmount = document.getElementById('checkoutTotalAmount');
        const paymentMethod = document.getElementById('paymentMethod');
        const confirmSaleButton = document.getElementById('confirmSaleButton');
        const cancelSaleButton = document.getElementById('cancelSaleButton');

        // Sales
        const salesTableBody = document.getElementById('salesTableBody');
        const salesSummaryEl = document.getElementById('salesSummary');
        const monthlyTotalEl = document.getElementById('monthlyTotal');
        const dailyTotalEl = document.getElementById('dailyTotal');
        const filterSalesDate = document.getElementById('filterSalesDate');
        const clearSalesDate = document.getElementById('clearSalesDate');

        // User Management
        const addUserForm = document.getElementById('addUserForm');
        const newUsername = document.getElementById('newUsername');
        const newPassword = document.getElementById('newPassword');
        const newRole = document.getElementById('newRole');
        const userListTableBody = document.getElementById('userListTableBody');

        // Notification Modals
        let notificationModal, notificationMessage, notificationCloseBtn;
        let confirmationModal, confirmationMessage, confirmationCancelBtn, confirmationConfirmBtn;
        let confirmationCallback = null; // Store the confirm action

        // --- Utility Functions ---

        /**
         * Shows a non-blocking notification message.
         */
        const showNotification = (message) => {
            notificationMessage.textContent = message;
            notificationModal.classList.remove('hidden');
        };

        /**
         * Hides the notification message.
         */
        const hideNotification = () => {
            notificationModal.classList.add('hidden');
        };

        /**
         * Shows a confirmation dialog.
         * @param {string} message - The message to display.
         * @param {function} onConfirm - The callback function to execute if confirmed.
         */
        const showConfirmation = (message, onConfirm) => {
            confirmationMessage.textContent = message;
            confirmationCallback = onConfirm;
            confirmationModal.classList.remove('hidden');
        };

        /**
         * Hides the confirmation dialog.
         */
        const hideConfirmation = () => {
            confirmationModal.classList.add('hidden');
            confirmationCallback = null;
        };

        /**
         * Handles the click on the "Confirm" button.
         */
        const handleConfirm = () => {
            if (typeof confirmationCallback === 'function') {
                confirmationCallback();
            }
            hideConfirmation();
        };
        
        /**
         * Converts an image file to a Base64 Data URL.
         */
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        /**
         * Compresses an image file before uploading.
         * Using very low quality settings as requested.
         */
        const compressImage = (file, maxWidth = 400, quality = 0.2) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Get the data URL for the compressed image
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedDataUrl);
                };
                img.onerror = (error) => reject(error); // Handle image loading errors
            };
            reader.onerror = (error) => reject(error); // Handle file reading errors
        });


        /**
         * Toggles the visibility of Bag vs Shoe quantity/size inputs
         */
        const toggleProductFields = (type, shoeCategoryContainer, shoeSizeContainer, bagColorContainer) => {
            if (type === 'Shoes') {
                shoeCategoryContainer.classList.remove('hidden');
                shoeSizeContainer.classList.remove('hidden');
                bagColorContainer.classList.add('hidden');
            } else if (type === 'Bags') {
                shoeCategoryContainer.classList.add('hidden');
                shoeSizeContainer.classList.add('hidden');
                bagColorContainer.classList.remove('hidden');
            } else {
                shoeCategoryContainer.classList.add('hidden');
                shoeSizeContainer.classList.add('hidden');
                bagColorContainer.classList.add('hidden');
            }
        };

        /**
         * Creates a new size/color/quantity input row for shoes.
         */
        const addSizeInputRow = (container, category, size = '', color = '', quantity = 1) => {
            const sizes = sizeCategories[category];
            if (!sizes) return; // No category selected

            const rowId = `size-row-${Date.now()}-${Math.random()}`; // More unique ID
            const sizeOptions = sizes.map(s => `<option value="${s}" ${s === size ? 'selected' : ''}>${s}</option>`).join('');

            const row = document.createElement('div');
            row.id = rowId;
            row.className = 'flex items-center space-x-2 mb-2 size-data-row'; // Specific class
            row.innerHTML = `
                <select data-type="size" class="w-1/3 border border-gray-300 rounded-md shadow-sm p-2">
                    <option value="">Select Size</option>
                    ${sizeOptions}
                </select>
                <input data-type="color" type="text" value="${color}" class="w-1/3 border border-gray-300 rounded-md shadow-sm p-2" placeholder="Color" required>
                <input data-type="quantity" type="number" min="0" value="${quantity}" class="w-1/3 border border-gray-300 rounded-md shadow-sm p-2" placeholder="Qty" required>
                <button type="button" class="remove-row-btn bg-red-500 text-white rounded-full w-6 h-6 flex-shrink-0 flex items-center justify-center">-</button>
            `;
            container.appendChild(row);

            // Add listener to remove button
            row.querySelector('.remove-row-btn').addEventListener('click', () => {
                const elementToRemove = document.getElementById(rowId);
                if (elementToRemove) {
                    elementToRemove.remove();
                }
            });
        };
        
        /**
         * Creates a new color/quantity input row for bags.
         */
        const addBagColorRow = (container, color = '', quantity = 1) => {
            const rowId = `color-row-${Date.now()}-${Math.random()}`; // More unique ID
            const row = document.createElement('div');
            row.id = rowId;
            row.className = 'flex items-center space-x-2 mb-2 color-data-row'; // Specific class
            row.innerHTML = `
                <input data-type="color" type="text" value="${color}" class="w-1/2 border border-gray-300 rounded-md shadow-sm p-2" placeholder="Color" required>
                <input data-type="quantity" type="number" min="0" value="${quantity}" class="w-1/2 border border-gray-300 rounded-md shadow-sm p-2" placeholder="Qty" required>
                <button type="button" class="remove-row-btn bg-red-500 text-white rounded-full w-6 h-6 flex-shrink-0 flex items-center justify-center">-</button>
            `;
            container.appendChild(row);

            // Add listener to remove button
            row.querySelector('.remove-row-btn').addEventListener('click', () => {
                 const elementToRemove = document.getElementById(rowId);
                if (elementToRemove) {
                    elementToRemove.remove();
                }
            });
        };
        
        /**
         * Reads the size/color/quantity pairs from a container.
         * Returns an object like: { "38": {"Red": 10, "Black": 5}, "39": {"Blue": 5} }
         * Allows quantity of 0. Returns null if any row is invalid (missing size or color).
         */
        const getSizeDataFromUI = (container) => {
            const sizeData = {};
            const rows = container.querySelectorAll('.size-data-row'); // Use specific class
            let validRowsFound = false;
            let invalidRowFound = false;

            rows.forEach(row => {
                const sizeEl = row.querySelector('[data-type="size"]');
                const colorEl = row.querySelector('[data-type="color"]'); // NEW
                const qtyEl = row.querySelector('[data-type="quantity"]');
                
                const size = sizeEl.value;
                const color = colorEl.value.trim(); // NEW
                const quantityStr = qtyEl.value;
                const quantity = parseInt(quantityStr, 10);

                // Ignore completely empty rows
                if (!size && !color && !quantityStr) {
                    return; 
                }

                if (size && color && quantityStr !== '' && !isNaN(quantity) && quantity >= 0) {
                    // Valid row (size, color, and qty >= 0)
                    if (!sizeData[size]) {
                        sizeData[size] = {};
                    }
                    if (sizeData[size][color]) {
                        sizeData[size][color] += quantity; // Sum quantities if same size/color is added multiple times
                    } else {
                        sizeData[size][color] = quantity;
                    }
                    validRowsFound = true;
                } else {
                    // Invalid row if any part is filled but not all required parts are valid
                    invalidRowFound = true; 
                    console.warn(`Invalid size row detected: Size='${size}', Color='${color}', Qty='${quantityStr}'`);
                }
            });
            
            if (invalidRowFound) return null; // Found a bad row
            // If no rows were added at all, or only empty rows, consider it empty but valid
            return sizeData; 
        };

        /**
         * Reads the color/quantity pairs from a container (for Bags).
         * Returns an object like: { "Black": 10, "Red": 5 }
         * Allows quantity of 0. Returns null if any row is invalid (missing color).
         */
        const getColorDataFromUI = (container) => {
            const colorData = {};
            const rows = container.querySelectorAll('.color-data-row'); // Use specific class
            let validRowsFound = false;
            let invalidRowFound = false;

            rows.forEach(row => {
                const colorEl = row.querySelector('[data-type="color"]');
                const qtyEl = row.querySelector('[data-type="quantity"]');
                const color = colorEl.value.trim();
                const quantityStr = qtyEl.value;
                const quantity = parseInt(quantityStr, 10);

                // Ignore completely empty rows
                if (!color && !quantityStr) {
                    return;
                }

                if (color && quantityStr !== '' && !isNaN(quantity) && quantity >= 0) {
                    if (colorData[color]) {
                        colorData[color] += quantity; // Sum quantities if same color is added multiple times
                    } else {
                        colorData[color] = quantity;
                    }
                    validRowsFound = true;
                } else {
                     invalidRowFound = true;
                     console.warn(`Invalid color row detected: Color='${color}', Qty='${quantityStr}'`);
                }
            });
            
            if (invalidRowFound) return null;
             // If no rows were added at all, or only empty rows, consider it empty but valid
            return colorData; 
        };

        // --- Authentication (FIXED for Persistence on Refresh) ---
        const initAuth = () => {
            try {
                // Initialize Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid; // Store the auth UID
                        const storedRole = sessionStorage.getItem('userRole');
                        
                        if (storedRole) {
                            // User is logged in and has a role stored from previous session
                            currentUserRole = storedRole;
                            showApp(); 
                            await loadData(); // Load data from shared collection
                        } else {
                            // User is signed in (anon) but hasn't provided credentials in this session
                            showLogin();
                        }
                    } else {
                        // User is signed out (or first load), sign them in anonymously
                        try {
                            await signInAnonymously(auth);
                            // onAuthStateChanged will fire again with the new anonymous user
                        } catch (error) {
                             console.error("Anonymous sign-in failed:", error);
                             loginError.textContent = `Firebase connection failed. Please try refreshing. ${error.message}`;
                             loginError.classList.remove('hidden');
                        }
                    }
                    loadingSpinner.classList.add('hidden'); // Hide spinner once auth state is known
                });

            } catch (error) {
                console.error("Firebase Init Error:", error);
                loginError.textContent = `Firebase connection failed: ${error.message}`;
                loginError.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        };
        
        const handleLogin = async (e) => { 
            e.preventDefault();
            const user = usernameInput.value.trim(); // Trim whitespace
            const pass = passwordInput.value;
            
            if (!user || !pass) {
                loginError.textContent = 'Please enter username and password.';
                loginError.classList.remove('hidden');
                return;
            }

            loginButton.disabled = true;
            loginError.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            
            let validCredentials = false;
            let role = null; // Use null initially
            
            try {
                // 1. Check hardcoded root accounts first
                if (rootAccounts[user] && rootAccounts[user].pass === pass) {
                    role = rootAccounts[user].role;
                    validCredentials = true;
                } else {
                    // 2. Check Firestore for user accounts if not a root account
                    const usersRef = getUsersCollection(); // Use shared collection
                    const userDocRef = doc(usersRef, user); // Use username as document ID
                    const userDoc = await getDoc(userDocRef);

                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        if (userData.password === pass) { 
                            role = userData.role;
                            validCredentials = true;
                        }
                    }
                }

                // 3. Act on credential check
                if (validCredentials && role) {
                    currentUserRole = role;
                    sessionStorage.setItem('userRole', currentUserRole); // Save role for refresh
                    sessionStorage.setItem('username', user); // Save username for context
                    
                    showApp(); // Show the main app UI based on the role
                    await loadData(); // Load data associated with the app

                } else {
                    loginError.textContent = 'Invalid username or password.';
                    loginError.classList.remove('hidden');
                    // DO NOT sign out here - let them retry
                }

            } catch (error) {
                console.error("Firebase Auth Error (on login):", error);
                loginError.textContent = `Login failed: ${error.message}.`;
                loginError.classList.remove('hidden');
            } finally {
                loginButton.disabled = false;
                loadingSpinner.classList.add('hidden');
            }
        };
        
        const handleLogout = async () => {
            // Keep the anonymous Firebase auth session, just clear app-level state
            try {
                sessionStorage.removeItem('userRole');
                sessionStorage.removeItem('username');
                
                // Detach listeners and clear data
                clearData();
                
                // Manually show the login screen
                showLogin();

            } catch (error) {
                console.error("Logout failed:", error);
            }
        };

        const showLogin = () => {
            loadingSpinner.classList.add('hidden');
            loginSection.classList.remove('hidden');
            appSection.classList.add('hidden');
            currentUserRole = 'sales'; // Reset role to default on showing login
            // Clear any potentially lingering session data
            sessionStorage.removeItem('userRole');
            sessionStorage.removeItem('username');
            usernameInput.value = ''; // Clear inputs
            passwordInput.value = '';
            loginError.classList.add('hidden'); // Hide previous errors
        };

        const showApp = () => {
            loadingSpinner.classList.add('hidden');
            loginSection.classList.add('hidden');
            appSection.classList.remove('hidden');
            
            // Get nav links
            const inventoryNav = document.querySelector('.nav-link[data-page="inventoryPage"]');
            const salesNav = document.querySelector('.nav-link[data-page="salesPage"]');
            const usersNav = document.querySelector('.nav-link[data-page="usersPage"]'); 
            
            // Show/hide UI based on role
            if (currentUserRole === 'sales') {
                inventoryNav.classList.add('hidden');
                usersNav.classList.add('hidden');
                salesNav.classList.remove('hidden'); // Sales can now see sales history
                showPage('posPage'); // Default page for sales
            } else { // Admin role
                inventoryNav.classList.remove('hidden');
                salesNav.classList.remove('hidden');
                usersNav.classList.remove('hidden');
                showPage('inventoryPage'); // Default page for admin
            }
        };

        // --- New function to clear data and listeners ---
        const clearData = () => {
            productsUnsubscribe();
            salesUnsubscribe();
            usersUnsubscribe();
            products = [];
            salesHistory = [];
            userAccounts = [];
            cart = [];
            // Clear UI
            inventoryTableBody.innerHTML = '';
            salesTableBody.innerHTML = '';
            userListTableBody.innerHTML = '';
            posGrid.innerHTML = '';
            renderCart(); // Clears cart UI
        };

        // --- Data Loading (FIXED for Multi-Device Sync) ---
        const loadData = async () => {
            if (!SHARED_APP_ID) return;
            console.log("Loading shared data for app:", SHARED_APP_ID);

            // Detach previous listeners and clear old data if any exist
            clearData();

            // Load Products
            try {
                const productsRef = getProductsCollection();
                productsUnsubscribe = onSnapshot(productsRef, (snapshot) => {
                    products = [];
                    snapshot.forEach(doc => {
                        products.push({ id: doc.id, ...doc.data() });
                    });
                    console.log("Products loaded:", products.length);
                    
                    // --- Cart Validation ---
                    let cartUpdated = false;
                    for (let i = cart.length - 1; i >= 0; i--) {
                        const cartItem = cart[i];
                        const productInDb = products.find(p => p.id === cartItem.id);

                        if (!productInDb) {
                            cart.splice(i, 1);
                            cartUpdated = true;
                            continue;
                        }

                        let currentStock = 0;
                        if (cartItem.type === 'Bags') {
                            currentStock = productInDb.colorData ? (productInDb.colorData[cartItem.selectedColor] || 0) : 0;
                        } else if (cartItem.type === 'Shoes') {
                            currentStock = productInDb.sizeData && productInDb.sizeData[cartItem.selectedSize] 
                                ? (productInDb.sizeData[cartItem.selectedSize][cartItem.selectedColor] || 0)
                                : 0;
                        }

                        if (cartItem.quantity > currentStock) {
                            cartItem.quantity = currentStock; // Adjust quantity
                            cartUpdated = true;
                            if (cartItem.quantity === 0) cart.splice(i, 1); // Remove if stock is zero
                        }
                    }
                    
                    if (cartUpdated) {
                        showNotification("Your cart was updated based on the latest inventory stock.");
                        renderCart();
                    }
                    
                    renderInventory(); // Re-render with potentially filtered list
                    renderPOS();       // Re-render with potentially filtered list
                }, (error) => {
                    console.error("Error loading products:", error);
                    showNotification(`Error loading products: ${error.message}`);
                });
            } catch (error) {
                console.error("Failed to set up product listener:", error);
                showNotification(`Error setting up product listener: ${error.message}`);
            }


            // Load Sales History (Now accessible by 'sales' role too)
            try {
                const salesRef = getSalesCollection();
                salesUnsubscribe = onSnapshot(salesRef, (snapshot) => {
                    salesHistory = [];
                    snapshot.forEach(doc => {
                        salesHistory.push({ id: doc.id, ...doc.data() });
                    });
                    salesHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                    console.log("Sales loaded:", salesHistory.length);
                    renderSalesHistory();
                }, (error) => {
                    console.error("Error loading sales:", error);
                    showNotification(`Error loading sales history: ${error.message}`);
                });
            } catch (error) {
                console.error("Failed to set up sales listener:", error);
                showNotification(`Error setting up sales listener: ${error.message}`);
            }
                
            // Load Users (only if admin)
            if (currentUserRole === 'admin') {
                try {
                    const usersRef = getUsersCollection();
                    usersUnsubscribe = onSnapshot(usersRef, (snapshot) => {
                        userAccounts = [];
                        snapshot.forEach(doc => {
                            if (!rootAccounts[doc.id]) { // Exclude root accounts from management list
                                userAccounts.push({ id: doc.id, ...doc.data() });
                            }
                        });
                        console.log("User accounts loaded:", userAccounts.length);
                        renderUserList();
                    }, (error) => {
                        console.error("Error loading users:", error);
                         showNotification(`Error loading user accounts: ${error.message}`);
                    });
                } catch (error) {
                    console.error("Failed to set up user listener:", error);
                     showNotification(`Error setting up user listener: ${error.message}`);
                }
            }
        };


        // --- Page Navigation ---
        const showPage = (pageId) => {
            // Security check (already updated in showApp to allow sales access to sales history)
            if (currentUserRole === 'sales' && (pageId === 'inventoryPage' || pageId === 'usersPage')) {
                showPage('posPage'); // Redirect sales to POS if trying to access admin pages
                return;
            }

            pages.forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            navLinks.forEach(link => {
                link.dataset.page === pageId ? link.classList.add('bg-gray-900') : link.classList.remove('bg-gray-900');
            });

            // Refresh data on page load
            if (pageId === 'inventoryPage') renderInventory();
            if (pageId === 'posPage') renderPOS();
            if (pageId === 'salesPage') renderSalesHistory();
            if (pageId === 'usersPage' && currentUserRole === 'admin') renderUserList(); // Only render if admin
        };

        // --- Inventory Management (UPDATED for Shoe Colors) ---
        const renderInventory = () => {
            inventoryTableBody.innerHTML = '';

             // Filter logic
            const filterText = filterInventory.value.trim().toLowerCase();
            let filteredProducts = products;

            if (filterText) {
                filteredProducts = products.filter(product => {
                    // Check Code, Name, Type, Shoe Category
                    if ((product.code && product.code.toLowerCase().includes(filterText)) ||
                        (product.name && product.name.toLowerCase().includes(filterText)) ||
                        (product.type && product.type.toLowerCase().includes(filterText)) ||
                        (product.shoeCategory && product.shoeCategory.toLowerCase().includes(filterText))) {
                        return true;
                    }
                    // Check Shoe Colors
                    if (product.type === 'Shoes' && product.sizeData) {
                        for (const size in product.sizeData) {
                            if (Object.keys(product.sizeData[size]).some(color => color.toLowerCase().includes(filterText))) {
                                return true;
                            }
                        }
                    }
                    // Check Bag Colors
                    if (product.type === 'Bags' && product.colorData) {
                        if (Object.keys(product.colorData).some(color => color.toLowerCase().includes(filterText))) {
                            return true;
                        }
                    }
                    return false;
                });
            }


            if (filteredProducts.length === 0) {
                inventoryTableBody.innerHTML = `<tr><td colspan="10" class="text-center p-4">No products in inventory${filterText ? ' matching filter' : ''}.</td></tr>`;
                return;
            }

            filteredProducts.forEach(product => {
                let detailsDisplay = 'N/A';
                let totalStock = 0; 

                if (product.type === 'Shoes' && product.sizeData) {
                    const sizes = Object.keys(product.sizeData).sort();
                    if (sizes.length > 0) {
                        detailsDisplay = `${product.shoeCategory || ''}: ${sizes.map(s => {
                            const colors = product.sizeData[s];
                            const colorDetails = Object.entries(colors).map(([c, qty]) => {
                                totalStock += qty;
                                return `${c} (${qty})`;
                            }).join(' / ');
                            return `${s} (${colorDetails})`;
                        }).join(', ')}`;
                    } else {
                        detailsDisplay = `${product.shoeCategory || ''}: No sizes/colors`;
                    }
                } else if (product.type === 'Bags' && product.colorData) {
                    const colors = Object.keys(product.colorData).sort();
                    if (colors.length > 0) {
                        detailsDisplay = `Colors: ${colors.map(c => {
                            const qty = product.colorData[c];
                            totalStock += qty;
                            return `${c} (${qty})`;
                        }).join(', ')}`;
                    } else {
                        detailsDisplay = `Bags: No colors`;
                    }
                }
                
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                
                const placeholder = 'https://placehold.co/100x100/png?text=No+Image';
                const errorSrc = 'https://placehold.co/100x100/png?text=Bad+URL';
                
                tr.innerHTML = `
                    <td class="p-3"><img src="${product.imageUrl || placeholder}" alt="${product.name}" class="w-16 h-16 object-cover rounded" onerror="this.onerror=null; this.src='${errorSrc}'"></td>
                    <td class="p-3 font-medium">${product.name}</td>
                    <td class="p-3 hidden md:table-cell">${product.code || 'N/A'}</td>
                    <td class="p-3 hidden md:table-cell">${product.type}</td>
                    <td class="p-3 hidden lg:table-cell text-sm">${detailsDisplay}</td>
                    <td class="p-3">$${parseFloat(product.cost || 0).toFixed(2)}</td>
                    <td class="p-3">$${parseFloat(product.price || 0).toFixed(2)}</td>
                    <td class="p-3">$${parseFloat(product.minPrice || 0).toFixed(2)}</td>
                    <td class="p-3 font-bold">${totalStock}</td>
                    <td class="p-3 whitespace-nowrap">
                        <button class="edit-btn p-2 bg-blue-600 text-white rounded hover:bg-blue-700 mr-2" data-id="${product.id}">Edit</button>
                        <button class="delete-btn p-2 bg-red-600 text-white rounded hover:bg-red-700" data-id="${product.id}">Delete</button>
                    </td>
                `;
                inventoryTableBody.appendChild(tr);
            });
        };

        const handleAddProduct = async (e) => {
            e.preventDefault();
            const code = productCode.value.trim();
            const name = productName.value;
            const type = productType.value;
            const cost = parseFloat(productCost.value);
            const price = parseFloat(productPrice.value);
            const minPrice = parseFloat(productMinPrice.value) || 0;
            
            let imageUrl = addProductPreview.src;
            const imageUrlInput = addProductImageUrl.value;

            if (!code || !name || !type || isNaN(cost) || isNaN(price)) {
                showNotification('Please fill in all required fields (Code, Name, Type, Cost, Price).');
                return;
            }
            
            if (minPrice > 0 && minPrice >= price) {
                 showNotification('Minimum Price must be less than the Regular Price.');
                return;
            }

            if (imageUrl.includes('placehold.co')) {
                imageUrl = null; 
            }
            
            if (imageUrlInput && !addImageUrlContainer.classList.contains('hidden')) {
                imageUrl = imageUrlInput;
            }

            let shoeCategory = null;
            let sizeData = null; 
            let colorData = null;

            if (type === 'Shoes') {
                shoeCategory = productShoeCategory.value;
                if (!shoeCategory) {
                    showNotification('Please select a shoe category.');
                    return;
                }
                sizeData = getSizeDataFromUI(addSizeList); // Updated function
                if (sizeData === null) {
                     showNotification('Please correct invalid size/color rows before saving.');
                    return;
                }
                 if (Object.keys(sizeData).length === 0) {
                     showNotification('Please add at least one valid size/color combination for shoes.');
                     return;
                 }
            } else if (type === 'Bags') {
                colorData = getColorDataFromUI(addBagColorList);
                if (colorData === null) {
                    showNotification('Please correct invalid color rows before saving.');
                    return;
                }
                 if (Object.keys(colorData).length === 0) {
                     showNotification('Please add at least one valid color/quantity combination for bags.');
                     return;
                 }
            }

            try {
                // Image is saved as Base64 data URL directly in Firestore
                const newProduct = {
                    code,
                    name,
                    type,
                    cost,
                    price,
                    minPrice,
                    imageUrl, // This is the Base64 string or URL
                    shoeCategory, 
                    sizeData,     
                    colorData     
                };

                const newDocRef = doc(getProductsCollection());
                await setDoc(newDocRef, newProduct);
                
                addProductForm.reset();
                addProductPreview.src = 'https://placehold.co/200x200/png?text=Preview';
                toggleProductFields('', productShoeCategoryContainer, addSizeManagementContainer, addBagColorContainer);
                addSizeList.innerHTML = '';
                addBagColorList.innerHTML = '';
                addImageUrlContainer.classList.add('hidden');
                addImageUploadContainer.classList.remove('hidden');
                showNotification('Product added successfully!');
                
            } catch (error) {
                console.error("Error adding document: ", error);
                showNotification(`Failed to add product: ${error.message}`);
            }
        };

        const openEditModal = (id) => {
            const product = products.find(p => p.id === id);
            if (!product) return;

            editProductId.value = id;
            editProductCode.value = product.code || '';
            editProductName.value = product.name;
            editProductType.value = product.type;
            
            toggleProductFields(product.type, editProductShoeCategoryContainer, editSizeManagementContainer, editBagColorContainer);
            
            editSizeList.innerHTML = ''; // Clear previous
            editBagColorList.innerHTML = ''; // Clear previous
            
            if (product.type === 'Shoes') {
                editProductShoeCategory.value = product.shoeCategory || '';
                if (product.sizeData) {
                    // NEW: Nested loop for size AND color
                    Object.entries(product.sizeData).forEach(([size, colors]) => {
                        Object.entries(colors).forEach(([color, qty]) => {
                            addSizeInputRow(editSizeList, product.shoeCategory, size, color, qty);
                        });
                    });
                }
            } else if (product.type === 'Bags') {
                if (product.colorData) {
                    Object.entries(product.colorData).forEach(([color, qty]) => {
                        addBagColorRow(editBagColorList, color, qty);
                    });
                }
            }

            editProductCost.value = product.cost;
            editProductPrice.value = product.price;
            editProductMinPrice.value = product.minPrice || 0;
            
            editProductImageUrl.value = '';
            editProductImageFile.value = '';
            editImageUrlContainer.classList.add('hidden');
            editImageUploadContainer.classList.remove('hidden');
            editImageInputToggle.textContent = 'Use Image URL';
            
            editProductPreview.src = product.imageUrl || 'https://placehold.co/200x200/png?text=Preview';

            editModal.classList.remove('hidden');
        };

        const closeEditModal = () => {
            editModal.classList.add('hidden');
        };

        const handleEditProduct = async (e) => {
            e.preventDefault();
            const id = editProductId.value;
            const originalProduct = products.find(p => p.id === id);
            if (!originalProduct) return;
            
            const code = editProductCode.value.trim();
            const name = editProductName.value;
            const type = editProductType.value;
            const cost = parseFloat(editProductCost.value);
            const price = parseFloat(editProductPrice.value);
            const minPrice = parseFloat(editProductMinPrice.value) || 0;
            
            let newImageUrl = editProductPreview.src;
            const imageUrlInput = editProductImageUrl.value;
            
            if (!code || !name || !type || isNaN(cost) || isNaN(price)) {
                showNotification('Please fill in all required fields (Code, Name, Type, Cost, Price).');
                return;
            }
            
            if (minPrice > 0 && minPrice >= price) {
                 showNotification('Minimum Price must be less than the Regular Price.');
                return;
            }
            
            if (newImageUrl.includes('placehold.co')) {
                newImageUrl = originalProduct.imageUrl || null; // Keep old image if placeholder is showing
            }
            
            if (imageUrlInput && !editImageUrlContainer.classList.contains('hidden')) {
                newImageUrl = imageUrlInput;
            }

            let shoeCategory = null;
            let sizeData = null; 
            let colorData = null;

            if (type === 'Shoes') {
                shoeCategory = editProductShoeCategory.value;
                 if (!shoeCategory) {
                    showNotification('Please select a shoe category.');
                    return;
                }
                sizeData = getSizeDataFromUI(editSizeList); // Updated function
                if (sizeData === null) {
                     showNotification('Please correct invalid size/color rows before saving.');
                    return;
                }
                 if (Object.keys(sizeData).length === 0) {
                     showNotification('Shoes must have at least one size/color combination.');
                     return;
                 }
            } else if (type === 'Bags') {
                colorData = getColorDataFromUI(editBagColorList);
                if (colorData === null) {
                    showNotification('Please correct invalid color rows before saving.');
                    return;
                }
                 if (Object.keys(colorData).length === 0) {
                     showNotification('Bags must have at least one color/quantity combination.');
                     return;
                 }
            }
            
            try {
                // Image is Base64 data URL or external URL
                const updatedProduct = {
                    code,
                    name,
                    type,
                    cost,
                    price,
                    minPrice,
                    imageUrl: newImageUrl, 
                    shoeCategory,
                    sizeData,
                    colorData,
                };

                const productRef = doc(getProductsCollection(), id);
                await updateDoc(productRef, updatedProduct);
                
                closeEditModal();
                showNotification('Product updated successfully!');
            } catch (error) {
                console.error("Error updating product: ", error);
                showNotification(`Failed to update product: ${error.message}`);
            }
        };

        const handleDeleteProduct = (id) => {
            showConfirmation('Are you sure you want to delete this product?', async () => {
                try {
                    // No need to delete image if stored as Base64 in Firestore
                    const productRef = doc(getProductsCollection(), id);
                    await deleteDoc(productRef);
                    showNotification('Product deleted successfully.');
                    // UI will update via onSnapshot
                } catch (error) {
                    console.error("Error deleting product: ", error);
                    showNotification('Failed to delete product.');
                }
            });
        };


        // --- Point of Sale (POS) ---
        const renderPOS = () => {
            posGrid.innerHTML = '';
            
            let availableProducts = products.filter(p => {
                let totalStock = 0;
                if (p.type === 'Shoes' && p.sizeData) {
                    Object.values(p.sizeData).forEach(colors => {
                        Object.values(colors).forEach(qty => totalStock += qty);
                    });
                } else if (p.type === 'Bags' && p.colorData) {
                    totalStock = Object.values(p.colorData).reduce((sum, qty) => sum + qty, 0);
                }
                return totalStock > 0;
            });
            
            // --- ADDED POS FILTER LOGIC ---
            const filterText = filterPOS.value.trim().toLowerCase();
            if (filterText) {
                availableProducts = availableProducts.filter(product => {
                    // 1. Check Code
                    if (product.code && product.code.toLowerCase().includes(filterText)) {
                        return true;
                    }
                    // 2. Check Name
                    if (product.name && product.name.toLowerCase().includes(filterText)) {
                        return true;
                    }
                    // 3. Check Colors (Shoes)
                    if (product.type === 'Shoes' && product.sizeData) {
                        const hasColor = Object.values(product.sizeData).some(colors =>
                            Object.keys(colors).some(color => color.toLowerCase().includes(filterText))
                        );
                        if (hasColor) return true;
                    }
                    // 4. Check Colors (Bags)
                    if (product.type === 'Bags' && product.colorData) {
                        const hasColor = Object.keys(product.colorData).some(color => 
                            color.toLowerCase().includes(filterText)
                        );
                        if (hasColor) return true;
                    }
                    // 5. Check Type (Shoes/Bags)
                    if (product.type && product.type.toLowerCase().includes(filterText)) {
                        return true;
                    }
                    // 6. Check Shoe Category
                    if (product.shoeCategory && product.shoeCategory.toLowerCase().includes(filterText)) {
                        return true;
                    }
                    // No match
                    return false;
                });
            }
            // --- END POS FILTER LOGIC ---


            if (availableProducts.length === 0) {
                posGrid.innerHTML = `<p class="text-center p-4 col-span-full">No products available${filterText ? ' matching filter' : ''}.</p>`; // Updated message
                return;
            }

            availableProducts.forEach(product => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow-md flex flex-col justify-between';
                
                let detailsDisplay = '';
                let totalStock = 0;

                if (product.type === 'Shoes' && product.sizeData) {
                    const sizes = Object.keys(product.sizeData).sort();
                    if (sizes.length > 0) {
                        const availableSizes = sizes.filter(s => {
                            const colors = product.sizeData[s];
                            return Object.values(colors).some(qty => qty > 0);
                        });
                        detailsDisplay = `${product.shoeCategory || ''}: ${availableSizes.join(', ')}`;
                        availableSizes.forEach(s => {
                            Object.values(product.sizeData[s]).forEach(qty => totalStock += qty);
                        });
                    } else {
                        detailsDisplay = `${product.shoeCategory || ''}: No sizes`;
                    }
                } else if (product.type === 'Bags' && product.colorData) {
                    const colors = Object.keys(product.colorData).sort();
                    if (colors.length > 0) {
                        const availableColors = colors.filter(c => product.colorData[c] > 0);
                        detailsDisplay = `Colors: ${availableColors.join(', ')}`;
                        totalStock = availableColors.reduce((sum, c) => sum + product.colorData[c], 0);
                    } else {
                        detailsDisplay = `Bags: No colors`;
                    }
                }

                const placeholder = 'https://placehold.co/200x200/png?text=No+Image';
                const errorSrc = 'https://placehold.co/200x200/png?text=Bad+URL';

                card.innerHTML = `
                    <img src="${product.imageUrl || placeholder}" alt="${product.name}" class="w-full h-32 object-cover rounded-md mb-2" onerror="this.onerror=null; this.src='${errorSrc}'">
                    <h3 class="font-semibold text-lg">${product.name}</h3>
                    <p class="text-sm text-gray-500">${product.code || 'N/A'}</p>
                    <p class="text-sm text-gray-600">${detailsDisplay}</p>
                    <p class="text-lg font-bold my-2">$${parseFloat(product.price).toFixed(2)}</p>
                    <p class="text-sm text-gray-500 mb-2">Stock: ${totalStock}</p>
                    <button class="add-to-cart-btn w-full bg-green-600 text-white p-2 rounded hover:bg-green-700" data-id="${product.id}">Add to Cart</button>
                `;
                posGrid.appendChild(card);
            });
        };

        const addToCart = (id) => {
            const product = products.find(p => p.id === id);
            if (!product) return;

            if (product.type === 'Shoes') {
                if (!product.sizeData || Object.keys(product.sizeData).length === 0) {
                    showNotification('This shoe has no sizes or colors defined.');
                    return;
                }
                openShoeSelectionModal(product); // Use the combined modal
                return;
            }

            if (product.type === 'Bags') {
                 if (!product.colorData || Object.keys(product.colorData).length === 0) {
                    showNotification('This bag has no colors defined.');
                    return;
                }
                openColorModal(product); // Use the original bag color modal
                return;
            }
        };

        // --- UPDATED SHOE SELECTION MODAL ---
        const openShoeSelectionModal = (product) => {
            shoeModalProductId = product.id;
            shoeModalProductName.textContent = product.name;
            shoeRadioContainer.innerHTML = '';
            
            const sortedSizes = Object.keys(product.sizeData).sort((a, b) => parseFloat(a) - parseFloat(b)); // Sort numerically
            let hasStock = false;
            let firstRadio = true;

            sortedSizes.forEach(size => {
                const colors = product.sizeData[size];
                const availableColors = Object.entries(colors).filter(([_, qty]) => qty > 0).sort(); // Sort colors alphabetically
                
                if (availableColors.length > 0) {
                    hasStock = true;
                    // Create a container for each size
                    const sizeGroup = document.createElement('div');
                    sizeGroup.className = 'mb-3 border-b pb-2';
                    sizeGroup.innerHTML = `<h4 class="font-semibold text-gray-700">Size: ${size}</h4>`;
                    
                    availableColors.forEach(([color, stock]) => {
                        const label = document.createElement('label');
                        label.className = 'block p-2 rounded border border-gray-300 hover:bg-gray-100 cursor-pointer';
                        label.innerHTML = `
                            <input type="radio" name="select-shoe" value="${size}::${color}" class="mr-2">
                            Color: ${color} (${stock} in stock)
                        `;
                        // Auto-select the first available option
                        if (firstRadio) {
                            label.querySelector('input').checked = true;
                            firstRadio = false;
                        }
                        sizeGroup.appendChild(label);
                    });
                     shoeRadioContainer.appendChild(sizeGroup);
                }
            });
            
            if (!hasStock) {
                 showNotification('This product is out of stock for all sizes/colors.');
                 return;
            }
            
            selectShoeModal.classList.remove('hidden');
        };
        
        // --- Bag Color Selection Modal (Unchanged) ---
        const openColorModal = (product) => {
            colorModalProductId = product.id;
            colorModalProductName.textContent = product.name;
            colorRadioContainer.innerHTML = '';
            
            const sortedColors = Object.keys(product.colorData).sort();
            let hasStock = false;
            let firstRadio = true; // For auto-selecting
            
            sortedColors.forEach((color) => {
                const stock = product.colorData[color] || 0;
                if (stock > 0) {
                    hasStock = true;
                    colorRadioContainer.innerHTML += `
                        <label class="block p-2 rounded border border-gray-300 hover:bg-gray-100 cursor-pointer">
                            <input type="radio" name="select-color" value="${color}" class="mr-2" ${firstRadio ? 'checked' : ''}>
                            Color: ${color} (${stock} in stock)
                        </label>
                    `;
                     firstRadio = false; // Only check the very first one
                }
            });
            
            if (!hasStock) {
                 showNotification('This product is out of stock for all colors.');
                 return;
            }
            
            selectColorModal.classList.remove('hidden');
        };

        // --- UPDATED Shoe Selection Handler ---
        const handleShoeSelection = () => {
            const product = products.find(p => p.id === shoeModalProductId);
            const selectedShoeInput = document.querySelector('input[name="select-shoe"]:checked');
            
            if (!product || !selectedShoeInput) {
                showNotification('Please select a size and color.');
                return;
            }

            const [selectedSize, selectedColor] = selectedShoeInput.value.split('::');
            const cartId = `${product.id}-${selectedSize}-${selectedColor}`; // More specific cart ID
            
            const itemInCart = cart.find(item => item.cartId === cartId);
            const currentStock = (product.sizeData[selectedSize] && product.sizeData[selectedSize][selectedColor]) ? product.sizeData[selectedSize][selectedColor] : 0;
            const cartQuantity = itemInCart ? itemInCart.quantity : 0;

            if (cartQuantity >= currentStock) {
                showNotification('Not enough stock for this size/color!');
                return;
            }

            if (itemInCart) {
                itemInCart.quantity++;
            } else {
                // Ensure all necessary properties are added, especially selectedSize and selectedColor
                cart.push({ 
                    ...product, 
                    quantity: 1, 
                    cartId: cartId, 
                    selectedSize: selectedSize, 
                    selectedColor: selectedColor, 
                    priceUsed: product.price 
                });
            }
            
            renderCart();
            selectShoeModal.classList.add('hidden');
            shoeModalProductId = null;
        };

        // --- Bag Color Selection Handler (Unchanged) ---
        const handleColorSelection = () => {
            const product = products.find(p => p.id === colorModalProductId);
            const selectedColorInput = document.querySelector('input[name="select-color"]:checked');
            
            if (!product || !selectedColorInput) {
                showNotification('Please select a color.');
                return;
            }

            const selectedColor = selectedColorInput.value;
            const cartId = product.id + '-' + selectedColor;
            
            const itemInCart = cart.find(item => item.cartId === cartId);
            const currentStockForColor = product.colorData[selectedColor] || 0;
            const cartQuantity = itemInCart ? itemInCart.quantity : 0;

            if (cartQuantity >= currentStockForColor) {
                showNotification('Not enough stock for this color!');
                return;
            }

            if (itemInCart) {
                itemInCart.quantity++;
            } else {
                cart.push({ ...product, quantity: 1, cartId: cartId, selectedColor: selectedColor, selectedSize: null, priceUsed: product.price }); // Added selectedSize: null
            }
            
            renderCart();
            selectColorModal.classList.add('hidden');
            colorModalProductId = null;
        };


        const removeFromCart = (cartId) => {
            const itemIndex = cart.findIndex(item => item.cartId === cartId);
            if (itemIndex > -1) {
                cart[itemIndex].quantity--;
                if (cart[itemIndex].quantity === 0) {
                    cart.splice(itemIndex, 1);
                }
            }
            renderCart();
        };

        // --- UPDATED Cart Rendering ---
        const renderCart = () => {
            cartItems.innerHTML = '';
            let total = 0;

            if (cart.length === 0) {
                cartItems.innerHTML = `<li class="text-center text-gray-500 my-4">Cart is empty</li>`;
                cartTotal.textContent = '$0.00';
                return;
            }

            cart.forEach(item => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center py-2 border-b';
                
                let detailsDisplay = '';
                if (item.type === 'Shoes') detailsDisplay = `(Size: ${item.selectedSize}, Color: ${item.selectedColor})`;
                if (item.type === 'Bags') detailsDisplay = `(Color: ${item.selectedColor})`;

                const originalPrice = parseFloat(item.price).toFixed(2);
                const priceUsed = parseFloat(item.priceUsed).toFixed(2);
                const minPrice = item.minPrice ? parseFloat(item.minPrice).toFixed(2) : null;
                
                let priceDisplay = `<span class="text-sm text-gray-600 block">($${priceUsed} ea.)</span>`;
                let priceButton = '';
                
                if (minPrice && minPrice < originalPrice && parseFloat(minPrice) > 0) { // Ensure minPrice is valid
                    if (priceUsed === originalPrice) {
                        priceButton = `<button class="toggle-price-btn text-xs text-blue-600 hover:underline" data-id="${item.cartId}">Use Min Price ($${minPrice})</button>`;
                    } else {
                        priceButton = `<button class="toggle-price-btn text-xs text-red-600 hover:underline" data-id="${item.cartId}">Use Regular Price ($${originalPrice})</button>`;
                    }
                }
                
                li.innerHTML = `
                    <div class="flex-1 mr-2">
                        <span class="font-medium">${item.name} ${detailsDisplay}</span>
                        ${priceDisplay}
                        ${priceButton}
                    </div>
                    <div class="flex items-center">
                        <span class="font-medium mr-2">x ${item.quantity}</span>
                        <button class="remove-from-cart-btn bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center flex-shrink-0" data-id="${item.cartId}">-</button>
                    </div>
                `;
                cartItems.appendChild(li);
                total += item.priceUsed * item.quantity;
            });
            cartTotal.textContent = `$${total.toFixed(2)}`;
        };
        
        const updateCheckoutTotals = () => {
            const subtotal = cart.reduce((sum, item) => sum + (item.priceUsed * item.quantity), 0);
            const discountPercent = parseFloat(discountPercentage.value) || 0;
            const discountAmountValue = (subtotal * (discountPercent / 100));
            const finalTotal = Math.max(0, subtotal - discountAmountValue);

            checkoutSubtotalAmount.textContent = `$${subtotal.toFixed(2)}`;
            checkoutTotalAmount.textContent = `$${finalTotal.toFixed(2)}`;
        };

        const openCheckoutModal = () => {
            if (cart.length === 0) {
                showNotification('Cart is empty.');
                return;
            }
            discountPercentage.value = ''; // Clear discount
            updateCheckoutTotals(); // Calculate totals
            paymentMethod.value = 'Cash'; // Reset to default
            checkoutModal.classList.remove('hidden');
        };

        const closeCheckoutModal = () => {
            checkoutModal.classList.add('hidden');
        };

        // --- UPDATED Handle Sale for Shoe Colors ---
        const handleSale = async () => {
            if (cart.length === 0) {
                showNotification('Cart is empty.');
                return;
            }

            const payment = paymentMethod.value;
            if (!payment) {
                showNotification('Please select a payment method.');
                return;
            }
            
            const subtotal = cart.reduce((sum, item) => sum + (item.priceUsed * item.quantity), 0);
            const discountPercent = parseFloat(discountPercentage.value) || 0;
            const discountAmountValue = (subtotal * (discountPercent / 100));
            const finalTotal = Math.max(0, subtotal - discountAmountValue);

            const saleRecord = {
                items: cart.map(item => ({
                    id: item.id,
                    code: item.code,
                    name: item.name,
                    price: item.priceUsed, // Price actually paid
                    cost: item.cost,       // Original cost
                    quantity: item.quantity,
                    type: item.type,
                    selectedSize: item.selectedSize || null,
                    selectedColor: item.selectedColor || null,
                    imageUrl: item.imageUrl || null,
                    returned: false
                })),
                subtotal: subtotal,
                discount: discountAmountValue, 
                discountPercentage: discountPercent, 
                total: finalTotal,
                payment: payment,
                date: new Date().toISOString()
            };

            try {
                await runTransaction(db, async (transaction) => {
                    
                    const productUpdates = {}; // Track updates per product ID

                    for (const item of cart) {
                        const productId = item.id;
                        if (!productUpdates[productId]) {
                            // Fetch product data if not already fetched in this transaction
                            const ref = doc(getProductsCollection(), productId);
                            const pDoc = await transaction.get(ref);
                            if (!pDoc.exists()) throw new Error(`Product with ID ${productId} not found.`);
                            productUpdates[productId] = { ref: ref, data: pDoc.data() };
                        }

                        const productData = productUpdates[productId].data;

                        if (item.type === 'Bags') {
                            if (!productData.colorData || productData.colorData[item.selectedColor] === undefined) {
                                throw new Error(`Stock data missing for ${item.name} (Color: ${item.selectedColor}).`);
                            }
                            const newQuantityForColor = productData.colorData[item.selectedColor] - item.quantity;
                            if (newQuantityForColor < 0) throw new Error(`Not enough stock for ${item.name} (Color: ${item.selectedColor}).`);
                            productData.colorData[item.selectedColor] = newQuantityForColor;
                        
                        } else if (item.type === 'Shoes') {
                             if (!productData.sizeData || !productData.sizeData[item.selectedSize] || productData.sizeData[item.selectedSize][item.selectedColor] === undefined) {
                                throw new Error(`Stock data missing for ${item.name} (Size: ${item.selectedSize}, Color: ${item.selectedColor}).`);
                            }
                            const newQuantity = productData.sizeData[item.selectedSize][item.selectedColor] - item.quantity;
                            if (newQuantity < 0) throw new Error(`Not enough stock for ${item.name} (Size: ${item.selectedSize}, Color: ${item.selectedColor}).`);
                            productData.sizeData[item.selectedSize][item.selectedColor] = newQuantity;
                        }
                    }

                    // Apply all updates
                    for (const productId in productUpdates) {
                        const update = productUpdates[productId];
                        transaction.update(update.ref, { 
                            sizeData: update.data.sizeData, 
                            colorData: update.data.colorData 
                        });
                    }

                    // Add the sale record
                    const salesRef = getSalesCollection(); 
                    transaction.set(doc(salesRef), saleRecord);
                });

                cart = [];
                renderCart();
                closeCheckoutModal();
                showNotification("Sale successful!");

            } catch (error) {
                console.error("Transaction failed: ", error);
                showNotification(`Sale failed: ${error.message}`);
            }
        };


        // --- Sales History (UPDATED for Shoe Colors) ---
        const renderSalesHistory = () => {
            salesTableBody.innerHTML = '';
            const placeholder = 'https://placehold.co/100x100/png?text=No+Image';
            
            const filterDate = filterSalesDate.value; // YYYY-MM-DD
            
            const filteredSales = filterDate 
                ? salesHistory.filter(sale => sale.date.startsWith(filterDate)) 
                : salesHistory;

            if (filteredSales.length === 0) {
                salesTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4">No sales history${filterDate ? ' for this date' : ''}.</td></tr>`;
            } else {
                filteredSales.forEach(sale => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b';
                    
                    let itemDetails = sale.items.map((item, index) => {
                        let detail = '';
                        if(item.type === 'Shoes') detail = `(Size: ${item.selectedSize}, Color: ${item.selectedColor})`; // Updated
                        if(item.type === 'Bags') detail = `(Color: ${item.selectedColor})`;
                        
                        let returnButton = '';
                        // Allow return if user is admin OR sales
                        if (!item.returned && (currentUserRole === 'admin' || currentUserRole === 'sales')) { 
                            returnButton = `<button class="return-item-btn text-xs bg-blue-500 text-white py-1 px-2 rounded hover:bg-blue-600 ml-4" data-sale-id="${sale.id}" data-item-index="${index}">Return</button>`;
                        } else if (item.returned) {
                            returnButton = `<span class="text-xs text-gray-500 ml-4">(Returned)</span>`;
                        } else {
                            returnButton = ''; // No button if neither admin nor sales
                        }

                        return `
                            <li class="flex items-center justify-between py-1">
                                <div class="flex items-center">
                                    <img src="${item.imageUrl || placeholder}" class="w-8 h-8 object-cover rounded mr-2" alt="${item.name}" onerror="this.onerror=null; this.src='${placeholder}'">
                                    <span>${item.name} ${detail} (x${item.quantity})</span>
                                </div>
                                ${returnButton}
                            </li>
                        `;
                    }).join('');

                    let totalDisplay = `$${sale.total.toFixed(2)}`;
                    if (sale.discount > 0) {
                        const discountDisplay = sale.discountPercentage 
                            ? `Disc: $${sale.discount.toFixed(2)} (${sale.discountPercentage}%)` 
                            : `Disc: $${sale.discount.toFixed(2)}`;
                        totalDisplay += `<br><span class="text-xs text-red-500">(Sub: $${sale.subtotal.toFixed(2)}, ${discountDisplay})</span>`;
                    }

                    tr.innerHTML = `
                        <td class="p-3">${new Date(sale.date).toLocaleString()}</td>
                        <td class="p-3">
                            <ul class="list-none">
                                ${itemDetails}
                            </ul>
                        </td>
                        <td class="p-3">${sale.payment}</td>
                        <td class="p-3">${totalDisplay}</td>
                    `;
                    salesTableBody.appendChild(tr);
                });
            }

            // --- CRITICAL FIX FOR RETURN CALCULATION ---
            let totalSales = 0;
            let totalProfit = 0;
            let monthlyTotal = 0;
            let dailyTotal = 0;
            const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
            const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD for daily calculation

            // Calculate daily total based on filter (excluding returns)
            filteredSales.forEach(sale => {
                if (filterDate && sale.date.startsWith(filterDate)) { // Ensure filtering works correctly
                    let saleTotalForDay = 0;
                    sale.items.forEach(item => {
                        if (!item.returned) {
                            saleTotalForDay += (item.price * item.quantity); // Use actual sale price
                        }
                    });
                     // Subtract discount ONLY for non-returned sales on that day
                    if (saleTotalForDay > 0) { // Only subtract if there were non-returned items
                         saleTotalForDay = Math.max(0, saleTotalForDay - (sale.discount || 0));
                    }
                    dailyTotal += saleTotalForDay;
                }
            });
            
            // Calculate monthly and summary totals (excluding returns)
            salesHistory.forEach(sale => {
                let saleTotalForNonReturned = 0;
                let saleProfitForNonReturned = 0;
                
                sale.items.forEach(item => {
                    if (!item.returned) {
                         const itemSalePrice = item.price || 0; // Price actually sold at
                         const itemCost = item.cost || 0; // Cost of the item
                        saleTotalForNonReturned += (itemSalePrice * item.quantity);
                        const profitPerItem = itemSalePrice - itemCost; 
                        saleProfitForNonReturned += (profitPerItem * item.quantity);
                    }
                });

                // Subtract discount from sales total, but not from profit calculation
                 if (saleTotalForNonReturned > 0) {
                     saleTotalForNonReturned = Math.max(0, saleTotalForNonReturned - (sale.discount || 0));
                 }

                totalSales += saleTotalForNonReturned;
                totalProfit += saleProfitForNonReturned; // Profit is before discount
                
                if (sale.date.startsWith(currentMonth)) {
                    monthlyTotal += saleTotalForNonReturned;
                }
            });

            salesSummaryEl.textContent = `Total Sales: $${totalSales.toFixed(2)} | Total Profit: $${totalProfit.toFixed(2)}`;
            monthlyTotalEl.textContent = `This Month's Total: $${monthlyTotal.toFixed(2)}`; // Always show month total
            dailyTotalEl.textContent = filterDate ? `Total for ${filterDate}: $${dailyTotal.toFixed(2)}` : ''; // Only show if filtered
            dailyTotalEl.classList.toggle('hidden', !filterDate);
        };
        
        /**
         * Handles returning a single item from a sale to stock.
         */
        const handleReturnItem = (saleId, itemIndex) => {
             // Allow return if user is admin OR sales
            if (currentUserRole !== 'admin' && currentUserRole !== 'sales') {
                showNotification("You do not have permission to return items.");
                return;
            }

            showConfirmation("Are you sure you want to return this item to stock? This will adjust inventory and cannot be undone.", async () => {
                try {
                    await runTransaction(db, async (transaction) => {
                        const saleDocRef = doc(getSalesCollection(), saleId);
                        const saleDoc = await transaction.get(saleDocRef);
                        if (!saleDoc.exists()) throw new Error("Sale not found.");

                        let saleData = saleDoc.data();
                        
                        if (itemIndex < 0 || itemIndex >= saleData.items.length) throw new Error("Item index out of bounds.");
                        const itemToReturn = saleData.items[itemIndex];
                        if (itemToReturn.returned) throw new Error("This item has already been returned.");
                        
                        const productDocRef = doc(getProductsCollection(), itemToReturn.id);
                        const productDoc = await transaction.get(productDocRef);
                        if (!productDoc.exists()) throw new Error("Product not found. Cannot return stock.");
                        
                        let productData = productDoc.data();

                        // Add the quantity back to the correct size/color
                        if (itemToReturn.type === 'Shoes') {
                            const size = itemToReturn.selectedSize;
                            const color = itemToReturn.selectedColor; 
                            
                            if (!productData.sizeData) productData.sizeData = {};
                            if (!productData.sizeData[size]) productData.sizeData[size] = {};
                            
                            if (productData.sizeData[size][color] !== undefined) {
                                productData.sizeData[size][color] += itemToReturn.quantity;
                            } else {
                                productData.sizeData[size][color] = itemToReturn.quantity; // Add it back if it didn't exist
                            }
                        } else if (itemToReturn.type === 'Bags') {
                            const color = itemToReturn.selectedColor;
                            if (productData.colorData && productData.colorData[color] !== undefined) {
                                productData.colorData[color] += itemToReturn.quantity;
                            } else {
                                if (!productData.colorData) productData.colorData = {};
                                productData.colorData[color] = itemToReturn.quantity; // Add it back if it didn't exist
                            }
                        }
                        
                        // Mark the item as returned in the sale
                        saleData.items[itemIndex].returned = true;
                        
                        // Commit changes
                        transaction.update(productDocRef, { 
                            sizeData: productData.sizeData, 
                            colorData: productData.colorData 
                        });
                        transaction.update(saleDocRef, { items: saleData.items });
                    });
                    
                    showNotification("Item returned to stock successfully.");
                    // The onSnapshot listener for sales will automatically refresh the UI
                    
                } catch (error) {
                    console.error("Return failed:", error);
                    showNotification(`Return failed: ${error.message}`);
                }
            });
        };

        // --- User Management ---
        const renderUserList = () => {
            userListTableBody.innerHTML = '';
            
            // Add root accounts (read-only)
            Object.keys(rootAccounts).forEach(username => {
                const acc = rootAccounts[username];
                const tr = document.createElement('tr');
                tr.className = 'border-b bg-gray-50';
                tr.innerHTML = `
                    <td class="p-3 font-medium">${username} (Root)</td>
                    <td class="p-3">${acc.role}</td>
                    <td class="p-3 text-sm text-gray-500">Cannot be deleted</td>
                `;
                userListTableBody.appendChild(tr);
            });
            
            // Add managed accounts
            if (userAccounts.length === 0) {
                 // Do nothing if only root accounts exist
            } else {
                 userAccounts.forEach(acc => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="p-3 font-medium">${acc.id}</td>
                        <td class="p-3">${acc.role}</td>
                        <td class="p-3">
                            <button class="delete-user-btn p-2 bg-red-600 text-white rounded hover:bg-red-700" data-id="${acc.id}">Delete</button>
                        </td>
                    `;
                    userListTableBody.appendChild(tr);
                });
            }
             // Add message if no managed accounts yet
            if (userAccounts.length === 0) {
                userListTableBody.innerHTML += `<tr><td colspan="3" class="text-center p-4 text-gray-500">No additional accounts created yet.</td></tr>`;
            }
        };
        
        const handleAddUser = async (e) => {
            e.preventDefault();
            const username = newUsername.value.trim(); // Trim whitespace
            const password = newPassword.value;
            const role = newRole.value;
            
            if (!username || !password || !role) {
                showNotification("Please fill in all fields.");
                return;
            }
            
             if (username.length < 3) {
                 showNotification("Username must be at least 3 characters long.");
                 return;
            }

             if (password.length < 6) {
                 showNotification("Password must be at least 6 characters long.");
                 return;
            }

            if (rootAccounts[username]) {
                showNotification("This username is reserved for a root account.");
                return;
            }
            
            try {
                const userDocRef = doc(getUsersCollection(), username);
                
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    showNotification("This username already exists.");
                    return;
                }
                
                await setDoc(userDocRef, {
                    password: password, // In a real app, hash this!
                    role: role
                });
                
                showNotification(`User '${username}' created successfully.`);
                addUserForm.reset();
                
            } catch (error) {
                console.error("Error adding user:", error);
                showNotification("Failed to create user.");
            }
        };
        
        const handleDeleteUser = (username) => {
            if (rootAccounts[username]) {
                showNotification("Cannot delete root accounts.");
                return;
            }
            
            showConfirmation(`Are you sure you want to delete the user '${username}'?`, async () => {
                try {
                    const userDocRef = doc(getUsersCollection(), username);
                    await deleteDoc(userDocRef);
                    showNotification(`User '${username}' deleted.`);
                } catch (error) {
                    console.error("Error deleting user:", error);
                    showNotification("Failed to delete user.");
                }
            });
        };


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Get Modal elements
            notificationModal = document.getElementById('notificationModal');
            notificationMessage = document.getElementById('notificationMessage');
            notificationCloseBtn = document.getElementById('notificationCloseBtn');
            confirmationModal = document.getElementById('confirmationModal');
            confirmationMessage = document.getElementById('confirmationMessage');
            confirmationCancelBtn = document.getElementById('confirmationCancelBtn');
            confirmationConfirmBtn = document.getElementById('confirmationConfirmBtn');
            
            // Auth
            loginButton.addEventListener('click', handleLogin);
            logoutButton.addEventListener('click', handleLogout);
            initAuth(); // Start auth process

            // Navigation
            navLinks.forEach(link => {
                link.addEventListener('click', () => showPage(link.dataset.page));
            });
            
            // --- Inventory Form Logic ---
            addProductForm.addEventListener('submit', handleAddProduct);
            
            productType.addEventListener('change', () => {
                const type = productType.value;
                toggleProductFields(type, productShoeCategoryContainer, addSizeManagementContainer, addBagColorContainer);
                productShoeCategory.value = '';
                addSizeList.innerHTML = '';
                addBagColorList.innerHTML = '';
                 // Add an initial row if relevant type is selected
                if (type === 'Shoes' && productShoeCategory.value) {
                     addSizeInputRow(addSizeList, productShoeCategory.value);
                } else if (type === 'Bags') {
                    addBagColorRow(addBagColorList);
                }
            });

            productShoeCategory.addEventListener('change', () => {
                addSizeList.innerHTML = '';
                if (productShoeCategory.value) {
                    addSizeInputRow(addSizeList, productShoeCategory.value); // Add first row automatically
                }
            });

            document.getElementById('addSizeBtn').addEventListener('click', () => {
                const category = productShoeCategory.value;
                if (!category) {
                    showNotification('Please select a shoe category first.');
                    return;
                }
                addSizeInputRow(addSizeList, category);
            });
            
            document.getElementById('addBagColorBtn').addEventListener('click', () => {
                addBagColorRow(addBagColorList);
            });


            // Image input toggle (Add)
            addImageInputToggle.addEventListener('click', () => {
                const isUploadVisible = !addImageUploadContainer.classList.contains('hidden');
                if (isUploadVisible) {
                    addImageUploadContainer.classList.add('hidden');
                    addImageUrlContainer.classList.remove('hidden');
                    addImageInputToggle.textContent = 'Upload File Instead';
                    addProductImageUrl.value = ''; // Clear URL input
                    addProductPreview.src = 'https://placehold.co/200x200/png?text=Preview'; // Reset preview
                    productImageFile.value = ''; // Clear file input
                } else {
                    addImageUploadContainer.classList.remove('hidden');
                    addImageUrlContainer.classList.add('hidden');
                    addImageInputToggle.textContent = 'Use Image URL Instead';
                    productImageFile.value = ''; // Clear file input
                    addProductPreview.src = 'https://placehold.co/200x200/png?text=Preview'; // Reset preview
                    addProductImageUrl.value = ''; // Clear URL input
                }
            });
            
            productImageFile.addEventListener('change', async (e) => {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    try {
                        const compressedBase64 = await compressImage(file);
                        addProductPreview.src = compressedBase64;
                    } catch (error) {
                        console.error("Failed to preview/compress image:", error);
                        showNotification("Failed to preview image. File might be corrupted.");
                        addProductPreview.src = 'https://placehold.co/200x200/png?text=Preview';
                        productImageFile.value = ''; 
                    }
                } else {
                    addProductPreview.src = 'https://placehold.co/200x200/png?text=Preview'; // Reset if no file selected
                }
            });
            addProductImageUrl.addEventListener('input', () => {
                 addProductPreview.src = addProductImageUrl.value || 'https://placehold.co/200x200/png?text=Preview';
            });
             // Add error handling for external URLs
            addProductImageUrl.addEventListener('blur', () => {
                const url = addProductImageUrl.value.trim();
                if (url) {
                    const img = new Image();
                    img.onload = () => { addProductPreview.src = url; }; // Only update if valid
                    img.onerror = () => { 
                        showNotification('Invalid image URL or image cannot be accessed.');
                        addProductPreview.src = 'https://placehold.co/200x200/png?text=Bad+URL';
                    };
                    img.src = url;
                } else {
                    addProductPreview.src = 'https://placehold.co/200x200/png?text=Preview';
                }
            });


            // Inventory Table (Event Delegation)
            inventoryTableBody.addEventListener('click', (e) => {
                if (e.target.closest('.edit-btn')) {
                    openEditModal(e.target.closest('.edit-btn').dataset.id);
                }
                if (e.target.closest('.delete-btn')) {
                    handleDeleteProduct(e.target.closest('.delete-btn').dataset.id);
                }
            });
            
            // --- Inventory Filter ---
            filterInventory.addEventListener('input', renderInventory); // Filter as user types
             clearInventoryFilter.addEventListener('click', () => {
                filterInventory.value = '';
                renderInventory();
             });

            // --- Edit Modal Logic ---
            saveEditButton.addEventListener('click', handleEditProduct);
            cancelEditButton.addEventListener('click', closeEditModal);

            editProductType.addEventListener('change', () => {
                toggleProductFields(editProductType.value, editProductShoeCategoryContainer, editSizeManagementContainer, editBagColorContainer);
                editProductShoeCategory.value = '';
                editSizeList.innerHTML = '';
                editBagColorList.innerHTML = '';
                 // Automatically add a row if type selected
                 if (editProductType.value === 'Shoes' && editProductShoeCategory.value) {
                     addSizeInputRow(editSizeList, editProductShoeCategory.value);
                 } else if (editProductType.value === 'Bags') {
                     addBagColorRow(editBagColorList);
                 }
            });

            editProductShoeCategory.addEventListener('change', () => {
                editSizeList.innerHTML = ''; // Clear existing rows when category changes
                if (editProductShoeCategory.value) {
                    addSizeInputRow(editSizeList, editProductShoeCategory.value); // Add first row
                }
            });
            
            document.getElementById('editAddSizeBtn').addEventListener('click', () => {
                const category = editProductShoeCategory.value;
                if (!category) {
                    showNotification('Please select a shoe category first.');
                    return;
                }
                addSizeInputRow(editSizeList, category);
            });
            
            document.getElementById('editAddBagColorBtn').addEventListener('click', () => {
                addBagColorRow(editBagColorList);
            });

            // Image input toggle (Edit)
            editImageInputToggle.addEventListener('click', () => {
                const isUploadVisible = !editImageUploadContainer.classList.contains('hidden');
                if (isUploadVisible) {
                    editImageUploadContainer.classList.add('hidden');
                    editImageUrlContainer.classList.remove('hidden');
                    editImageInputToggle.textContent = 'Upload File Instead';
                    editProductImageUrl.value = ''; // Clear URL input
                    editProductImageFile.value = ''; // Clear file input
                    // Don't reset preview immediately, wait for URL input or blur
                } else {
                    editImageUploadContainer.classList.remove('hidden');
                    editImageUrlContainer.classList.add('hidden');
                    editImageInputToggle.textContent = 'Use Image URL Instead';
                    editProductImageFile.value = ''; // Clear file input
                    editProductImageUrl.value = ''; // Clear URL input
                    // Preview will be updated by file input change or URL blur
                }
            });

            editProductImageFile.addEventListener('change', async (e) => {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                     try {
                        const compressedBase64 = await compressImage(file);
                        editProductPreview.src = compressedBase64;
                    } catch (error) {
                        console.error("Failed to preview/compress image:", error);
                        showNotification("Failed to preview image. File might be corrupted.");
                        // Keep the original image on failure
                        const productId = editProductId.value;
                        const product = products.find(p => p.id === productId);
                        editProductPreview.src = (product && product.imageUrl) || 'https://placehold.co/200x200/png?text=Preview';
                        editProductImageFile.value = ''; 
                    }
                }
            });
            editProductImageUrl.addEventListener('input', () => {
                 editProductPreview.src = editProductImageUrl.value || 'https://placehold.co/200x200/png?text=Preview';
            });
             // Add error handling for external URLs
            editProductImageUrl.addEventListener('blur', () => {
                const url = editProductImageUrl.value.trim();
                if (url) {
                    const img = new Image();
                    img.onload = () => { editProductPreview.src = url; }; // Only update if valid
                    img.onerror = () => { 
                        showNotification('Invalid image URL or image cannot be accessed.');
                        editProductPreview.src = 'https://placehold.co/200x200/png?text=Bad+URL';
                    };
                    img.src = url;
                } else {
                    // If URL is empty, try to show original image or placeholder
                     const productId = editProductId.value;
                     const product = products.find(p => p.id === productId);
                    editProductPreview.src = (product && product.imageUrl) || 'https://placehold.co/200x200/png?text=Preview';
                }
            });

            // POS (Event Delegation)
            posGrid.addEventListener('click', (e) => {
                if (e.target.closest('.add-to-cart-btn')) {
                    addToCart(e.target.closest('.add-to-cart-btn').dataset.id);
                }
            });

            // --- ADDED POS FILTER LISTENERS ---
            filterPOS.addEventListener('input', renderPOS);
            clearPOSFilter.addEventListener('click', () => {
                filterPOS.value = '';
                renderPOS();
            });

            // Cart (Event Delegation)
            cartItems.addEventListener('click', (e) => {
                if (e.target.closest('.remove-from-cart-btn')) {
                    removeFromCart(e.target.closest('.remove-from-cart-btn').dataset.id);
                }
                
                if (e.target.closest('.toggle-price-btn')) {
                    const cartId = e.target.closest('.toggle-price-btn').dataset.id;
                    const itemInCart = cart.find(item => item.cartId === cartId);
                    if (!itemInCart) return;
                    
                    const originalPrice = itemInCart.price;
                    const minPrice = itemInCart.minPrice || originalPrice;
                    
                    if (itemInCart.priceUsed === originalPrice) {
                        itemInCart.priceUsed = minPrice;
                    } else {
                        itemInCart.priceUsed = originalPrice;
                    }
                    renderCart();
                }
            });
            
            checkoutButton.addEventListener('click', openCheckoutModal);
            clearCartButton.addEventListener('click', () => {
                cart = [];
                renderCart();
            });

            // Checkout Modal
            discountPercentage.addEventListener('input', updateCheckoutTotals); 
            confirmSaleButton.addEventListener('click', handleSale);
            cancelSaleButton.addEventListener('click', closeCheckoutModal);

            // Shoe Selection Modal
            confirmShoeButton.addEventListener('click', handleShoeSelection);
            cancelShoeButton.addEventListener('click', () => {
                selectShoeModal.classList.add('hidden');
            });
            
            // Color Selection Modal (Bags)
            confirmColorButton.addEventListener('click', handleColorSelection);
            cancelColorButton.addEventListener('click', () => {
                selectColorModal.classList.add('hidden');
            });


            // Modal Listeners
            notificationCloseBtn.addEventListener('click', hideNotification);
            confirmationCancelBtn.addEventListener('click', hideConfirmation);
            confirmationConfirmBtn.addEventListener('click', handleConfirm);

            // Sales
            filterSalesDate.addEventListener('input', renderSalesHistory);
            clearSalesDate.addEventListener('click', () => {
                filterSalesDate.value = '';
                renderSalesHistory();
            });
            
            salesTableBody.addEventListener('click', (e) => {
                const returnBtn = e.target.closest('.return-item-btn');
                if (returnBtn) {
                    const saleId = returnBtn.dataset.saleId;
                    const itemIndex = parseInt(returnBtn.dataset.itemIndex, 10);
                    handleReturnItem(saleId, itemIndex);
                }
            });
            
            // User Management
            addUserForm.addEventListener('submit', handleAddUser);
            userListTableBody.addEventListener('click', (e) => {
                if (e.target.closest('.delete-user-btn')) {
                    handleDeleteUser(e.target.closest('.delete-user-btn').dataset.id);
                }
            });
        });
    </script>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Global Loading Spinner -->
    <div id="loadingSpinner" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <div class="w-16 h-16 border-4 border-t-indigo-600 border-gray-200 rounded-full animate-spin"></div>
    </div>

    <!-- Login Section -->
    <section id="loginSection" class="flex items-center justify-center min-h-screen hidden">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-sm">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Mony Store</h2>
            <form id="loginForm" onsubmit="return false;">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button id="loginButton" type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50">
                    Login
                </button>
                <p id="loginError" class="text-red-500 text-sm mt-4 text-center hidden"></p>
            </form>
        </div>
    </section>

    <!-- Main App Section -->
    <section id="appSection" class="hidden">
        <!-- Header -->
        <header class="bg-gray-800 text-white shadow-md">
            <nav class="container mx-auto px-4 py-3">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <!-- NEW: Logo and Title -->
                    <div class="flex items-center justify-center md:justify-start mb-2 md:mb-0">
                        <!-- LOGO FIX: Use a placeholder or your image data URL -->
                        <div id="appLogo" class="h-10 w-10 mr-3 rounded-full bg-indigo-600 flex items-center justify-center font-bold text-white text-lg flex-shrink-0">
                            MS <!-- Placeholder, replace if using img tag -->
                        </div>
                        <h1 class="text-2xl font-bold">Mony Store</h1>
                    </div>
                    <div class="flex flex-col md:flex-row md:items-center md:space-x-2">
                        <button class="nav-link py-2 px-4 rounded-md hover:bg-gray-700 w-full md:w-auto" data-page="inventoryPage">Inventory</button>
                        <button class="nav-link py-2 px-4 rounded-md hover:bg-gray-700 w-full md:w-auto mt-2 md:mt-0" data-page="posPage">Point of Sale</button>
                        <button class="nav-link py-2 px-4 rounded-md hover:bg-gray-700 w-full md:w-auto mt-2 md:mt-0" data-page="salesPage">Sales History</button>
                        <button class="nav-link py-2 px-4 rounded-md hover:bg-gray-700 w-full md:w-auto mt-2 md:mt-0" data-page="usersPage">User Management</button>
                        <button id="logoutButton" class="py-2 px-4 rounded-md bg-red-600 hover:bg-red-700 w-full md:w-auto mt-2 md:mt-0">Logout</button>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto p-4">

            <!-- Inventory Page -->
            <div id="inventoryPage" class="page">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Inventory Management</h2>
                
                <!-- Add Product Form -->
                <form id="addProductForm" onsubmit="return false;" class="bg-white p-6 rounded-lg shadow-md mb-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <h3 class="text-xl font-semibold mb-2 col-span-full">Add New Product</h3>
                    
                    <div>
                        <label for="productCode" class="block text-sm font-medium text-gray-700">Item Code (SKU)</label>
                        <input type="text" id="productCode" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="productName" class="block text-sm font-medium text-gray-700">Product Name</label>
                        <input type="text" id="productName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="productType" class="block text-sm font-medium text-gray-700">Product Type</label>
                        <select id="productType" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                            <option value="">Select Type</option>
                            <option value="Shoes">Shoes</option>
                            <option value="Bags">Bags</option>
                        </select>
                    </div>

                    <div>
                        <label for="productCost" class="block text-sm font-medium text-gray-700">Cost (Buy Price)</label>
                        <input type="number" id="productCost" step="0.01" min="0" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="productPrice" class="block text-sm font-medium text-gray-700">Price (Sell Price)</label>
                        <input type="number" id="productPrice" step="0.01" min="0" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="productMinPrice" class="block text-sm font-medium text-gray-700">Min. Sell Price (Optional)</label>
                        <input type="number" id="productMinPrice" step="0.01" min="0" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>

                    <div id="productShoeCategoryContainer" class="hidden">
                        <label for="productShoeCategory" class="block text-sm font-medium text-gray-700">Shoe Category</label>
                        <select id="productShoeCategory" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            <option value="">Select Category</option>
                            <option value="Baby">Baby (18-22)</option>
                            <option value="Kid">Kid (22-36)</option>
                            <option value="Adult">Adult (36-46)</option>
                        </select>
                    </div>
                    
                    <div class="flex flex-col items-center col-span-1 md:col-span-2 lg:col-span-1">
                        <label class="block text-sm font-medium text-gray-700">Product Image</label>
                        <img id="addProductPreview" src="https://placehold.co/200x200/png?text=Preview" alt="Product Preview" class="w-24 h-24 object-cover rounded-md my-2 border">
                        
                        <div id="addImageUploadContainer">
                            <input type="file" id="productImageFile" accept="image/*" class="text-sm w-full">
                        </div>
                        <div id="addImageUrlContainer" class="hidden w-full">
                            <input type="url" id="productImageUrl" placeholder="Paste image URL here" class="mt-1 block w-full text-sm border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        
                        <button type="button" id="addImageInputToggle" class="text-xs text-blue-600 hover:underline mt-1">Use Image URL Instead</button>
                    </div>

                    <!-- UPDATED: Shoe Size/Color/Qty Management -->
                    <div id="addSizeManagementContainer" class="hidden col-span-full md:col-span-2 lg:col-span-1 border p-4 rounded-md">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Shoe Size, Color & Quantity</label>
                        <div id="addSizeList" class="max-h-48 overflow-y-auto mb-2">
                            <!-- Rows will be added here -->
                        </div>
                        <button type="button" id="addSizeBtn" class="w-full bg-blue-500 text-white py-1 px-3 rounded-lg shadow hover:bg-blue-600 text-sm">+ Add Size/Color</button>
                    </div>
                    
                    <!-- Bag Color/Qty Management -->
                    <div id="addBagColorContainer" class="hidden col-span-full md:col-span-2 lg:col-span-1 border p-4 rounded-md">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Bag Color & Quantity</label>
                        <div id="addBagColorList" class="max-h-48 overflow-y-auto mb-2">
                            <!-- Rows will be added here -->
                        </div>
                        <button type="button" id="addBagColorBtn" class="w-full bg-blue-500 text-white py-1 px-3 rounded-lg shadow hover:bg-blue-600 text-sm">+ Add Color</button>
                    </div>
                    
                    <div class="col-span-full flex justify-end">
                        <button type="submit" class="bg-indigo-600 text-white py-2 px-6 rounded-lg shadow hover:bg-indigo-700">Add Product</button>
                    </div>
                </form>

                <!-- Inventory List -->
                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <h3 class="text-xl font-semibold mb-4">Current Inventory</h3>
                     <!-- Inventory Filter -->
                    <div class="mb-4 flex items-center space-x-4">
                        <label for="filterInventory" class="text-sm font-medium text-gray-700">Filter:</label>
                        <input type="text" id="filterInventory" class="flex-grow border border-gray-300 rounded-md shadow-sm p-2" placeholder="Code, Name, Color, Type, Category...">
                        <button id="clearInventoryFilter" class="bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600">Clear</button>
                    </div>

                    <table class="w-full min-w-[800px]">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left text-sm font-semibold text-gray-600">Image</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-600">Name</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-600">Code</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-600">Type</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-600">Details (Size/Color)</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-600">Cost</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-600">Price</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-600">Min. Price</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-600">Stock</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            <!-- Rows added dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Point of Sale Page -->
            <div id="posPage" class="page hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Point of Sale</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <div class="lg:col-span-2">
                        <!-- NEW: POS Filter Bar -->
                        <div class="bg-white p-4 rounded-lg shadow-md mb-6 flex items-center space-x-4">
                            <label for="filterPOS" class="text-sm font-medium text-gray-700">Filter:</label>
                            <input type="text" id="filterPOS" class="flex-grow border border-gray-300 rounded-md shadow-sm p-2" placeholder="Code, Name, Color, Type, Category...">
                            <button id="clearPOSFilter" class="bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600">Clear</button>
                        </div>
                        <!-- END NEW: POS Filter Bar -->
                        <div id="posGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                            <!-- Product cards added dynamically -->
                        </div>
                    </div>

                    <div class="lg:col-span-1">
                        <div class="bg-white p-6 rounded-lg shadow-md sticky top-4">
                            <h3 class="text-xl font-semibold mb-4 border-b pb-2">Cart</h3>
                            <ul id="cartItems" class="max-h-64 overflow-y-auto mb-4">
                                <!-- Cart items added dynamically -->
                            </ul>
                            <div class="border-t pt-4">
                                <div class="flex justify-between items-center mb-4">
                                    <span class="text-lg font-bold">Total:</span>
                                    <span id="cartTotal" class="text-xl font-bold text-gray-800">$0.00</span>
                                </div>
                                <button id="checkoutButton" class="w-full bg-green-600 text-white py-3 rounded-lg shadow hover:bg-green-700 font-semibold mb-2">Checkout</button>
                                <button id="clearCartButton" class="w-full bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400">Clear Cart</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales History Page -->
            <div id="salesPage" class="page hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Sales History</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h4 class="text-lg font-semibold text-gray-700">Sales Summary</h4>
                        <p id="salesSummary" class="text-xl font-bold text-gray-900">Total Sales: $0.00 | Total Profit: $0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h4 class="text-lg font-semibold text-gray-700">This Month</h4>
                        <p id="monthlyTotal" class="text-xl font-bold text-gray-900">$0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h4 class="text-lg font-semibold text-gray-700">Filtered Day Total</h4>
                        <p id="dailyTotal" class="text-xl font-bold text-gray-900 hidden">$0.00</p>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-md mb-6 flex items-center space-x-4">
                    <label for="filterSalesDate" class="text-sm font-medium text-gray-700">Filter by Date:</label>
                    <input type="date" id="filterSalesDate" class="border border-gray-300 rounded-md shadow-sm p-2">
                    <button id="clearSalesDate" class="bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600">Clear</button>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <table class="w-full min-w-max">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left text-sm font-semibold text-gray-600">Date & Time</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-600">Items Sold</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-600">Payment</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-600">Total</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody">
                            <!-- Sales rows added dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- User Management Page -->
            <div id="usersPage" class="page hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">User Management</h2>
                
                <form id="addUserForm" onsubmit="return false;" class="bg-white p-6 rounded-lg shadow-md mb-8 grid grid-cols-1 md:grid-cols-4 gap-6">
                    <h3 class="text-xl font-semibold mb-2 col-span-full">Create New User</h3>
                    <div>
                        <label for="newUsername" class="block text-sm font-medium text-gray-700">Username</label>
                        <input type="text" id="newUsername" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="newPassword" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="newPassword" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="newRole" class="block text-sm font-medium text-gray-700">Role</label>
                        <select id="newRole" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                            <option value="sales">Sales</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button type="submit" class="bg-indigo-600 text-white py-2 px-6 rounded-lg shadow hover:bg-indigo-700 w-full">Create User</button>
                    </div>
                </form>

                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <h3 class="text-xl font-semibold mb-4">Current Users</h3>
                    <table class="w-full min-w-max">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left text-sm font-semibold text-gray-600">Username</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-600">Role</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userListTableBody">
                            <!-- User rows added dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </section>

    <!-- Edit Product Modal -->
    <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 hidden z-40 overflow-y-auto">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-3xl my-8">
            <h3 class="text-xl font-semibold mb-4">Edit Product</h3>
            <form id="editProductForm" onsubmit="return false;">
                <input type="hidden" id="editProductId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[70vh] overflow-y-auto pr-2">
                    <div>
                        <label for="editProductCode" class="block text-sm font-medium text-gray-700">Item Code (SKU)</label>
                        <input type="text" id="editProductCode" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="editProductName" class="block text-sm font-medium text-gray-700">Product Name</label>
                        <input type="text" id="editProductName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="editProductType" class="block text-sm font-medium text-gray-700">Product Type</label>
                        <select id="editProductType" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                            <option value="">Select Type</option>
                            <option value="Shoes">Shoes</option>
                            <option value="Bags">Bags</option>
                        </select>
                    </div>
                    <div>
                        <label for="editProductCost" class="block text-sm font-medium text-gray-700">Cost (Buy Price)</label>
                        <input type="number" id="editProductCost" step="0.01" min="0" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="editProductPrice" class="block text-sm font-medium text-gray-700">Price (Sell Price)</label>
                        <input type="number" id="editProductPrice" step="0.01" min="0" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="editProductMinPrice" class="block text-sm font-medium text-gray-700">Min. Sell Price (Optional)</label>
                        <input type="number" id="editProductMinPrice" step="0.01" min="0" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>

                    <div id="editProductShoeCategoryContainer" class="hidden">
                        <label for="editProductShoeCategory" class="block text-sm font-medium text-gray-700">Shoe Category</label>
                        <select id="editProductShoeCategory" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            <option value="">Select Category</option>
                            <option value="Baby">Baby (18-22)</option>
                            <option value="Kid">Kid (22-36)</option>
                            <option value="Adult">Adult (36-46)</option>
                        </select>
                    </div>

                    <div class="flex flex-col items-center">
                        <label class="block text-sm font-medium text-gray-700">Product Image</label>
                        <img id="editProductPreview" src="https://placehold.co/200x200/png?text=Preview" alt="Product Preview" class="w-32 h-32 object-cover rounded-md my-2 border">
                        
                        <div id="editImageUploadContainer" class="w-full">
                            <input type="file" id="editProductImageFile" accept="image/*" class="text-sm w-full">
                        </div>
                        <div id="editImageUrlContainer" class="hidden w-full">
                            <input type="url" id="editProductImageUrl" placeholder="Paste image URL here" class="mt-1 block w-full text-sm border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        
                        <button type="button" id="editImageInputToggle" class="text-xs text-blue-600 hover:underline mt-1">Use Image URL Instead</button>
                    </div>
                    
                    <div id="editSizeManagementContainer" class="hidden border p-4 rounded-md">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Size, Color & Quantity</label>
                        <div id="editSizeList" class="max-h-48 overflow-y-auto mb-2">
                            <!-- Rows added dynamically -->
                        </div>
                        <button type="button" id="editAddSizeBtn" class="w-full bg-blue-500 text-white py-1 px-3 rounded-lg shadow hover:bg-blue-600 text-sm">+ Add Size/Color</button>
                    </div>
                    
                    <div id="editBagColorContainer" class="hidden border p-4 rounded-md">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Color & Quantity</label>
                        <div id="editBagColorList" class="max-h-48 overflow-y-auto mb-2">
                            <!-- Rows added dynamically -->
                        </div>
                        <button type="button" id="editAddBagColorBtn" class="w-full bg-blue-500 text-white py-1 px-3 rounded-lg shadow hover:bg-blue-600 text-sm">+ Add Color</button>
                    </div>
                    
                </div>
                
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" id="cancelEditButton" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400">Cancel</button>
                    <button type="submit" id="saveEditButton" class="bg-blue-600 text-white py-2 px-4 rounded-lg shadow hover:bg-blue-700">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Select Shoe Modal (for POS) -->
    <div id="selectShoeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden z-40 overflow-y-auto">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm my-8">
            <h3 class="text-xl font-semibold mb-2">Select Size & Color for:</h3>
            <p id="shoeModalProductName" class="text-lg font-medium text-gray-800 mb-4">Product Name</p>
            <div id="shoeRadioContainer" class="space-y-2 mb-6 max-h-60 overflow-y-auto">
                <!-- Size/Color options added dynamically -->
            </div>
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancelShoeButton" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400">Cancel</button>
                <button type="button" id="confirmShoeButton" class="bg-green-600 text-white py-2 px-4 rounded-lg shadow hover:bg-green-700">Add to Cart</button>
            </div>
        </div>
    </div>
    
    <!-- Select Color Modal (for Bags) -->
    <div id="selectColorModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-2">Select Color for:</h3>
            <p id="colorModalProductName" class="text-lg font-medium text-gray-800 mb-4">Product Name</p>
            <div id="colorRadioContainer" class="space-y-2 mb-6 max-h-48 overflow-y-auto">
            </div>
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancelColorButton" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400">Cancel</button>
                <button type="button" id="confirmColorButton" class="bg-green-600 text-white py-2 px-4 rounded-lg shadow hover:bg-green-700">Add to Cart</button>
            </div>
        </div>
    </div>


    <!-- Checkout Modal -->
    <div id="checkoutModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Confirm Sale</h3>
            
            <div class="mb-2 flex justify-between">
                <span class="text-lg font-medium">Subtotal:</span>
                <span id="checkoutSubtotalAmount" class="text-lg font-medium text-gray-800">$0.00</span>
            </div>
            
            <div class="mb-4 flex justify-between items-center">
                <label for="discountPercentage" class="text-lg font-medium text-gray-700">Discount (%):</label>
                <input type="number" id="discountPercentage" step="1" min="0" max="100" class="w-1/2 border border-gray-300 rounded-md shadow-sm p-2 text-right" placeholder="0">
            </div>
            
            <div class="mb-4 pt-4 border-t flex justify-between">
                <span class="text-xl font-bold">Final Total:</span>
                <span id="checkoutTotalAmount" class="text-2xl font-bold text-gray-800">$0.00</span>
            </div>
            
            <div class="mb-6">
                <label for="paymentMethod" class="block text-sm font-medium text-gray-700">Payment Method</label>
                <select id="paymentMethod" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    <option value="Cash">Cash</option>
                    <option value="Visa">Visa</option>
                    <option value="Instapay">Instapay</option>
                    <option value="Vodafone Cash">Vodafone Cash</option>
                </select>
            </div>
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancelSaleButton" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400">Cancel</button>
                <button type="button" id="confirmSaleButton" class="bg-green-600 text-white py-2 px-4 rounded-lg shadow hover:bg-green-700">Confirm Sale</button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notificationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Notification</h3>
            <p id="notificationMessage" class="text-gray-700 mb-6">This is an alert message.</p>
            <div class="flex justify-end">
                <button type="button" id="notificationCloseBtn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg shadow hover:bg-indigo-700">OK</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Please Confirm</h3>
            <p id="confirmationMessage" class="text-gray-700 mb-6">Are you sure?</p>
            <div class="flex justify-end space-x-4">
                <button type="button" id="confirmationCancelBtn" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400">Cancel</button>
                <button type="button" id="confirmationConfirmBtn" class="bg-red-600 text-white py-2 px-4 rounded-lg shadow hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>

</body>
</html>

