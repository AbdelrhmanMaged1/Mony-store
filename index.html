<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-device-width, initial-scale=1.0" name="viewport"/>
<title>Mony Store - Shoes &amp; Bags Inventory (Modified)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
async function compressAndEncodeImage(input, maxWidth = 200, quality = 0.3) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    //- img.crossOrigin = "anonymous"; // <-- REMOVED FROM HERE
    img.onload = () => {
      try {
        const origW = img.width || 1;
        const origH = img.height || 1;
        // only scale down (don't upscale small images)
        const scale = origW > maxWidth ? (maxWidth / origW) : 1;
        const width = Math.max(1, Math.round(origW * scale));
        const height = Math.max(1, Math.round(origH * scale));

        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);

        // compress to JPEG and return data URL
        const compressed = canvas.toDataURL('image/jpeg', quality);
        resolve(compressed);
      } catch (err) {
        reject(err);
      }
    };

    img.onerror = () => reject(new Error('Failed to load image (cross-origin or invalid URL/file).'));

    // If input is a File, read as data URL first. Otherwise treat it as a URL string.
    if (input instanceof File) {
      const reader = new FileReader();
      reader.onload = (e) => { img.src = e.target.result; };
      reader.onerror = () => reject(new Error('FileReader error while reading the file.'));
      reader.readAsDataURL(input);
    } else if (typeof input === 'string' && input.trim()) {
      img.crossOrigin = "anonymous"; // <-- MOVED HERE (Only set for URL strings)
      img.src = input.trim();
    } else {
      reject(new Error('Invalid input: expected a File or a URL string.'));
    }
  });
}
</script>
<style>
        /* Custom smaller font size for general text */
        .text-2xs {
            font-size: 0.75rem; /* 12px */
        }

        body {
            font-size: 0.875rem; /* text-sm equivalent for base font size */
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); /* Slightly smaller minmax */
            gap: 0.75rem; /* Reduced gap */
        }
        .product-card {
            transition: transform 0.22s ease, box-shadow 0.22s ease;
            padding: 0.75rem; /* Reduced padding */
        }
        .product-card:hover {
            transform: translateY(-4px); /* Slightly less hover effect */
            box-shadow: 0 8px 20px rgba(13,38,76,0.06); /* Slightly less shadow */
        }
        .product-card img {
            height: 120px; /* Reduced image height */
        }
        /* Hide scrollbar for size options */
        #size-color-options::-webkit-scrollbar { display: none; }
        #size-color-options { -ms-overflow-style: none; scrollbar-width: none; }
        /* modern small tweaks */
        .glass { background: linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.6)); backdrop-filter: blur(6px); }

        /* Custom CSS for responsive navbar */
        @media (max-width: 639px) {
    /* Make modals smaller on mobile */
    .modal-container { max-width: 90% !important; padding: 1rem !important; }
 /* Tailwind's sm breakpoint is 640px */
            #navbar-items {
                display: none; /* Hidden by default on small screens */
                flex-direction: column;
                width: 100%;
                background-color: white; /* Or match header background */
                border-top: 1px solid #e5e7eb; /* gray-200 */
                padding-top: 0.25rem; /* Reduced padding */
                padding-bottom: 0.25rem; /* Reduced padding */
            }
            #navbar-items.active {
                display: flex; /* Show when active */
            }
            #navbar-items button {
                width: 100%;
                text-align: left;
                padding-left: 0.75rem; /* Reduced padding */
                padding-right: 0.75rem; /* Reduced padding */
                padding-top: 0.25rem; /* Reduced padding */
                padding-bottom: 0.25rem; /* Reduced padding */
                font-size: 0.75rem; /* text-xs */
            }
            #navbar-toggler {
                display: block; /* Show toggler on small screens */
            }

            /* Filter area specific styles for small screens */
            #filter-controls {
                display: none; /* Hidden by default on small screens */
                flex-direction: column;
                gap: 0.75rem; /* Reduced gap */
                padding-top: 0.75rem; /* Reduced padding */
            }
            #filter-controls.active {
                display: flex; /* Show when active */
            }
            #filter-toggler {
                display: block; /* Show toggler on small screens */
            }
            #inventory-filters { /* Adjust padding/margin for the main filter container */
                padding-bottom: 0; /* Remove bottom padding when toggler is present */
            }

            /* Make forms smaller on phone sizes */
            #login-view .max-w-md {
                max-width: 20rem; /* Even smaller for phones */
                padding: 1.5rem; /* Reduced padding */
            }
            #register-modal .max-w-md,
            #create-admin-modal .max-w-md,
            #create-limited-modal .max-w-md,
            #add-to-cart-modal .max-w-sm {
                max-width: 20rem; /* Even smaller for phones */
                padding: 1.5rem; /* Reduced padding */
            }
            #add-shoe-modal .max-w-xl,
            #add-bag-modal .max-w-xl {
                max-width: 28rem; /* Smaller for phones */
                padding: 1.5rem; /* Reduced padding */
            }

            /* Adjust font sizes and padding for inputs/buttons in forms on phones */
            .login-title {
                font-size: 1.125rem; /* text-base */
            }
            .login-subtitle {
                font-size: 0.625rem; /* text-2xs */
            }
            .login-input, .login-button {
                padding: 0.25rem 0.5rem; /* py-1 px-2 */
                font-size: 0.75rem; /* text-xs */
            }
            .login-tip {
                font-size: 0.5rem; /* even smaller */
            }

            .modal-title {
                font-size: 1rem; /* text-sm */
            }
            #register-form input, #create-admin-form input, #create-limited-form input,
            #add-shoe-form input, #add-bag-form input, #add-to-cart-form input,
            #register-form button, #create-admin-form button, #create-limited-form button,
            #add-shoe-form button, #add-bag-form button, #add-to-cart-form button {
                padding: 0.25rem 0.5rem; /* py-1 px-2 */
                font-size: 0.75rem; /* text-xs */
            }
            .filter-label {
                font-size: 0.625rem; /* text-2xs */
            }
            #checkout-discount, #payment-method {
                width: 6rem; /* Even smaller width */
                padding: 0.125rem 0.25rem; /* py-0.5 px-1 */
                font-size: 0.625rem; /* text-2xs */
            }
            .cart-total-section .text-lg {
                font-size: 1rem; /* text-base */
            }
            .checkout-btn {
                padding: 0.5rem 1rem; /* py-2 px-4 */
                font-size: 0.875rem; /* text-sm */
            }
        }
        @media (min-width: 640px) { /* Tailwind's sm breakpoint */
            #navbar-items {
                display: flex !important; /* Always show on larger screens */
                flex-direction: row;
            }
            #navbar-toggler {
                display: none; /* Hide toggler on larger screens */
            }

            /* Filter area specific styles for large screens */
            #filter-controls {
                display: flex !important; /* Always show on larger screens */
                flex-direction: row;
                flex-wrap: wrap;
                gap: 0.75rem; /* Reduced gap */
            }
            #filter-toggler {
                display: none; /* Hide toggler on larger screens */
            }

            /* Default sizes for larger screens */
            #login-view .max-w-md {
                max-width: 24rem; /* max-w-sm */
            }
            #register-modal .max-w-md,
            #create-admin-modal .max-w-md,
            #create-limited-modal .max-w-md,
            #add-to-cart-modal .max-w-sm {
                max-width: 24rem; /* max-w-sm */
            }
            #add-shoe-modal .max-w-xl,
            #add-bag-modal .max-w-xl {
                max-width: 36rem; /* max-w-lg */
            }

            /* Default input/button sizes for larger screens */
            input[type="text"],
            input[type="password"],
            input[type="number"],
            select {
                padding: 0.375rem 0.75rem; /* py-1.5 px-3 */
                font-size: 0.875rem; /* text-sm */
            }
            button {
                padding: 0.5rem 1rem; /* py-2 px-4 */
                font-size: 0.875rem; /* text-sm */
            }
            .login-title {
                font-size: 1.5rem; /* text-2xl */
            }
            .login-subtitle {
                font-size: 0.875rem; /* text-sm */
            }
            .login-input {
                padding: 0.5rem 0.75rem; /* py-2 px-3 */
            }
            .login-button {
                padding: 0.5rem 0.75rem; /* py-2 px-3 */
            }
            .login-tip {
                font-size: 0.75rem; /* text-xs */
            }
            .modal-title {
                font-size: 1.125rem; /* text-base */
            }
            #checkout-discount,
            #payment-method {
                width: 8rem; /* Original width */
                padding: 0.25rem 0.5rem; /* py-1 px-2 */
                font-size: 0.75rem; /* text-xs */
            }
            .cart-total-section .text-lg {
                font-size: 1.25rem; /* text-xl */
            }
            .checkout-btn {
                padding: 0.625rem 1.25rem; /* py-2.5 px-5 */
                font-size: 1rem; /* text-base */
            }
        }
        /* Custom CSS for sales history item images */
        .sales-history-item-image {
            width: 30px; /* Even smaller width for image */
            height: 30px; /* Even smaller height for image */
            object-fit: cover;
            border-radius: 4px;
            margin-right: 4px; /* Space between image and text */
        }

        /* Specific overrides for smaller elements */
        .header-logo {
            height: 32px; /* h-8 */
        }
        .header-title {
            font-size: 1.125rem; /* text-base */
        }
        .header-subtitle {
            font-size: 0.625rem; /* text-2xs */
        }
        .navbar-button {
            padding: 0.25rem 0.5rem; /* py-1 px-2 */
            font-size: 0.75rem; /* text-xs */
        }
        .inventory-dashboard-title {
            font-size: 1.25rem; /* text-xl */
        }
        .admin-action-button {
            padding: 0.375rem 0.75rem; /* py-1.5 px-3 */
            font-size: 0.75rem; /* text-xs */
        }
        .product-card h4 {
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
        }
        .product-card p {
            font-size: 0.75rem; /* text-xs */
        }
        .product-card .text-xs {
            font-size: 0.625rem; /* text-2xs */
        }
        .product-card .font-bold {
            font-size: 0.875rem; /* text-sm */
        }
        .product-card .add-to-cart-btn,
        .product-card .edit-item-btn {
            padding: 0.25rem 0.75rem; /* py-1 px-3 */
            font-size: 0.75rem; /* text-xs */
        }
        .sales-history-table th,
        .sales-history-table td {
            padding: 0.375rem 0.75rem; /* py-1.5 px-3 */
            font-size: 0.75rem; /* text-xs */
        }
        .sales-history-title {
            font-size: 1.125rem; /* text-base */
        }
        .cart-item-row {
            padding: 0.5rem; /* Reduced padding */
        }
        .cart-item-row img {
            width: 48px; /* Reduced image size */
            height: 48px;
        }
        .cart-item-row .font-semibold {
            font-size: 0.875rem; /* text-sm */
        }
        .cart-item-row .text-xs {
            font-size: 0.625rem; /* text-2xs */
        }
        .cart-item-row .font-bold {
            font-size: 0.875rem; /* text-sm */
        }
        .cart-total-section {
            padding: 0.75rem; /* Reduced padding */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
<div class="min-h-screen" id="app">
<div class="flex items-center justify-center h-screen bg-gradient-to-br from-indigo-50 to-pink-50 px-4" id="login-view">
<div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md glass">
<div class="text-center mb-6">
<h1 class="login-title font-extrabold text-gray-900 mb-1">Mony Store</h1>
<p class="login-subtitle text-gray-600">Inventory &amp; Sales Dashboard</p>
</div>
<form class="space-y-6" id="login-form">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="username">Username</label>
<input class="login-input w-full rounded-xl border border-gray-200 focus:ring-2 focus:ring-indigo-400 focus:border-transparent transition" id="username" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="password">Password</label>
<input class="login-input w-full rounded-xl border border-gray-200 focus:ring-2 focus:ring-indigo-400 focus:border-transparent transition" id="password" required="" type="password"/>
</div>
<button class="login-button w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-xl transition transform hover:scale-[1.01]" type="submit">
                        Login
                    </button>
<div class="text-center mt-4">
<button class="text-indigo-600 hover:text-indigo-800 text-sm font-medium" id="register-btn" type="button">Create Admin Account</button>
</div>
</form>
</div>
</div>
<div class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 z-50" id="register-modal">
<div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
<div class="text-center mb-4">
<h2 class="modal-title font-bold text-gray-800">Create Admin Account</h2>
</div>
<form class="space-y-4" id="register-form">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="new-username">Username</label>
<input class="w-full px-3 py-1.5 rounded-lg border border-gray-300" id="new-username" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="new-password">Password</label>
<input class="w-full px-3 py-1.5 rounded-lg border border-gray-300" id="new-password" required="" type="password"/>
</div>
<div class="flex justify-between pt-4">
<button class="px-3 py-1.5 text-gray-600 hover:text-gray-800" id="cancel-register" type="button">Cancel</button>
<button class="px-3 py-1.5 bg-green-600 text-white rounded-md hover:bg-green-700" type="submit">Register</button>
</div>
</form>
</div>
</div>
<div class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 z-50" id="create-admin-modal">
<div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
<div class="text-center mb-4">
<h2 class="modal-title font-bold text-gray-800">Create New Admin Account</h2>
</div>
<form class="space-y-4" id="create-admin-form">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="admin-username">Username</label>
<input class="w-full px-3 py-1.5 rounded-lg border border-gray-300" id="admin-username" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="admin-password">Password</label>
<input class="w-full px-3 py-1.5 rounded-lg border border-gray-300" id="admin-password" required="" type="password"/>
</div>
<div class="flex justify-between pt-4">
<button class="px-3 py-1.5 text-gray-600 hover:text-gray-800" id="cancel-admin-creation" type="button">Cancel</button>
<button class="px-3 py-1.5 bg-green-600 text-white rounded-md hover:bg-green-700" type="submit">Create Account</button>
</div>
</form>
</div>
</div>
<div class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 z-50" id="create-limited-modal">
<div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
<div class="text-center mb-4">
<h2 class="modal-title font-bold text-gray-800">Create Limited Account</h2>
</div>
<form class="space-y-4" id="create-limited-form">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="limited-username">Username</label>
<input class="w-full px-3 py-1.5 rounded-lg border border-gray-300" id="limited-username" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="limited-password">Password</label>
<input class="w-full px-3 py-1.5 rounded-lg border border-gray-300" id="limited-password" required="" type="password"/>
</div>
<div class="flex justify-between pt-4">
<button class="px-3 py-1.5 text-gray-600 hover:text-gray-800" id="cancel-limited-creation" type="button">Cancel</button>
<button class="px-3 py-1.5 bg-green-600 text-white rounded-md hover:bg-green-700" type="submit">Create Account</button>
</div>
</form>
</div>
</div>
<div class="hidden" id="inventory-view">
<header class="bg-white shadow-sm sticky top-0 z-50">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex flex-col sm:flex-row justify-between items-center gap-2">
<div class="flex items-center justify-between w-full sm:w-auto">
<div class="flex items-center gap-2">
<img alt="logo" class="header-logo w-auto mr-1" src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/367b9096-ee32-4690-826d-30982b44976d.png"/>
<div>
<h1 class="header-title font-bold text-gray-900">Mony Store Inventory</h1>
<p class="header-subtitle text-gray-500">Shoes &amp; Bags • Manage stock &amp; sales</p>
</div>
</div>
<button class="sm:hidden text-gray-600 hover:text-gray-900 p-1.5 rounded-md" id="navbar-toggler" type="button">
<svg class="h-5 w-5" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M4 6h16M4 12h16M4 18h16" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
</div>
<div class="flex flex-col sm:flex-row sm:items-center sm:space-x-2 w-full sm:w-auto" id="navbar-items">
<button class="navbar-button text-gray-600 hover:text-gray-900 rounded-md font-medium" id="sales-history-btn">Sales History</button>
<button class="relative navbar-button text-gray-600 hover:text-gray-900 rounded-md font-medium" id="view-cart-btn">
                            Cart (<span id="cart-count">0</span>)
                        </button>
<button class="navbar-button text-gray-600 hover:text-gray-900 rounded-md font-medium" id="create-limited-account-btn">Create Limited Account</button>
<button class="navbar-button text-gray-600 hover:text-gray-900 rounded-md font-medium" id="create-admin-account-btn">Create Admin Account</button>
<button class="navbar-button text-gray-600 hover:text-gray-900 rounded-md font-medium" id="logout-btn">Logout</button>
</div>
</div>
</header>
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
<div class="mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
<h2 class="inventory-dashboard-title font-bold text-gray-800">Inventory Dashboard</h2>
<div class="flex space-x-2" id="admin-actions">
<button class="admin-action-button bg-green-600 hover:bg-green-700 text-white rounded-md font-medium" id="add-shoe-btn">Add Shoe</button>
<button class="admin-action-button bg-green-600 hover:bg-green-700 text-white rounded-md font-medium" id="add-bag-btn">Add Bag</button>
<button class="admin-action-button bg-red-100 text-red-700 rounded-md" id="clear-storage-btn">Reset Data</button>
<button class="admin-action-button bg-red-600 hover:bg-red-700 text-white rounded-md font-medium" id="delete-account-btn">Delete Account</button>
</div>
</div>
<div class="mb-4 bg-white p-3 rounded-lg shadow-sm flex flex-col" id="inventory-filters">
<div class="flex justify-between items-center mb-3 sm:mb-0">
<h3 class="text-base font-semibold text-gray-800">Filters</h3>
<button class="sm:hidden text-gray-600 hover:text-gray-900 p-1.5 rounded-md" id="filter-toggler" type="button">
<svg class="h-5 w-5" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M19 9l-7 7-7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
</div>
<div class="flex flex-wrap gap-3" id="filter-controls">
<div>
<label class="filter-label block font-medium text-gray-700">Type</label>
<select class="border border-gray-300 rounded-md" id="filter-type">
<option value="">All</option>
<option value="shoes">Shoes</option>
<option value="bags">Bags</option>
</select>
</div>
<div>
<label class="filter-label block font-medium text-gray-700">Brand</label>
<select class="border border-gray-300 rounded-md" id="filter-brand">
<option value="">All</option>
</select>
</div>
<div>
<label class="filter-label block font-medium text-gray-700">Color</label>
<select class="border border-gray-300 rounded-md" id="filter-color">
<option value="">All</option>
</select>
</div>
<div>
<label class="filter-label block font-medium text-gray-700">Min Price</label>
<input class="border border-gray-300 rounded-md" id="filter-min-price" step="0.01" type="number"/>
</div>
<div>
<label class="filter-label block font-medium text-gray-700">Max Price</label>
<input class="border border-gray-300 rounded-md" id="filter-max-price" step="0.01" type="number"/>
</div>
<div>
    <label class="filter-label block font-medium text-gray-700">Item Code</label>
    <input class="border border-gray-300 rounded-md" id="filter-code" type="text" placeholder="e.g., S001"/>
</div>

<div class="flex items-end">
    <button id="reset-filters-btn" class="admin-action-button bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-md font-medium">Reset Filters</button>
</div>

</div>
</div>
<div class="mb-6">
<h3 class="text-base font-semibold text-gray-800 mb-3" id="inventory-type-title">All Products</h3>
<div class="inventory-grid" id="inventory-list">
</div>
</div>
</main>
</div>
<div class="hidden max-w-7xl mx-auto px-4 py-6" id="sales-history-view">
<div class="mb-3 font-semibold text-gray-800" id="salesSummary"></div>
<header class="bg-white shadow-sm mb-4 sticky top-0 z-40">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
<h1 class="sales-history-title font-bold text-gray-900">Sales History</h1>
<button class="navbar-button text-indigo-600 hover:text-indigo-800 rounded-md font-medium" id="back-to-inventory-from-history">← Back</button>
</div>
</header>
<div class="mb-3 flex items-center gap-3">
<label class="text-xs font-medium text-gray-700" for="filter-sales-date">Filter by Date:</label>
<input class="border border-gray-300 rounded-md" id="filter-sales-date" type="date"/>
<button class="px-2.5 py-1.5 bg-gray-200 rounded-md text-xs" id="clear-sales-date">Clear</button>
</div>
<div class="overflow-x-auto bg-white rounded-lg shadow-sm">
<table class="min-w-full text-xs text-gray-700" id="sales-history-table">
<thead class="bg-gray-100">
<tr>
<th class="px-3 py-1.5 text-left">Date &amp; Time</th>
<th class="px-3 py-1.5 text-left">Items</th>
<th class="px-3 py-1.5 text-left">Payment Method</th>
<th class="px-3 py-1.5 text-right">Total ($)</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="mt-3 font-semibold text-gray-800" id="daily-total"></div>
<div class="mt-1.5 font-semibold text-gray-800" id="monthly-total"></div>
</div>
<div class="hidden max-w-7xl mx-auto px-4 py-6" id="cart-view">
<header class="bg-white shadow-sm mb-4 sticky top-0 z-40">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
<h1 class="sales-history-title font-bold text-gray-900">Your Shopping Cart</h1>
<button class="navbar-button text-indigo-600 hover:text-indigo-800 rounded-md font-medium" id="back-to-inventory-btn">← Back to Inventory</button>
</div>
</header>
<main>
<div class="space-y-3 mb-4" id="cart-items-list"></div>
<div class="bg-white rounded-lg shadow-sm p-3 flex flex-col sm:flex-row justify-between items-center gap-3">
<div class="w-full sm:w-auto text-xs">
<label class="block text-gray-600">Discount (%)</label>
<input class="border border-gray-300 rounded-md w-24" id="checkout-discount" max="100" min="0" step="0.01" type="number" value="0"/>
</div>

<div class="w-full sm:w-auto text-xs">
    <label class="block text-gray-600">Payment Method</label>
    <select id="payment-method" class="border border-gray-300 rounded-md w-36">
        <option value="cash">Cash</option>
        <option value="visa">Visa</option>
        <option value="instapay">Instapay</option>
        <option value="vodafone-cash">Vodafone Cash</option>
    </select>
</div>

<p class="text-lg font-bold">Total: $<span id="cart-total">0.00</span></p>
<button class="checkout-btn bg-green-600 hover:bg-green-700 text-white rounded-md font-medium" id="checkout-btn">Proceed to Checkout</button>
</div>
</main>
</div>
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden" id="add-shoe-modal">
<div class="bg-white rounded-lg shadow-xl w-full max-w-xl">
<div class="p-4">
<div class="flex justify-between items-center mb-3">
<h3 class="modal-title font-bold text-gray-800">Add / Edit Shoe</h3>
<button class="text-gray-500 hover:text-gray-700" id="close-shoe-modal">
<svg class="h-5 w-5" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
</button>
</div>
<form class="space-y-3" id="add-shoe-form">
<div class="grid grid-cols-1 md:grid-cols-2 gap-3">
<div>
<label class="block text-xs font-medium text-gray-700 mb-1" for="shoe-brand">Brand</label>
<input class="w-full border border-gray-300 rounded-md" id="shoe-brand" required="" type="text"/>
</div>
<div>
<label class="block text-xs font-medium text-gray-700 mb-1" for="shoe-model">Model</label>
<input class="w-full border border-gray-300 rounded-md" id="shoe-model" required="" type="text"/>
</div>
<div>
<label class="block text-xs font-medium text-gray-700 mb-1" for="shoe-color">Color</label>
<input class="w-full border border-gray-300 rounded-md" id="shoe-color" required="" type="text"/>
</div>
<div>
<label class="block text-xs font-medium text-gray-700 mb-1" for="shoe-original-price">Original Price ($)</label>
<input class="w-full border border-gray-300 rounded-md" id="shoe-original-price" min="0" required="" step="0.01" type="number"/>
</div>
<div>
<label class="block text-xs font-medium text-gray-700 mb-1" for="shoe-min-price">Min Sales Price ($)</label>
<input class="w-full border border-gray-300 rounded-md" id="shoe-min-price" min="0" step="0.01" type="number"/>
</div>
<div>
<label class="block text-xs font-medium text-gray-700 mb-1" for="shoe-price">Sales Price ($)</label>
<input class="w-full border border-gray-300 rounded-md" id="shoe-price" min="0" required="" step="0.01" type="number"/>
</div>
<div>
<label class="block text-xs font-medium text-gray-700 mb-1" for="shoe-code">Item Code</label>
<input class="w-full border border-gray-300 rounded-md" id="shoe-code" required="" type="text"/>
</div>
<div>
<label class="block text-xs font-medium text-gray-700 mb-1" for="shoe-sizes">Available Sizes (comma-separated)</label>
<input class="w-full border border-gray-300 rounded-md" id="shoe-sizes" placeholder="e.g., 38, 39, 39, 40" required="" type="text"/>
</div>
<div class="md:col-span-2">
<label class="block text-xs font-medium text-gray-700 mt-2 mb-1">Image (file or url) — <span class="text-2xs text-gray-500" id="shoe-image-note">editable when adding only</span></label>
<input accept="image/*" class="w-full border border-gray-300 rounded-md" id="shoe-image-file" type="file"/>
<input class="w-full border border-gray-300 rounded-md mt-1" id="shoe-image-url" placeholder="https://example.com/image.jpg" type="text"/>
<div class="mt-3">
<img alt="Image Preview" class="hidden w-32 h-24 object-cover rounded-md mx-auto border" id="shoe-image-preview" src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/e8513746-6820-4bba-9260-b0f38c8939ad.png">
</div>
</div>
</div>
<div class="flex justify-end space-x-2 pt-3">
<button class="px-3 py-1.5 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50" id="cancel-shoe" type="button">Cancel</button>
<button class="px-3 py-1.5 bg-indigo-600 text-white rounded-md hover:bg-indigo-700" type="submit">Save</button>
</div>
</form>
</div>
</div>
</div>
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden" id="add-bag-modal">
<div class="bg-white rounded-lg shadow-xl w-full max-w-xl">
<div class="p-4">
<div class="flex justify-between items-center mb-3">
<h3 class="modal-title font-bold text-gray-800">Add / Edit Bag</h3>
<button class="text-gray-500 hover:text-gray-700" id="close-bag-modal">
<svg class="h-5 w-5" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
</button>
</div>
<form class="space-y-3" id="add-bag-form">
<div class="grid grid-cols-1 md:grid-cols-2 gap-3">
<div>
<label class="block text-xs font-medium text-gray-700 mb-1" for="bag-brand">Brand</label>
<input class="w-full border border-gray-300 rounded-md" id="bag-brand" required="" type="text"/>
</div>
<div>
<label class="block text-xs font-medium text-gray-700 mb-1" for="bag-model">Model</label>
<input class="w-full border border-gray-300 rounded-md" id="bag-model" required="" type="text"/>
</div>
<div>
<label class="block text-xs font-medium text-gray-700 mb-1" for="bag-color">Color</label>
<input class="w-full border border-gray-300 rounded-md" id="bag-color" required="" type="text"/>
</div>
<div>
<label class="block text-xs font-medium text-gray-700 mb-1" for="bag-original-price">Original Price ($)</label>
<input class="w-full border border-gray-300 rounded-md" id="bag-original-price" min="0" required="" step="0.01" type="number"/>
</div>
<div>
<label class="block text-xs font-medium text-gray-700 mb-1" for="bag-min-price">Min Sales Price ($)</label>
<input class="w-full border border-gray-300 rounded-md" id="bag-min-price" min="0" step="0.01" type="number"/>
</div>
<div>
<label class="block text-xs font-medium text-gray-700 mb-1" for="bag-price">Sales Price ($)</label>
<input class="w-full border border-gray-300 rounded-md" id="bag-price" min="0" required="" step="0.01" type="number"/>
</div>
<div>
<label class="block text-xs font-medium text-gray-700 mb-1" for="bag-code">Item Code</label>
<input class="w-full border border-gray-300 rounded-md" id="bag-code" required="" type="text"/>
</div>
<div>
<label class="block text-xs font-medium text-gray-700 mb-1" for="bag-stock">Stock</label>
<input class="w-full border border-gray-300 rounded-md" id="bag-stock" min="0" required="" step="1" type="number"/>
</div>
<div class="md:col-span-2">
<label class="block text-xs font-medium text-gray-700 mt-2 mb-1">Image (file or url) — <span class="text-2xs text-gray-500" id="bag-image-note">editable when adding only</span></label>
<input accept="image/*" class="w-full border border-gray-300 rounded-md" id="bag-image-file" type="file"/>
<input class="w-full border border-gray-300 rounded-md mt-1" id="bag-image-url" placeholder="https://example.com/image.jpg" type="text"/>
<div class="mt-3">
<img alt="Image Preview" class="hidden w-32 h-24 object-cover rounded-md mx-auto border" id="bag-image-preview" src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/e8513746-6820-4bba-9260-b0f38c8939ad.png">
</div>
</div>
</div>
<div class="flex justify-end space-x-2 pt-3">
<button class="px-3 py-1.5 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50" id="cancel-bag" type="button">Cancel</button>
<button class="px-3 py-1.5 bg-indigo-600 text-white rounded-md hover:bg-indigo-700" type="submit">Save</button>
</div>
</form>
</div>
</div>
</div>
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden" id="add-to-cart-modal">
<div class="bg-white rounded-lg shadow-xl w-full max-w-sm">
<div class="p-4">
<div class="flex justify-between items-center mb-3">
<h3 class="modal-title font-bold text-gray-800" id="add-to-cart-title">Add to Cart</h3>
<button class="text-gray-500 hover:text-gray-700" id="close-cart-modal">
<svg class="h-5 w-5" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
</button>
</div>
<form id="add-to-cart-form">
<div class="mb-3" id="size-color-options"></div>
<div>
<label class="block text-xs font-medium text-gray-700 mb-1" for="cart-quantity">Quantity</label>
<input class="w-full border border-gray-300 rounded-md" id="cart-quantity" min="1" required="" type="number" value="1"/>
</div>
<div class="flex justify-end space-x-2 pt-3">
<button class="px-3 py-1.5 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50" id="cancel-add-to-cart" type="button">Cancel</button>
<button class="px-3 py-1.5 bg-green-600 text-white rounded-md hover:bg-green-700" type="submit">Add</button>
</div>
</form>
</div>
</div>
</div>
<div class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 z-50" id="delete-account-modal">
<div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
<div class="text-center mb-4">
<h2 class="modal-title font-bold text-gray-800">Delete Account</h2>
</div>
<form class="space-y-4" id="delete-account-form">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="delete-username">Username</label>
<input class="w-full border rounded-lg px-3 py-2" id="delete-username" required="" type="text"/>
</div>
<div class="flex justify-between pt-4">
<button class="px-3 py-1.5 text-gray-600 hover:text-gray-800" id="cancel-delete-account" type="button">Cancel</button>
<button class="px-3 py-1.5 bg-red-600 text-white rounded-md hover:bg-red-700" type="submit">Delete</button>
</div>
</form>
</div>
</div>
</div>
<script>
    // ... (Your existing compressAndEncodeImage function is in the head) ...

    document.addEventListener('DOMContentLoaded', () => {
        // ... (The rest of your application logic) ...
        const DB_KEY_USERS = 'mony_store_users';
        const DB_KEY_INVENTORY = 'mony_store_inventory';
        const DB_KEY_SALES = 'mony_store_sales';
        const DB_KEY_LOGGED_IN = 'mony_store_logged_in';

        // ... (All your existing JS code from the original file follows) ...
        // (Assuming the rest of the JS logic starts here in the original file)
        
        // --- State ---
        let users = JSON.parse(localStorage.getItem(DB_KEY_USERS)) || [];
        let inventory = JSON.parse(localStorage.getItem(DB_KEY_INVENTORY)) || [];
        let salesHistory = JSON.parse(localStorage.getItem(DB_KEY_SALES)) || [];
        let cart = [];
        let loggedInUser = JSON.parse(localStorage.getItem(DB_KEY_LOGGED_IN)) || null;
        let editingItemId = null; // Used for tracking which item is being edited

        // --- Selectors ---
        const app = document.getElementById('app');
        const loginView = document.getElementById('login-view');
        const inventoryView = document.getElementById('inventory-view');
        const salesHistoryView = document.getElementById('sales-history-view');
        const cartView = document.getElementById('cart-view');

        // Login/Register Selectors
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const registerBtn = document.getElementById('register-btn');
        const registerModal = document.getElementById('register-modal');
        const registerForm = document.getElementById('register-form');
        const newUsernameInput = document.getElementById('new-username');
        const newPasswordInput = document.getElementById('new-password');
        const cancelRegisterBtn = document.getElementById('cancel-register');

        // Admin Creation Modals
        const createAdminModal = document.getElementById('create-admin-modal');
        const createAdminForm = document.getElementById('create-admin-form');
        const adminUsernameInput = document.getElementById('admin-username');
        const adminPasswordInput = document.getElementById('admin-password');
        const cancelAdminCreationBtn = document.getElementById('cancel-admin-creation');
        const createAdminAccountBtn = document.getElementById('create-admin-account-btn');

        // Limited Account Modals
        const createLimitedModal = document.getElementById('create-limited-modal');
        const createLimitedForm = document.getElementById('create-limited-form');
        const limitedUsernameInput = document.getElementById('limited-username');
        const limitedPasswordInput = document.getElementById('limited-password');
        const cancelLimitedCreationBtn = document.getElementById('cancel-limited-creation');
        const createLimitedAccountBtn = document.getElementById('create-limited-account-btn');

        // Delete Account Modal
        const deleteAccountBtn = document.getElementById('delete-account-btn');
        const deleteAccountModal = document.getElementById('delete-account-modal');
        const deleteAccountForm = document.getElementById('delete-account-form');
        const deleteUsernameInput = document.getElementById('delete-username');
        const cancelDeleteAccountBtn = document.getElementById('cancel-delete-account');

        // Nav Selectors
        const logoutBtn = document.getElementById('logout-btn');
        const salesHistoryBtn = document.getElementById('sales-history-btn');
        const viewCartBtn = document.getElementById('view-cart-btn');
        const cartCountEl = document.getElementById('cart-count');
        const backToInventoryBtn = document.getElementById('back-to-inventory-btn');
        const backToInventoryFromHistoryBtn = document.getElementById('back-to-inventory-from-history');
        const navbarToggler = document.getElementById('navbar-toggler');
        const navbarItems = document.getElementById('navbar-items');

        // Inventory Selectors
        const inventoryList = document.getElementById('inventory-list');
        const inventoryTypeTitle = document.getElementById('inventory-type-title');
        const adminActions = document.getElementById('admin-actions');
        const addShoeBtn = document.getElementById('add-shoe-btn');
        const addBagBtn = document.getElementById('add-bag-btn');
        const clearStorageBtn = document.getElementById('clear-storage-btn');

        // Filter Selectors
        const filterType = document.getElementById('filter-type');
        const filterBrand = document.getElementById('filter-brand');
        const filterColor = document.getElementById('filter-color');
        const filterMinPrice = document.getElementById('filter-min-price');
        const filterMaxPrice = document.getElementById('filter-max-price');
        const filterCode = document.getElementById('filter-code');
        const resetFiltersBtn = document.getElementById('reset-filters-btn');
        const filterToggler = document.getElementById('filter-toggler');
        const filterControls = document.getElementById('filter-controls');

        // Add/Edit Shoe Modal Selectors
        const addShoeModal = document.getElementById('add-shoe-modal');
        const closeShoeModalBtn = document.getElementById('close-shoe-modal');
        const cancelShoeBtn = document.getElementById('cancel-shoe');
        const addShoeForm = document.getElementById('add-shoe-form');
        const shoeBrand = document.getElementById('shoe-brand');
        const shoeModel = document.getElementById('shoe-model');
        const shoeColor = document.getElementById('shoe-color');
        const shoeOriginalPrice = document.getElementById('shoe-original-price');
        const shoeMinPrice = document.getElementById('shoe-min-price');
        const shoePrice = document.getElementById('shoe-price');
        const shoeCode = document.getElementById('shoe-code');
        const shoeSizes = document.getElementById('shoe-sizes');
        const shoeImageFile = document.getElementById('shoe-image-file');
        const shoeImageUrl = document.getElementById('shoe-image-url');
        const shoeImagePreview = document.getElementById('shoe-image-preview');
        const shoeImageNote = document.getElementById('shoe-image-note');


        // Add/Edit Bag Modal Selectors
        const addBagModal = document.getElementById('add-bag-modal');
        const closeBagModalBtn = document.getElementById('close-bag-modal');
        const cancelBagBtn = document.getElementById('cancel-bag');
        const addBagForm = document.getElementById('add-bag-form');
        const bagBrand = document.getElementById('bag-brand');
        const bagModel = document.getElementById('bag-model');
        const bagColor = document.getElementById('bag-color');
        const bagOriginalPrice = document.getElementById('bag-original-price');
        const bagMinPrice = document.getElementById('bag-min-price');
        const bagPrice = document.getElementById('bag-price');
        const bagCode = document.getElementById('bag-code');
        const bagStock = document.getElementById('bag-stock');
        const bagImageFile = document.getElementById('bag-image-file');
        const bagImageUrl = document.getElementById('bag-image-url');
        const bagImagePreview = document.getElementById('bag-image-preview');
        const bagImageNote = document.getElementById('bag-image-note');

        // Add to Cart Modal Selectors
        const addToCartModal = document.getElementById('add-to-cart-modal');
        const addToCartTitle = document.getElementById('add-to-cart-title');
        const closeCartModalBtn = document.getElementById('close-cart-modal');
        const cancelAddToCartBtn = document.getElementById('cancel-add-to-cart');
        const addToCartForm = document.getElementById('add-to-cart-form');
        const sizeColorOptions = document.getElementById('size-color-options');
        const cartQuantity = document.getElementById('cart-quantity');

        // Cart View Selectors
        const cartItemsList = document.getElementById('cart-items-list');
        const cartTotalEl = document.getElementById('cart-total');
        const checkoutBtn = document.getElementById('checkout-btn');
        const checkoutDiscount = document.getElementById('checkout-discount');
        const paymentMethod = document.getElementById('payment-method');

        // Sales History Selectors
        const salesHistoryTableBody = document.querySelector('#sales-history-table tbody');
        const salesSummaryEl = document.getElementById('salesSummary');
        const filterSalesDate = document.getElementById('filter-sales-date');
        const clearSalesDate = document.getElementById('clear-sales-date');
        const dailyTotalEl = document.getElementById('daily-total');
        const monthlyTotalEl = document.getElementById('monthly-total');

        // --- Utility Functions ---
        const saveState = () => {
            localStorage.setItem(DB_KEY_USERS, JSON.stringify(users));
            localStorage.setItem(DB_KEY_INVENTORY, JSON.stringify(inventory));
            localStorage.setItem(DB_KEY_SALES, JSON.stringify(salesHistory));
            localStorage.setItem(DB_KEY_LOGGED_IN, JSON.stringify(loggedInUser));
        };

        const generateId = (prefix) => {
            return `${prefix}-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
        };

        const showView = (view) => {
            [loginView, inventoryView, salesHistoryView, cartView].forEach(v => v.classList.add('hidden'));
            view.classList.remove('hidden');
        };

        // --- Image Preview Logic ---
        const setupImagePreview = (fileInput, urlInput, previewEl) => {
            const updatePreview = (src) => {
                if (src) {
                    previewEl.src = src;
                    previewEl.classList.remove('hidden');
                } else {
                    previewEl.classList.add('hidden');
                }
            };

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    urlInput.value = ''; // Clear URL input if file is selected
                    const reader = new FileReader();
                    reader.onload = (event) => updatePreview(event.target.result);
                    reader.readAsDataURL(file);
                }
            });

            urlInput.addEventListener('input', () => {
                if (urlInput.value) {
                    fileInput.value = ''; // Clear file input if URL is typed
                    updatePreview(urlInput.value);
                } else {
                    updatePreview(null);
                }
            });

            // Add an error handler to the preview image
            previewEl.onerror = () => {
                previewEl.src = 'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/e8513746-6820-4bba-9260-b0f38c8939ad.png'; // Fallback
            };
        };
        
        setupImagePreview(shoeImageFile, shoeImageUrl, shoeImagePreview);
        setupImagePreview(bagImageFile, bagImageUrl, bagImagePreview);

        const resetImagePreview = (fileInput, urlInput, previewEl) => {
             fileInput.value = '';
             urlInput.value = '';
             previewEl.src = 'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/e8513746-6820-4bba-9260-b0f38c8939ad.png';
             previewEl.classList.add('hidden');
        };

        // --- Authentication ---
        const checkLogin = () => {
            if (loggedInUser) {
                showView(inventoryView);
                renderInventory();
                updateUserUI();
            } else {
                showView(loginView);
                // Show register button only if no admins exist
                const adminExists = users.some(u => u.role === 'admin');
                registerBtn.classList.toggle('hidden', adminExists);
            }
        };

        const updateUserUI = () => {
            if (!loggedInUser) return;
            const isAdmin = loggedInUser.role === 'admin';
            adminActions.classList.toggle('hidden', !isAdmin);
            createAdminAccountBtn.classList.toggle('hidden', !isAdmin);
            createLimitedAccountBtn.classList.toggle('hidden', !isAdmin);
            deleteAccountBtn.classList.toggle('hidden', !isAdmin);
            // Show edit buttons only for admin
            document.querySelectorAll('.edit-item-btn').forEach(btn => {
                btn.classList.toggle('hidden', !isAdmin);
            });
        };

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = usernameInput.value;
            const password = passwordInput.value;
            const user = users.find(u => u.username === username && u.password === password);
            if (user) {
                loggedInUser = user;
                saveState();
                checkLogin();
                usernameInput.value = '';
                passwordInput.value = '';
            } else {
                alert('Invalid username or password.');
            }
        });

        logoutBtn.addEventListener('click', () => {
            loggedInUser = null;
            saveState();
            checkLogin();
        });

        const showRegisterModal = (role, modal, form, userEl, passEl) => {
            modal.classList.remove('hidden');
            form.onsubmit = (e) => {
                e.preventDefault();
                const username = userEl.value;
                const password = passEl.value;
                if (users.find(u => u.username === username)) {
                    alert('Username already exists.');
                    return;
                }
                users.push({ id: generateId('u'), username, password, role });
                saveState();
                alert(`${role.charAt(0).toUpperCase() + role.slice(1)} account created successfully!`);
                form.reset();
                modal.classList.add('hidden');
                // If this was the first admin, log them in
                if (role === 'admin' && !loggedInUser) {
                    loggedInUser = users.find(u => u.username === username);
                    saveState();
                    checkLogin();
                }
            };
        };

        registerBtn.addEventListener('click', () => {
            showRegisterModal('admin', registerModal, registerForm, newUsernameInput, newPasswordInput);
        });
        cancelRegisterBtn.addEventListener('click', () => registerModal.classList.add('hidden'));

        createAdminAccountBtn.addEventListener('click', () => {
            showRegisterModal('admin', createAdminModal, createAdminForm, adminUsernameInput, adminPasswordInput);
        });
        cancelAdminCreationBtn.addEventListener('click', () => createAdminModal.classList.add('hidden'));

        createLimitedAccountBtn.addEventListener('click', () => {
            showRegisterModal('limited', createLimitedModal, createLimitedForm, limitedUsernameInput, limitedPasswordInput);
        });
        cancelLimitedCreationBtn.addEventListener('click', () => createLimitedModal.classList.add('hidden'));

        // Delete Account Logic
        deleteAccountBtn.addEventListener('click', () => {
            deleteAccountModal.classList.remove('hidden');
            deleteUsernameInput.value = '';
        });

        cancelDeleteAccountBtn.addEventListener('click', () => {
            deleteAccountModal.classList.add('hidden');
        });

        deleteAccountForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const usernameToDelete = deleteUsernameInput.value;
            const userIndex = users.findIndex(u => u.username === usernameToDelete);

            if (userIndex === -1) {
                alert('User not found.');
                return;
            }

            if (users[userIndex].username === loggedInUser.username) {
                alert("You cannot delete your own account while logged in.");
                return;
            }
            
            if (users[userIndex].role === 'admin' && users.filter(u => u.role === 'admin').length === 1) {
                 alert('You cannot delete the last admin account.');
                 return;
            }

            users.splice(userIndex, 1);
            saveState();
            alert(`Account '${usernameToDelete}' has been deleted.`);
            deleteAccountModal.classList.add('hidden');
        });

        // --- Responsive Toggles ---
        navbarToggler.addEventListener('click', () => {
            navbarItems.classList.toggle('active');
        });
        filterToggler.addEventListener('click', () => {
            filterControls.classList.toggle('active');
        });


        // --- Inventory Rendering ---
        const getFilteredInventory = () => {
            const type = filterType.value;
            const brand = filterBrand.value.toLowerCase();
            const color = filterColor.value.toLowerCase();
            const minPrice = parseFloat(filterMinPrice.value) || 0;
            const maxPrice = parseFloat(filterMaxPrice.value) || Infinity;
            const code = filterCode.value.toLowerCase();

            return inventory
                .filter(item => !type || item.type === type)
                .filter(item => !brand || item.brand.toLowerCase().includes(brand))
                .filter(item => !color || (item.color && item.color.toLowerCase().includes(color)) || (item.options && item.options.some(o => o.color.toLowerCase().includes(color))))
                .filter(item => item.price >= minPrice && item.price <= maxPrice)
                .filter(item => !code || item.code.toLowerCase().includes(code))
                .sort((a, b) => a.brand.localeCompare(b.brand) || a.model.localeCompare(b.model)); // Sort
        };

        const renderInventory = () => {
            const filteredInventory = getFilteredInventory();
            inventoryList.innerHTML = ''; // Clear list

            if (filteredInventory.length === 0) {
                inventoryList.innerHTML = '<p class="text-gray-500 col-span-full text-center">No products found matching your criteria.</p>';
            }

            filteredInventory.forEach(item => {
                const isShoe = item.type === 'shoes';
                const stockOrSizes = isShoe ?
                    `Sizes: ${item.options.map(o => `${o.size} (${o.stock})`).join(', ') || 'N/A'}` :
                    `Stock: ${item.options[0].stock || 0}`;

                const totalStock = item.options.reduce((acc, opt) => acc + opt.stock, 0);
                const stockColor = totalStock === 0 ? 'text-red-600' : (totalStock < 5 ? 'text-yellow-600' : 'text-green-700');
                const stockText = totalStock === 0 ? 'Out of Stock' : `Total Stock: ${totalStock}`;

                const card = `
                    <div class="product-card bg-white rounded-xl shadow-lg overflow-hidden flex flex-col justify-between p-3 border border-gray-100">
                        <div>
                            <img class="product-card-img w-full h-32 object-cover mb-2 rounded-md" src="${item.image}" alt="${item.brand} ${item.model}" onerror="this.src='https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/e8513746-6820-4bba-9260-b0f38c8939ad.png';">
                            <h4 class="text-sm font-semibold text-gray-900">${item.brand}</h4>
                            <p class="text-xs text-gray-600 mb-1">${item.model} (${item.code})</p>
                            <p class="text-2xs text-gray-500 mb-2">${isShoe ? item.color : (item.options[0].color || item.color)}</p>
                            <p class="text-xs text-gray-500 mb-2 truncate" title="${stockOrSizes}">${stockOrSizes}</p>
                            <p class="text-sm font-bold text-indigo-700">$${item.price.toFixed(2)}</p>
                            <p class="text-2xs text-gray-400 line-through">Orig: $${item.originalPrice.toFixed(2)}</p>
                            <p class="text-2xs text-gray-400">Min: $${item.minPrice.toFixed(2)}</p>
                        </div>
                        <div class="mt-3 flex flex-col gap-1.5">
                            <button class="add-to-cart-btn w-full bg-indigo-50 hover:bg-indigo-100 text-indigo-700 rounded-md text-xs font-medium ${totalStock === 0 ? 'opacity-50 cursor-not-allowed' : ''}" data-id="${item.id}" ${totalStock === 0 ? 'disabled' : ''}>
                                ${totalStock === 0 ? 'Out of Stock' : 'Add to Cart'}
                            </button>
                            <button class="edit-item-btn w-full bg-gray-50 hover:bg-gray-100 text-gray-700 rounded-md text-xs font-medium" data-id="${item.id}">
                                Edit
                            </button>
                        </div>
                    </div>
                `;
                inventoryList.innerHTML += card;
            });

            // Update UI based on user role
            updateUserUI();
            
            // Re-attach event listeners for newly created buttons
            attachInventoryListeners();
            // Update filter dropdowns
            updateFilterDropdowns();
        };

        const updateFilterDropdowns = () => {
            const brands = [...new Set(inventory.map(item => item.brand))].sort();
            const colors = [...new Set(inventory.flatMap(item => 
                item.type === 'shoes' ? item.color : (item.options.map(o => o.color) || [item.color])
            ))].sort();
            
            const currentBrand = filterBrand.value;
            const currentColor = filterColor.value;

            filterBrand.innerHTML = '<option value="">All</option>';
            filterColor.innerHTML = '<option value="">All</option>';

            brands.forEach(brand => {
                filterBrand.innerHTML += `<option value="${brand.toLowerCase()}" ${currentBrand === brand.toLowerCase() ? 'selected' : ''}>${brand}</option>`;
            });
            colors.forEach(color => {
                filterColor.innerHTML += `<option value="${color.toLowerCase()}" ${currentColor === color.toLowerCase() ? 'selected' : ''}>${color}</option>`;
            });
        };

        // --- Inventory Event Listeners ---
        const attachInventoryListeners = () => {
            document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    openAddToCartModal(id);
                });
            });

            document.querySelectorAll('.edit-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const item = inventory.find(i => i.id === id);
                    if (item.type === 'shoes') {
                        openAddShoeModal(id);
                    } else {
                        openAddBagModal(id);
                    }
                });
            });
        };

        [filterType, filterBrand, filterColor, filterMinPrice, filterMaxPrice, filterCode].forEach(el => {
            el.addEventListener('input', renderInventory);
        });

        resetFiltersBtn.addEventListener('click', () => {
             filterType.value = '';
             filterBrand.value = '';
             filterColor.value = '';
             filterMinPrice.value = '';
             filterMaxPrice.value = '';
             filterCode.value = '';
             renderInventory();
        });

        clearStorageBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to reset all data? This cannot be undone.')) {
                localStorage.removeItem(DB_KEY_INVENTORY);
                localStorage.removeItem(DB_KEY_SALES);
                inventory = [];
                salesHistory = [];
                renderInventory();
                alert('All inventory and sales data has been cleared.');
            }
        });

        // --- Add/Edit Shoe Modal ---
        const openAddShoeModal = (id = null) => {
            editingItemId = id;
            addShoeForm.reset();
            resetImagePreview(shoeImageFile, shoeImageUrl, shoeImagePreview);

            const isEditing = id !== null;
            shoeImageFile.disabled = isEditing;
            shoeImageUrl.disabled = isEditing;
            shoeImageNote.textContent = isEditing ? 'Image cannot be changed during edit' : 'editable when adding only';
            
            shoeCode.disabled = isEditing; // Disable code editing

            if (isEditing) {
                const item = inventory.find(i => i.id === id);
                shoeBrand.value = item.brand;
                shoeModel.value = item.model;
                shoeColor.value = item.color;
                shoeOriginalPrice.value = item.originalPrice;
                shoeMinPrice.value = item.minPrice;
                shoePrice.value = item.price;
                shoeCode.value = item.code;
                
                // Convert options array back to comma-separated list
                const sizesArray = item.options.flatMap(o => 
                    Array(o.stock).fill(o.size)
                ); // e.g., ["38", "39", "39"]
                shoeSizes.value = sizesArray.join(', ');

                if (item.image) {
                    shoeImagePreview.src = item.image;
                    shoeImagePreview.classList.remove('hidden');
                }
            }
            
            addShoeModal.classList.remove('hidden');
        };

        const closeAddShoeModal = () => {
            addShoeModal.classList.add('hidden');
            editingItemId = null;
        };

        addShoeBtn.addEventListener('click', () => openAddShoeModal());
        closeShoeModalBtn.addEventListener('click', closeAddShoeModal);
        cancelShoeBtn.addEventListener('click', closeAddShoeModal);

        addShoeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const code = shoeCode.value;
            if (!editingItemId && inventory.some(i => i.code === code)) {
                alert('Error: Item code already exists.');
                return;
            }

            // Parse sizes from new format
            const allSizes = shoeSizes.value.split(',')
                .map(s => s.trim())
                .filter(Boolean); // e.g., ["38", "39", "39", "40"]
                
            let options;
            try {
                 if (allSizes.length === 0) {
                     throw new Error("Please enter at least one size.");
                 }

                // Count occurrences of each size
                const sizeCounts = allSizes.reduce((acc, size) => {
                    acc[size] = (acc[size] || 0) + 1;
                    return acc;
                }, {}); // e.g., {"38": 1, "39": 2, "40": 1}

                // Convert to the options array structure
                options = Object.keys(sizeCounts).map(size => {
                    return {
                        size: size,
                        stock: sizeCounts[size]
                    };
                }).sort((a, b) => a.size.localeCompare(b.size, undefined, {numeric: true})); // Sort numerically

            } catch (error) {
                alert(error.message);
                return; // Stop submission
            }

            const itemData = {
                brand: shoeBrand.value,
                model: shoeModel.value,
                color: shoeColor.value,
                originalPrice: parseFloat(shoeOriginalPrice.value),
                minPrice: parseFloat(shoeMinPrice.value) || 0,
                price: parseFloat(shoePrice.value),
                code: shoeCode.value,
                type: 'shoes',
                options: options,
            };

            // Handle image processing
            const fileInput = shoeImageFile.files[0];
            const urlInput = shoeImageUrl.value.trim();
            let imageSource = null;

            if (!editingItemId) { // Only process new images when adding
                 try {
                    if (fileInput) {
                        imageSource = fileInput;
                    } else if (urlInput) {
                        imageSource = urlInput;
                    }

                    if (imageSource) {
                        // Show loading indicator (e.g., disable save button)
                        addShoeForm.querySelector('button[type="submit"]').disabled = true;
                        addShoeForm.querySelector('button[type="submit"]').textContent = 'Saving...';
                        
                        itemData.image = await compressAndEncodeImage(imageSource);
                        
                    } else {
                         itemData.image = 'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/e8513746-6820-4bba-9260-b0f38c8939ad.png'; // Default
                    }
                 } catch (error) {
                    console.error('Image compression failed:', error);
                    alert(`Failed to process image: ${error.message}. Please try another image or URL.`);
                    // Re-enable button
                    addShoeForm.querySelector('button[type="submit"]').disabled = false;
                    addShoeForm.querySelector('button[type="submit"]').textContent = 'Save';
                    return; // Stop submission
                 }
            }


            if (editingItemId) {
                // Update existing item
                const index = inventory.findIndex(i => i.id === editingItemId);
                // Preserve original image
                itemData.image = inventory[index].image; 
                inventory[index] = { ...inventory[index], ...itemData };
            } else {
                // Add new item
                itemData.id = generateId('s');
                inventory.push(itemData);
            }

            saveState();
            renderInventory();
            closeAddShoeModal();
            
            // Reset button text
            addShoeForm.querySelector('button[type="submit"]').disabled = false;
            addShoeForm.querySelector('button[type="submit"]').textContent = 'Save';
        });

        // --- Add/Edit Bag Modal ---
        const openAddBagModal = (id = null) => {
            editingItemId = id;
            addBagForm.reset();
            resetImagePreview(bagImageFile, bagImageUrl, bagImagePreview);

            const isEditing = id !== null;
            bagImageFile.disabled = isEditing;
            bagImageUrl.disabled = isEditing;
            bagImageNote.textContent = isEditing ? 'Image cannot be changed during edit' : 'editable when adding only';
            
            bagCode.disabled = isEditing; // Disable code editing
            
            // For bags, we map the single stock/color to the "options" model
            if (isEditing) {
                const item = inventory.find(i => i.id === id);
                bagBrand.value = item.brand;
                bagModel.value = item.model;
                bagOriginalPrice.value = item.originalPrice;
                bagMinPrice.value = item.minPrice;
                bagPrice.value = item.price;
                bagCode.value = item.code;
                // Bag-specific fields
                bagColor.value = item.options[0]?.color || item.color || ''; // Handle old/new data
                bagStock.value = item.options[0]?.stock || 0;
                if (item.image) {
                    bagImagePreview.src = item.image;
                    bagImagePreview.classList.remove('hidden');
                }
            }
            
            addBagModal.classList.remove('hidden');
        };

        const closeAddBagModal = () => {
            addBagModal.classList.add('hidden');
            editingItemId = null;
        };

        addBagBtn.addEventListener('click', () => openAddBagModal());
        closeBagModalBtn.addEventListener('click', closeAddBagModal);
        cancelBagBtn.addEventListener('click', closeAddBagModal);

        addBagForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const code = bagCode.value;
            if (!editingItemId && inventory.some(i => i.code === code)) {
                alert('Error: Item code already exists.');
                return;
            }

            const itemData = {
                brand: bagBrand.value,
                model: bagModel.value,
                color: bagColor.value, // Store base color for filtering
                originalPrice: parseFloat(bagOriginalPrice.value),
                minPrice: parseFloat(bagMinPrice.value) || 0,
                price: parseFloat(bagPrice.value),
                code: bagCode.value,
                type: 'bags',
                options: [
                    {
                        color: bagColor.value,
                        stock: parseInt(bagStock.value, 10)
                    }
                ],
            };
            
            // Handle image processing
            const fileInput = bagImageFile.files[0];
            const urlInput = bagImageUrl.value.trim();
            let imageSource = null;

            if (!editingItemId) { // Only process new images when adding
                 try {
                    if (fileInput) {
                        imageSource = fileInput;
                    } else if (urlInput) {
                        imageSource = urlInput;
                    }

                    if (imageSource) {
                        // Show loading indicator
                        addBagForm.querySelector('button[type="submit"]').disabled = true;
                        addBagForm.querySelector('button[type="submit"]').textContent = 'Saving...';
                        
                        itemData.image = await compressAndEncodeImage(imageSource);

                    } else {
                         itemData.image = 'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/e8513746-6820-4bba-9260-b0f38c8939ad.png'; // Default
                    }
                 } catch (error) {
                    console.error('Image compression failed:', error);
                    alert(`Failed to process image: ${error.message}. Please try another image or URL.`);
                    // Re-enable button
                    addBagForm.querySelector('button[type="submit"]').disabled = false;
                    addBagForm.querySelector('button[type="submit"]').textContent = 'Save';
                    return; // Stop submission
                 }
            }


            if (editingItemId) {
                // Update existing item
                const index = inventory.findIndex(i => i.id === editingItemId);
                 // Preserve original image
                itemData.image = inventory[index].image;
                inventory[index] = { ...inventory[index], ...itemData };
            } else {
                // Add new item
                itemData.id = generateId('b');
                inventory.push(itemData);
            }

            saveState();
            renderInventory();
            closeAddBagModal();
            
            // Reset button text
            addBagForm.querySelector('button[type="submit"]').disabled = false;
            addBagForm.querySelector('button[type="submit"]').textContent = 'Save';
        });

        // --- Add to Cart Modal ---
        const openAddToCartModal = (id) => {
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            addToCartForm.dataset.itemId = id;
            addToCartTitle.textContent = `Add ${item.brand} ${item.model}`;
            cartQuantity.value = 1;
            sizeColorOptions.innerHTML = ''; // Clear previous options

            if (item.type === 'shoes') {
                // Shoes: Create radio buttons for available sizes
                sizeColorOptions.innerHTML = '<label class="block text-xs font-medium text-gray-700 mb-1">Select Size:</label>';
                const sizeList = document.createElement('div');
                sizeList.className = 'flex flex-wrap gap-2 max-h-32 overflow-y-auto'; // Scrollable
                
                let firstAvailable = true;
                item.options.forEach(opt => {
                    const hasStock = opt.stock > 0;
                    const label = document.createElement('label');
                    label.className = `cursor-pointer px-2.5 py-1.5 border rounded-md text-xs ${hasStock ? 'hover:bg-gray-100' : 'opacity-50 line-through'}`;
                    label.innerHTML = `
                        <input type="radio" name="size-option" value="${opt.size}" class="sr-only" ${hasStock ? '' : 'disabled'} ${firstAvailable && hasStock ? 'checked' : ''}>
                        <span>${opt.size} (Stock: ${opt.stock})</span>
                    `;
                    sizeList.appendChild(label);
                    
                    // Style checked state
                    label.querySelector('input').addEventListener('change', () => {
                         sizeList.querySelectorAll('label').forEach(l => l.classList.remove('bg-indigo-100', 'border-indigo-400'));
                         if(label.querySelector('input').checked) {
                             label.classList.add('bg-indigo-100', 'border-indigo-400');
                         }
                    });
                    
                    if(firstAvailable && hasStock) {
                        label.classList.add('bg-indigo-100', 'border-indigo-400');
                        firstAvailable = false;
                    }
                });
                sizeColorOptions.appendChild(sizeList);
            } else {
                // Bags: Just show stock
                const stock = item.options[0].stock;
                sizeColorOptions.innerHTML = `<p class="text-xs text-gray-600">Color: ${item.options[0].color} (Stock: ${stock})</p>`;
                cartQuantity.max = stock; // Set max quantity for bags
            }

            addToCartModal.classList.remove('hidden');
        };

        const closeAddToCartModal = () => {
            addToCartModal.classList.add('hidden');
        };

        closeCartModalBtn.addEventListener('click', closeAddToCartModal);
        cancelAddToCartBtn.addEventListener('click', closeAddToCartModal);

        addToCartForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = e.target.dataset.itemId;
            const item = inventory.find(i => i.id === id);
            const quantity = parseInt(cartQuantity.value, 10);
            let selectedOption = null; // For shoes
            let optionIdentifier = item.options[0].color; // For bags

            if (item.type === 'shoes') {
                const selectedSizeInput = document.querySelector('input[name="size-option"]:checked');
                if (!selectedSizeInput) {
                    alert('Please select a size.');
                    return;
                }
                const selectedSize = selectedSizeInput.value;
                selectedOption = item.options.find(o => o.size === selectedSize);
                optionIdentifier = selectedSize; // Use size to identify shoe option
                
                if (quantity > selectedOption.stock) {
                    alert(`Only ${selectedOption.stock} in stock for size ${selectedSize}.`);
                    return;
                }
            } else {
                // Bag
                if (quantity > item.options[0].stock) {
                    alert(`Only ${item.options[0].stock} in stock.`);
                    return;
                }
            }
            
            // Check if item (with specific option) is already in cart
            const cartIdentifier = `${item.id}-${optionIdentifier}`;
            const existingCartItem = cart.find(ci => ci.cartIdentifier === cartIdentifier);
            
            if (existingCartItem) {
                 // Check stock limit
                 const newQuantity = existingCartItem.quantity + quantity;
                 const stockLimit = item.type === 'shoes' ? selectedOption.stock : item.options[0].stock;
                 if (newQuantity > stockLimit) {
                     alert(`Cannot add ${quantity} more. Stock limit is ${stockLimit}. You already have ${existingCartItem.quantity} in cart.`);
                     return;
                 }
                 existingCartItem.quantity = newQuantity;
            } else {
                cart.push({
                    cartIdentifier: cartIdentifier, // Unique ID for item-option combo
                    id: item.id,
                    brand: item.brand,
                    model: item.model,
                    price: item.price,
                    originalPrice: item.originalPrice,
                    minPrice: item.minPrice,
                    image: item.image,
                    type: item.type,
                    quantity: quantity,
                    option: item.type === 'shoes' ? { size: selectedOption.size } : { color: item.options[0].color }
                });
            }

            updateCartCount();
            closeAddToCartModal();
        });


        // --- Cart View ---
        const updateCartCount = () => {
            cartCountEl.textContent = cart.reduce((acc, item) => acc + item.quantity, 0);
        };

        const renderCart = () => {
            cartItemsList.innerHTML = '';
            if (cart.length === 0) {
                cartItemsList.innerHTML = '<p class="text-gray-500 text-center">Your cart is empty.</p>';
                cartTotalEl.textContent = '0.00';
                checkoutDiscount.value = 0;
                return;
            }

            let total = 0;
            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                const optionText = item.type === 'shoes' ? `Size: ${item.option.size}` : `Color: ${item.option.color}`;

                const cartItemRow = `
                    <div class="cart-item-row bg-white rounded-lg shadow-sm p-3 flex items-center gap-3">
                        <img class="w-12 h-12 object-cover rounded-md" src="${item.image}" alt="${item.brand}" onerror="this.src='https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/e8513746-6820-4bba-9260-b0f38c8939ad.png';">
                        <div class="flex-grow">
                            <p class="text-sm font-semibold">${item.brand} ${item.model}</p>
                            <p class="text-xs text-gray-500">${optionText}</p>
                            <p class="text-xs text-gray-500">$${item.price.toFixed(2)} x ${item.quantity}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-gray-900">$${itemTotal.toFixed(2)}</p>
                            <button class="text-red-600 hover:text-red-800 text-xs mt-1" data-cart-id="${item.cartIdentifier}">Remove</button>
                        </div>
                    </div>
                `;
                cartItemsList.innerHTML += cartItemRow;
            });

            // Recalculate total with discount
            calculateCartTotal();

            // Add remove listeners
            document.querySelectorAll('.cart-item-row button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const cartId = e.target.dataset.cartId;
                    cart = cart.filter(item => item.cartIdentifier !== cartId);
                    updateCartCount();
                    renderCart(); // Re-render the cart view
                });
            });
        };

        const calculateCartTotal = () => {
             let subtotal = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
             let discountPercent = parseFloat(checkoutDiscount.value) || 0;
             if (discountPercent < 0) discountPercent = 0;
             if (discountPercent > 100) discountPercent = 100;
             
             const discountAmount = (subtotal * discountPercent) / 100;
             const finalTotal = subtotal - discountAmount;
             
             cartTotalEl.textContent = finalTotal.toFixed(2);
             
             // Check against minPrice
             let belowMinPrice = false;
             cart.forEach(cartItem => {
                 const itemMinPrice = cartItem.minPrice || 0;
                 const discountedPrice = cartItem.price * (1 - (discountPercent / 100));
                 if (discountedPrice < itemMinPrice) {
                     belowMinPrice = true;
                 }
             });
             
             if(belowMinPrice) {
                 cartTotalEl.classList.add('text-red-600');
                 cartTotalEl.title = 'Warning: Discount makes one or more items fall below minimum price.';
             } else {
                 cartTotalEl.classList.remove('text-red-600');
                 cartTotalEl.title = '';
             }
             
             return finalTotal;
        };

        checkoutDiscount.addEventListener('input', calculateCartTotal);

        checkoutBtn.addEventListener('click', () => {
            if (cart.length === 0) {
                alert('Your cart is empty.');
                return;
            }

            // Final check for minPrice
            const discountPercent = parseFloat(checkoutDiscount.value) || 0;
            let belowMinPriceItems = [];
             cart.forEach(cartItem => {
                 const itemMinPrice = cartItem.minPrice || 0;
                 const discountedPrice = cartItem.price * (1 - (discountPercent / 100));
                 
                 // Use a small tolerance for floating point issues
                 if (discountedPrice < (itemMinPrice - 0.001)) { 
                     belowMinPriceItems.push(`${cartItem.brand} ${cartItem.model} (Min: $${itemMinPrice.toFixed(2)}, Sale: $${discountedPrice.toFixed(2)})`);
                 }
             });
             
             if(belowMinPriceItems.length > 0) {
                 alert(`Cannot checkout: The current discount makes the following items fall below their minimum price:\n\n${belowMinPriceItems.join('\n')}`);
                 return;
             }

            const finalTotal = calculateCartTotal();
            const selectedPaymentMethod = paymentMethod.value;

            // 1. Update stock in inventory
            cart.forEach(cartItem => {
                const inventoryItem = inventory.find(i => i.id === cartItem.id);
                if (inventoryItem) {
                    let optionToUpdate;
                    if (inventoryItem.type === 'shoes') {
                        optionToUpdate = inventoryItem.options.find(o => o.size === cartItem.option.size);
                    } else {
                        optionToUpdate = inventoryItem.options[0]; // Bags only have one option
                    }

                    if (optionToUpdate) {
                        optionToUpdate.stock -= cartItem.quantity;
                        if (optionToUpdate.stock < 0) {
                            console.error(`Oversold item: ${inventoryItem.code}`);
                            optionToUpdate.stock = 0; // Correct stock
                        }
                    }
                }
            });

            // 2. Add to sales history
            const saleRecord = {
                id: generateId('sale'),
                date: new Date().toISOString(),
                items: cart.map(item => ({
                    ...item // Copy cart item details
                })),
                total: finalTotal,
                discountPercent: discountPercent,
                paymentMethod: selectedPaymentMethod
            };
            salesHistory.push(saleRecord);

            // 3. Save state
            saveState();

            // 4. Clear cart
            cart = [];
            updateCartCount();

            // 5. Show success and switch view
            alert(`Checkout successful! Total: $${finalTotal.toFixed(2)}`);
            renderInventory(); // Re-render inventory to show updated stock
            showView(inventoryView);
        });

        // --- View Switching ---
        viewCartBtn.addEventListener('click', () => {
            renderCart();
            showView(cartView);
        });

        salesHistoryBtn.addEventListener('click', () => {
            renderSalesHistory();
            showView(salesHistoryView);
        });

        backToInventoryBtn.addEventListener('click', () => showView(inventoryView));
        backToInventoryFromHistoryBtn.addEventListener('click', () => showView(inventoryView));


        // --- Sales History ---
        const renderSalesHistory = () => {
            salesHistoryTableBody.innerHTML = '';
            
            const filterDate = filterSalesDate.value;
            let dailyTotal = 0;
            let monthlyTotal = 0;
            const now = new Date();
            const currentMonth = now.toISOString().slice(0, 7); // "YYYY-MM"

            let totalSales = 0;
            let totalProfit = 0;

            const filteredSales = salesHistory
                .filter(sale => {
                    if (!filterDate) return true;
                    return sale.date.startsWith(filterDate);
                })
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // Newest first

            if (filteredSales.length === 0) {
                 salesHistoryTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-3 text-gray-500">No sales found for this date.</td></tr>';
            }

            filteredSales.forEach(sale => {
                const saleDate = new Date(sale.date);
                const itemsHtml = sale.items.map(item =>
                    `<div class="flex items-center">
                       <img src="${item.image}" class="sales-history-item-image" alt="" onerror="this.src='https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/e8513746-6820-4bba-9260-b0f38c8939ad.png';">
                       <span>${item.quantity} x ${item.brand} ${item.model} ${item.type === 'shoes' ? `(Size ${item.option.size})` : ''}</span>
                     </div>`
                ).join('');

                const row = `
                    <tr>
                        <td class="px-3 py-1.5 align-top">${saleDate.toLocaleString()}</td>
                        <td class="px-3 py-1.5 align-top">${itemsHtml}</td>
                        <td class="px-3 py-1.5 align-top">${sale.paymentMethod || 'N/A'}</td>
                        <td class="px-3 py-1.5 align-top text-right">$${sale.total.toFixed(2)} ${sale.discountPercent > 0 ? `(${sale.discountPercent}% off)` : ''}</td>
                    </tr>
                `;
                salesHistoryTableBody.innerHTML += row;

                // Calculate totals for the *filtered* date
                if (filterDate) {
                     dailyTotal += sale.total;
                }
            });
            
            // Calculate monthly and summary totals regardless of date filter
             salesHistory.forEach(sale => {
                 totalSales += sale.total;
                 sale.items.forEach(item => {
                     const profitPerItem = item.price - (item.originalPrice || item.price);
                     totalProfit += (profitPerItem * item.quantity);
                 });
                 
                 if (sale.date.startsWith(currentMonth)) {
                     monthlyTotal += sale.total;
                 }
             });

            salesSummaryEl.textContent = `Total Sales: $${totalSales.toFixed(2)} | Total Profit: $${totalProfit.toFixed(2)}`;
            monthlyTotalEl.textContent = filterDate ? `Total for ${currentMonth}: $${monthlyTotal.toFixed(2)}` : `This Month's Total: $${monthlyTotal.toFixed(2)}`;
            dailyTotalEl.textContent = filterDate ? `Total for ${filterDate}: $${dailyTotal.toFixed(2)}` : '';
            dailyTotalEl.classList.toggle('hidden', !filterDate);
        };
        
        filterSalesDate.addEventListener('input', renderSalesHistory);
        clearSalesDate.addEventListener('click', () => {
             filterSalesDate.value = '';
             renderSalesHistory();
        });


        // --- Initial Load ---
        checkLogin();
    });
</script>
</body>
</html>